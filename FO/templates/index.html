{% extends "modern-layout.html" %}

{% block title %}FirefighterAI - Plataforma de Entrenamiento Inteligente{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section" id="hero">
  <div class="hero-container">
    <!-- Floating particles background -->
    <div class="particles-background">
      {% for i in range(20) %}
      <div class="particle" style="
        left: {{ range(0, 100) | random }}%;
        animation-delay: {{ range(0, 300) | random / 100 }}s;
        animation-duration: {{ range(300, 600) | random / 100 }}s;
      "></div>
      {% endfor %}
    </div>

    <!-- 3D floating elements -->
    <div class="floating-elements">
      <div class="float-element fire-element">🔥</div>
      <div class="float-element helmet-element">⛑️</div>
      <div class="float-element truck-element">🚒</div>
      <div class="float-element extinguisher-element">🧯</div>
    </div>

    <div class="hero-content animate-on-scroll">
      <!-- Hero Badge -->
      <div class="hero-badge">
        <span class="badge-icon">🚀</span>
        <span class="badge-text">Plataforma de Entrenamiento con IA</span>
      </div>

      <!-- Main Title -->
      <h1 class="hero-title">
        Domina las <span class="text-gradient">Oposiciones </span><br>
        de <span class="text-gradient">Bombero</span>
        <span class="text-gradient">THIS IS INT ENV</span>
      </h1>

      <!-- Subtitle -->
      <p class="hero-subtitle">
        Entrena con inteligencia artificial avanzada, estudia con el sistema Leitner
        y practica con simulaciones realistas. Tu futuro como bombero comienza aquí.
      </p>

      <!-- Hero Stats -->
      <div class="hero-stats">
        <div class="stat-item">
          <div class="stat-number">5,000+</div>
          <div class="stat-label">Preguntas</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">98%</div>
          <div class="stat-label">Tasa de Éxito</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">24/7</div>
          <div class="stat-label">Disponible</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">1,200+</div>
          <div class="stat-label">Estudiantes</div>
        </div>
      </div>

      <!-- CTA Buttons -->
      <div class="cta-buttons">
        {% if session.user %}
        <a href="#practice-section" class="btn btn-primary btn-glow" data-smooth-scroll>
          <span class="btn-icon">🎯</span>
          <span class="btn-text">Continuar Entrenamiento</span>
        </a>
        <a href="/chat" class="btn btn-secondary">
          <span class="btn-icon">🤖</span>
          <span class="btn-text">Chat con IA</span>
        </a>
        {% else %}
        <a href="/register" class="btn btn-primary btn-glow">
          <span class="btn-icon">🚀</span>
          <span class="btn-text">Empezar Gratis</span>
        </a>
        <a href="/login" class="btn btn-secondary">
          <span class="btn-icon">🔑</span>
          <span class="btn-text">Iniciar Sesión</span>
        </a>
        {% endif %}
      </div>

      <!-- Scroll Indicator -->
      <div class="scroll-indicator">
        <div class="scroll-mouse">
          <div class="scroll-wheel"></div>
        </div>
        <span class="scroll-text">Descubre más</span>
      </div>
    </div>
  </div>
</section>

<!-- Features Section -->
<section class="features-section" id="features">
  <div class="container">
    <div class="section-header animate-on-scroll">
      <h2 class="section-title">¿Por qué elegir FirefighterAI?</h2>
      <p class="section-subtitle">
        La plataforma más avanzada para preparar tus oposiciones de bombero
      </p>
    </div>

    <div class="features-grid">
      <div class="feature-card animate-on-scroll" style="animation-delay: 0.1s">
        <div class="feature-icon animate-glow">🤖</div>
        <h3 class="feature-title">Inteligencia Artificial</h3>
        <p class="feature-description">
          Nuestro asistente IA personaliza tu aprendizaje, adaptándose a tu ritmo
          y identificando áreas de mejora en tiempo real.
        </p>
        <div class="feature-highlights">
          <span class="highlight">• Evaluación personalizada</span>
          <span class="highlight">• Feedback instantáneo</span>
          <span class="highlight">• Simulaciones realistas</span>
        </div>
      </div>

      <div class="feature-card animate-on-scroll" style="animation-delay: 0.2s">
        <div class="feature-icon animate-pulse">📚</div>
        <h3 class="feature-title">Sistema Leitner</h3>
        <p class="feature-description">
          Estudia de manera científicamente probada con nuestro sistema de
          repetición espaciada que optimiza tu memoria a largo plazo.
        </p>
        <div class="feature-highlights">
          <span class="highlight">• Retención mejorada</span>
          <span class="highlight">• Estudio eficiente</span>
          <span class="highlight">• Progreso medible</span>
        </div>
      </div>

      <div class="feature-card animate-on-scroll" style="animation-delay: 0.3s">
        <div class="feature-icon animate-glow">📊</div>
        <h3 class="feature-title">Análisis Avanzado</h3>
        <p class="feature-description">
          Seguimiento detallado de tu progreso con métricas precisas y
          recomendaciones personalizadas para maximizar tu rendimiento.
        </p>
        <div class="feature-highlights">
          <span class="highlight">• Estadísticas detalladas</span>
          <span class="highlight">• Predicción de resultados</span>
          <span class="highlight">• Planes de estudio</span>
        </div>
      </div>

      <div class="feature-card animate-on-scroll" style="animation-delay: 0.4s">
        <div class="feature-icon animate-pulse">🎯</div>
        <h3 class="feature-title">Práctica Dirigida</h3>
        <p class="feature-description">
          Exámenes simulados con condiciones reales, preguntas actualizadas
          y corrección automática con explicaciones detalladas.
        </p>
        <div class="feature-highlights">
          <span class="highlight">• Exámenes oficiales</span>
          <span class="highlight">• Temporizador real</span>
          <span class="highlight">• Explicaciones detalladas</span>
        </div>
      </div>

      <div class="feature-card animate-on-scroll" style="animation-delay: 0.5s">
        <div class="feature-icon animate-glow">🌐</div>
        <h3 class="feature-title">Acceso Multiplataforma</h3>
        <p class="feature-description">
          Estudia donde quieras y cuando quieras. Sincronización automática
          entre todos tus dispositivos y acceso offline.
        </p>
        <div class="feature-highlights">
          <span class="highlight">• Móvil y escritorio</span>
          <span class="highlight">• Sincronización automática</span>
          <span class="highlight">• Modo offline</span>
        </div>
      </div>

      <div class="feature-card animate-on-scroll" style="animation-delay: 0.6s">
        <div class="feature-icon animate-pulse">🎓</div>
        <h3 class="feature-title">Certificaciones</h3>
        <p class="feature-description">
          Acceso directo a cursos certificados y programas de formación
          profesional reconocidos por instituciones oficiales.
        </p>
        <div class="feature-highlights">
          <span class="highlight">• Cursos certificados</span>
          <span class="highlight">• Reconocimiento oficial</span>
          <span class="highlight">• Formación continua</span>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Practice Section -->
{% if session.user %}
<section class="practice-section" id="practice-section">
  <div class="container">
    <div class="section-header animate-on-scroll">
      <h2 class="section-title">Comienza tu Entrenamiento</h2>
      <p class="section-subtitle">
        Elige tu método de estudio preferido y comienza a mejorar hoy mismo
      </p>
    </div>

    <div class="practice-grid">
      <div class="practice-card animate-on-scroll">
        <div class="practice-icon">📝</div>
        <h3>Examen de Práctica</h3>
        <p>Realiza un examen completo con preguntas actualizadas y temporizador real.</p>
        <div class="practice-stats">
          <span class="stat">⏱️ 90 minutos</span>
          <span class="stat">📊 100 preguntas</span>
          <span class="stat">🎯 Evaluación completa</span>
        </div>
        <a href="#test-container" class="btn btn-primary" data-smooth-scroll>
          <span>Empezar Examen</span>
        </a>
      </div>

      <div class="practice-card animate-on-scroll">
        <div class="practice-icon">🧠</div>
        <h3>Sistema Leitner</h3>
        <p>Estudia con el método de repetición espaciada más efectivo.</p>
        <div class="practice-stats">
          <span class="stat">📚 Estudio dirigido</span>
          <span class="stat">🎯 Personalizado</span>
          <span class="stat">📈 Progreso medible</span>
        </div>
        <a href="/study" class="btn btn-secondary">
          <span>Ir a Estudio</span>
        </a>
      </div>

      <div class="practice-card animate-on-scroll">
        <div class="practice-icon">🤖</div>
        <h3>Chat con IA</h3>
        <p>Resuelve dudas específicas con nuestro asistente inteligente.</p>
        <div class="practice-stats">
          <span class="stat">💬 Respuestas inmediatas</span>
          <span class="stat">🔍 Explicaciones detalladas</span>
          <span class="stat">📖 Consulta el temario</span>
        </div>
        <a href="/chat" class="btn btn-accent">
          <span>Abrir Chat</span>
        </a>
      </div>
    </div>
  </div>
</section>
{% endif %}

<!-- Test Container -->
<section class="test-section" id="test-container">
  <div class="container">
    <div class="test-header animate-on-scroll">
      <h2 class="section-title">🧠 Examen de Práctica</h2>
      <p class="section-subtitle">
        Pon a prueba tus conocimientos con preguntas reales de oposiciones
      </p>
    </div>

    <div class="test-container-inner">
      <form id="test-form" class="test-form" data-enhance>
        <!-- Question Progress -->
        <div class="question-progress">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="progress-text">
            <span id="current-question">1</span> de <span id="total-questions">{{ questions|length }}</span>
          </div>
        </div>

        <!-- Questions Carousel -->
        <div id="questions-carousel" class="questions-carousel">
          {% for q in questions %}
          <div class="question-block animate-on-scroll" data-slide="{{ loop.index }}" data-question-id="{{ q.id }}">
            <div class="question-card">
              <div class="question-header">
                <span class="question-number">Pregunta {{ loop.index }}</span>
                <div class="question-difficulty">
                  <span
                    class="difficulty-badge difficulty-{% if loop.index % 3 == 0 %}hard{% elif loop.index % 2 == 0 %}medium{% else %}easy{% endif %}">
                    {% if loop.index % 3 == 0 %}Difícil{% elif loop.index % 2 == 0 %}Medio{% else %}Fácil{% endif %}
                  </span>
                </div>
              </div>

              <div class="question-content">
                <h3 class="question-text">{{ q.question }}</h3>

                <div class="options-container">
                  {% for option in q.options %}
                  <label class="option-label">
                    <input type="radio" name="q{{ q.id }}" value="{{ option }}" required class="option-input" />
                    <div class="option-content">
                      <span class="option-letter">{{ 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[loop.index0] }}</span>

                      <span class="option-text">{{ option }}</span>
                    </div>
                    <div class="option-indicator"></div>
                  </label>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Hidden fields for evaluation -->
            <input type="hidden" name="correct_{{ q.id }}" value="{{ q.correct }}">
            <input type="hidden" name="q{{ q.id }}_text" value="{{ q.question }}">
          </div>
          {% endfor %}
        </div>

        <!-- Navigation Controls -->
        <div class="test-navigation">
          <button type="button" id="prev-btn" class="nav-btn nav-btn-prev" disabled>
            <span class="btn-icon">←</span>
            <span class="btn-text">Anterior</span>
          </button>

          <div class="question-dots">
            {% for q in questions %}
            <button type="button" class="question-dot" data-question="{{ loop.index0 }}"
              title="Pregunta {{ loop.index }}">
              <span>{{ loop.index }}</span>
            </button>
            {% endfor %}
          </div>

          <button type="button" id="next-btn" class="nav-btn nav-btn-next">
            <span class="btn-text">Siguiente</span>
            <span class="btn-icon">→</span>
          </button>
        </div>

        <!-- Submit Section -->
        <div class="submit-section" id="submit-section" style="display: none;">
          <div class="submit-info">
            <h3>¿Listo para enviar?</h3>
            <p>Revisa tus respuestas antes de enviar el examen. Una vez enviado, no podrás modificar las respuestas.</p>
            <div class="answers-summary" id="answers-summary">
              <!-- JavaScript will populate this -->
            </div>
          </div>
          <button type="submit" class="btn btn-primary btn-submit">
            <span class="btn-icon">🧪</span>
            <span class="btn-text">Enviar Examen</span>
            <div class="btn-loading" style="display: none;">
              <div class="loading-spinner"></div>
              <span>Evaluando...</span>
            </div>
          </button>
        </div>
      </form>

      <!-- Results Container -->
      <div id="response-box" class="results-container" style="display: none;">
        <div class="results-header">
          <h3>📊 Resultados del Examen</h3>
          <div class="results-summary" id="results-summary">
            <!-- JavaScript will populate this -->
          </div>
        </div>
        <div class="results-content" id="results-content">
          <!-- Results will be populated here -->
        </div>
        <div class="results-actions">
          <button type="button" class="btn btn-secondary" onclick="location.reload()">
            <span class="btn-icon">🔄</span>
            <span class="btn-text">Repetir Examen</span>
          </button>
          <a href="/study" class="btn btn-primary">
            <span class="btn-icon">📚</span>
            <span class="btn-text">Ir a Estudio</span>
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- CTA Section -->
{% if not session.user %}
<section class="cta-section">
  <div class="container">
    <div class="cta-content animate-on-scroll">
      <div class="cta-icon">🚀</div>
      <h2 class="cta-title">¿Listo para empezar tu preparación?</h2>
      <p class="cta-subtitle">
        Únete a miles de estudiantes que ya están entrenando con FirefighterAI
      </p>
      <div class="cta-buttons">
        <a href="/register" class="btn btn-primary btn-large">
          <span class="btn-icon">✨</span>
          <span class="btn-text">Registrarse Gratis</span>
        </a>
        <a href="/login" class="btn btn-secondary btn-large">
          <span class="btn-icon">🔑</span>
          <span class="btn-text">Iniciar Sesión</span>
        </a>
      </div>

      <div class="cta-features">
        <div class="cta-feature">
          <span class="feature-icon">✅</span>
          <span class="feature-text">Sin tarjeta de crédito</span>
        </div>
        <div class="cta-feature">
          <span class="feature-icon">🔒</span>
          <span class="feature-text">100% Seguro</span>
        </div>
        <div class="cta-feature">
          <span class="feature-icon">⚡</span>
          <span class="feature-text">Acceso inmediato</span>
        </div>
      </div>
    </div>
  </div>
</section>
{% endif %}

<!-- Testimonials Section -->
<section class="testimonials-section">
  <div class="container">
    <div class="section-header animate-on-scroll">
      <h2 class="section-title">Lo que dicen nuestros estudiantes</h2>
      <p class="section-subtitle">
        Historias reales de éxito de quienes ya forman parte del cuerpo de bomberos
      </p>
    </div>

    <div class="testimonials-grid">
      <div class="testimonial-card animate-on-scroll">
        <div class="testimonial-content">
          <div class="testimonial-stars">⭐⭐⭐⭐⭐</div>
          <p class="testimonial-text">
            "FirefighterAI fue clave en mi preparación. El sistema de IA me ayudó a identificar
            mis puntos débiles y mejorar de manera eficiente. ¡Aprobé en el primer intento!"
          </p>
        </div>
        <div class="testimonial-author">
          <div class="author-avatar">MC</div>
          <div class="author-info">
            <h4 class="author-name">María Carmen R.</h4>
            <p class="author-title">Bombera - Madrid</p>
          </div>
        </div>
      </div>

      <div class="testimonial-card animate-on-scroll">
        <div class="testimonial-content">
          <div class="testimonial-stars">⭐⭐⭐⭐⭐</div>
          <p class="testimonial-text">
            "La plataforma es increíblemente completa. El chat con IA resolvió todas mis dudas
            al instante, y el sistema Leitner me ayudó a memorizar todo el temario eficientemente."
          </p>
        </div>
        <div class="testimonial-author">
          <div class="author-avatar">JS</div>
          <div class="author-info">
            <h4 class="author-name">José Santiago M.</h4>
            <p class="author-title">Bombero - Barcelona</p>
          </div>
        </div>
      </div>

      <div class="testimonial-card animate-on-scroll">
        <div class="testimonial-content">
          <div class="testimonial-stars">⭐⭐⭐⭐⭐</div>
          <p class="testimonial-text">
            "Después de varios intentos fallidos, FirefighterAI me dio la estructura y
            metodología que necesitaba. Los simulacros son idénticos al examen real."
          </p>
        </div>
        <div class="testimonial-author">
          <div class="author-avatar">AL</div>
          <div class="author-info">
            <h4 class="author-name">Ana López T.</h4>
            <p class="author-title">Bombera - Valencia</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  // Enhanced functionality for the index page
  document.addEventListener('DOMContentLoaded', function () {
    // Initialize enhanced test system
    if (document.getElementById('test-form')) {
      initializeEnhancedTestSystem();
    }

    // Smooth scrolling for anchor links
    initializeSmoothScrolling();

    // Animate stats numbers
    animateStatsNumbers();

    // Enhanced intersection observer for animations
    setupAdvancedAnimations();

    // Fallback para letras A/B/C/D si el filtro Jinja 'chr_from_ascii' no está definido
    backfillOptionLettersIfEmpty();
  });

  function initializeEnhancedTestSystem() {
    const form = document.getElementById('test-form');
    const questions = document.querySelectorAll('.question-block');
    const progressFill = document.getElementById('progress-fill');
    const currentQuestionSpan = document.getElementById('current-question');
    const questionDots = document.querySelectorAll('.question-dot');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitSection = document.getElementById('submit-section');

    let currentQuestion = 0;
    let userAnswers = {};

    // Show first question
    showQuestion(0);

    // Navigation handlers
    prevBtn.addEventListener('click', () => {
      if (currentQuestion > 0) {
        showQuestion(currentQuestion - 1);
      }
    });

    nextBtn.addEventListener('click', () => {
      if (currentQuestion < questions.length - 1) {
        showQuestion(currentQuestion + 1);
      }
    });

    // Question dot navigation
    questionDots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        showQuestion(index);
      });
    });

    // Track answer changes
    questions.forEach((question, qIndex) => {
      const inputs = question.querySelectorAll('input[type="radio"]');
      inputs.forEach((input, idx) => {
        input.addEventListener('change', () => {
          userAnswers[qIndex] = input.value;
          updateQuestionDot(qIndex, true);
          updateProgress();
        });
      });
    });

    function showQuestion(index) {
      questions.forEach((q, i) => {
        q.style.display = i === index ? 'block' : 'none';
      });

      currentQuestion = index;
      currentQuestionSpan.textContent = index + 1;

      // Update progress bar
      const progress = ((index + 1) / questions.length) * 100;
      progressFill.style.width = `${progress}%`;

      // Update navigation buttons
      prevBtn.disabled = index === 0;
      nextBtn.style.display = index === questions.length - 1 ? 'none' : 'block';
      submitSection.style.display = index === questions.length - 1 ? 'block' : 'none';

      // Update active dot
      questionDots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
      });

      // Scroll to top of question
      document.getElementById('test-container').scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }

    function updateQuestionDot(index, answered) {
      const dot = questionDots[index];
      dot.classList.toggle('answered', answered);
    }

    function updateProgress() {
      const answeredCount = Object.keys(userAnswers).length;
      const totalQuestions = questions.length;

      // Update summary
      const summaryEl = document.getElementById('answers-summary');
      if (summaryEl) {
        summaryEl.innerHTML = `
        <div class="summary-stats">
          <div class="summary-stat">
            <span class="stat-number">${answeredCount}</span>
            <span class="stat-label">Respondidas</span>
          </div>
          <div class="summary-stat">
            <span class="stat-number">${totalQuestions - answeredCount}</span>
            <span class="stat-label">Pendientes</span>
          </div>
        </div>
      `;
      }
    }

    // Enhanced form submission
    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      const submitBtn = form.querySelector('.btn-submit');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnLoading = submitBtn.querySelector('.btn-loading');

      // Show loading state
      btnText.style.display = 'none';
      btnLoading.style.display = 'flex';
      submitBtn.disabled = true;

      try {
        await processEnhancedAnswers(new FormData(form));
      } catch (error) {
        console.error('Error al procesar el examen:', error);
        window.firefighterApp?.showNotification('Error al procesar el examen. Inténtalo de nuevo.', 'error');
      } finally {
        // Reset button state
        btnText.style.display = 'block';
        btnLoading.style.display = 'none';
        submitBtn.disabled = false;
      }
    });
  }

  async function processEnhancedAnswers(formData) {
    const responseBox = document.getElementById('response-box');
    const resultsContent = document.getElementById('results-content');
    const resultsSummary = document.getElementById('results-summary');

    if (!responseBox || !resultsContent) return;

    let totalQuestions = 0;
    let correctAnswers = 0;
    let results = [];

    // Hide test form and show results container
    document.getElementById('test-form').style.display = 'none';
    responseBox.style.display = 'block';

    resultsContent.innerHTML = '<div class="loading-results">Evaluando respuestas...</div>';

    for (let [key, value] of formData.entries()) {
      if (key.startsWith('q') && !key.includes('_')) {
        const qid = key.replace('q', '');
        const correct = formData.get(`correct_${qid}`);
        const questionText = formData.get(`q${qid}_text`);

        totalQuestions++;
        const isCorrect = value === correct;
        if (isCorrect) correctAnswers++;

        try {
          const response = await fetch('/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_answer: value,
              correct_option: correct,
              question_text: questionText
            })
          });

          const data = await response.json();

          results.push({
            questionId: qid,
            questionText,
            userAnswer: value,
            correctAnswer: correct,
            isCorrect,
            explanation: data.response
          });

        } catch (error) {
          console.error('Error processing question:', qid, error);
          results.push({
            questionId: qid,
            questionText,
            userAnswer: value,
            correctAnswer: correct,
            isCorrect,
            explanation: 'Error al generar explicación'
          });
        }
      }
    }

    // Calculate score
    const score = Math.round((correctAnswers / totalQuestions) * 100);
    const passed = score >= 50; // Ajusta el corte si quieres

    // Update results summary
    resultsSummary.innerHTML = `
    <div class="score-circle ${passed ? 'passed' : 'failed'}">
      <span class="score-number">${score}%</span>
      <span class="score-label">${passed ? 'Aprobado' : 'Suspendido'}</span>
    </div>
    <div class="score-details">
      <div class="score-detail">
        <span class="detail-number">${correctAnswers}</span>
        <span class="detail-label">Correctas</span>
      </div>
      <div class="score-detail">
        <span class="detail-number">${totalQuestions - correctAnswers}</span>
        <span class="detail-label">Incorrectas</span>
      </div>
      <div class="score-detail">
        <span class="detail-number">${totalQuestions}</span>
        <span class="detail-label">Total</span>
      </div>
    </div>
  `;

    // Display results
    resultsContent.innerHTML = results.map(result => `
    <div class="result-card ${result.isCorrect ? 'correct' : 'incorrect'}">
      <div class="result-header">
        <span class="result-icon">${result.isCorrect ? '✅' : '❌'}</span>
        <strong>Pregunta ${result.questionId}</strong>
      </div>
      <div class="result-content">
        <p class="question-text">${result.questionText}</p>
        <div class="answer-comparison">
          <div class="user-answer">
            <span class="answer-label">Tu respuesta:</span>
            <span class="answer-value ${result.isCorrect ? 'correct' : 'incorrect'}">${result.userAnswer}</span>
          </div>
          ${!result.isCorrect ? `
            <div class="correct-answer">
              <span class="answer-label">Respuesta correcta:</span>
              <span class="answer-value correct">${result.correctAnswer}</span>
            </div>
          ` : ''}
        </div>
        <div class="explanation">
          <h4>Explicación:</h4>
          <p>${result.explanation}</p>
        </div>
      </div>
    </div>
  `).join('');

    // Scroll to results
    responseBox.scrollIntoView({ behavior: 'smooth' });

    // Track completion
    window.firefighterApp?.trackUserInteraction('exam_completed', 'study', `score_${score}`);
  }

  function initializeSmoothScrolling() {
    document.querySelectorAll('a[data-smooth-scroll]').forEach(link => {
      link.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });
  }

  function animateStatsNumbers() {
    const statsNumbers = document.querySelectorAll('.stat-number');

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const element = entry.target;
          const text = element.textContent;
          const number = parseInt(text.replace(/\D/g, ''));

          if (number) {
            animateNumber(element, 0, number, 2000, text);
          }

          observer.unobserve(element);
        }
      });
    });

    statsNumbers.forEach(stat => observer.observe(stat));
  }

  function animateNumber(element, start, end, duration, originalText) {
    const startTime = performance.now();
    const suffix = originalText.replace(/[\d,]/g, '');

    function update(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);

      const current = Math.floor(start + (end - start) * easeOutCubic(progress));
      element.textContent = current.toLocaleString() + suffix;

      if (progress < 1) {
        requestAnimationFrame(update);
      }
    }

    requestAnimationFrame(update);
  }

  function easeOutCubic(t) {
    return 1 - Math.pow(1 - t, 3);
  }

  function setupAdvancedAnimations() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('animate-in');
          observer.unobserve(entry.target);
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    });

    document.querySelectorAll('.animate-on-scroll').forEach(el => {
      observer.observe(el);
    });
  }

  // Fallback por si la plantilla no generó letras (A, B, C...) para las opciones
  function backfillOptionLettersIfEmpty() {
    document.querySelectorAll('.question-block').forEach(block => {
      const options = block.querySelectorAll('.option-label .option-letter');
      options.forEach((el, idx) => {
        if (!el.textContent || !el.textContent.trim()) {
          el.textContent = String.fromCharCode(65 + (idx % 26));
        }
      });
    });
  }
</script>

<!-- Additional CSS for enhanced styling -->
<style>
  /* ==== Fallback de variables si el layout base no las define ==== */
  :root {
    --bg: #0b0b0f;
    --bg-secondary: rgba(255, 255, 255, 0.03);
    --text-primary: #f5f7fa;
    --text-secondary: #c7c9d1;
    --text-muted: #9aa0a6;
    --primary-red: #dc2626;
    --accent: #ef4444;
    --radius-sm: 6px;
    --radius-lg: 14px;
    --radius-xl: 18px;
    --radius-full: 999px;
    --transition-base: .25s ease;
    --gradient-fire: linear-gradient(90deg, #dc2626, #f97316, #f59e0b);
    --gradient-card: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
  }

  /* ==== Utilidades base / tipografía ==== */
  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .section-title {
    font-size: clamp(1.6rem, 2.2vw, 2.2rem);
    color: var(--text-primary);
    margin-bottom: .5rem;
  }

  .section-subtitle {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
  }

  .btn {
    display: inline-flex;
    gap: .5rem;
    align-items: center;
    padding: .8rem 1.1rem;
    border-radius: var(--radius-lg);
    border: 1px solid transparent;
    font-weight: 600;
    cursor: pointer;
    transition: transform var(--transition-base), box-shadow var(--transition-base), background var(--transition-base);
  }

  .btn-large {
    padding: 1rem 1.25rem;
    font-size: 1.05rem;
  }

  .btn-primary {
    background: var(--gradient-fire);
    color: #fff;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 26px rgba(220, 38, 38, 0.35);
  }

  .btn-secondary {
    background: rgba(255, 255, 255, 0.06);
    color: var(--text-primary);
    border-color: rgba(255, 255, 255, 0.12);
  }

  .btn-secondary:hover {
    background: rgba(255, 255, 255, 0.12);
  }

  .btn-accent {
    background: #0ea5e9;
    color: #fff;
  }

  .btn-glow {
    box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4);
    animation: pulseGlow 2.4s infinite;
  }

  .btn-icon {
    font-size: 1.1rem;
  }

  .nav-btn {
    display: flex;
    align-items: center;
    gap: .5rem;
    padding: .7rem 1rem;
    border-radius: var(--radius-lg);
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.03);
    color: var(--text-primary);
  }

  .nav-btn[disabled] {
    opacity: .5;
    cursor: not-allowed;
  }

  /* ==== Hero / partículas ==== */
  .hero-section {
    position: relative;
    overflow: hidden;
    padding: 4rem 0 3rem;
    background: radial-gradient(1200px 600px at 20% -10%, rgba(239, 68, 68, 0.25), transparent), radial-gradient(1000px 500px at 90% 0%, rgba(245, 158, 11, 0.18), transparent);
  }

  .hero-container {
    position: relative;
    z-index: 1;
  }

  .particles-background {
    position: absolute;
    inset: 0;
    overflow: hidden;
    z-index: 0;
  }

  .particle {
    position: absolute;
    top: 100%;
    width: 6px;
    height: 6px;
    background: rgba(255, 255, 255, 0.25);
    border-radius: var(--radius-full);
    box-shadow: 0 0 12px rgba(255, 255, 255, 0.55);
    animation-name: floatUp;
    animation-timing-function: linear;
    animation-iteration-count: infinite;
  }

  @keyframes floatUp {
    0% {
      transform: translateY(0) scale(1);
      opacity: .0;
    }

    10% {
      opacity: .7;
    }

    100% {
      transform: translateY(-120vh) scale(0.6);
      opacity: 0;
    }
  }

  .floating-elements {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .float-element {
    position: absolute;
    font-size: clamp(28px, 5vw, 56px);
    opacity: .12;
    filter: drop-shadow(0 6px 24px rgba(0, 0, 0, .35));
    animation: floatWobble 8s ease-in-out infinite;
  }

  .fire-element {
    top: 12%;
    left: 6%;
    animation-delay: .2s;
  }

  .helmet-element {
    top: 24%;
    right: 12%;
    animation-delay: .9s;
  }

  .truck-element {
    bottom: 12%;
    left: 20%;
    animation-delay: 1.6s;
  }

  .extinguisher-element {
    bottom: 8%;
    right: 10%;
    animation-delay: .6s;
  }

  @keyframes floatWobble {

    0%,
    100% {
      transform: translateY(0) rotate(0deg);
    }

    50% {
      transform: translateY(-12px) rotate(2deg);
    }
  }

  .hero-content {
    text-align: center;
    position: relative;
    z-index: 1;
  }

  .hero-badge {
    display: inline-flex;
    gap: .5rem;
    align-items: center;
    padding: .4rem .7rem;
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: var(--radius-full);
    color: var(--text-secondary);
    margin-bottom: .9rem;
  }

  .hero-title {
    font-size: clamp(2rem, 6vw, 3.2rem);
    line-height: 1.1;
    color: var(--text-primary);
    margin-bottom: .8rem;
  }

  .hero-subtitle {
    color: var(--text-secondary);
    max-width: 720px;
    margin: 0 auto 1.2rem;
  }

  .text-gradient {
    background: var(--gradient-fire);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
  }

  /* Scroll indicator */
  .scroll-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: .35rem;
    margin-top: 1rem;
    color: var(--text-muted);
  }

  .scroll-mouse {
    width: 26px;
    height: 42px;
    border-radius: 24px;
    border: 2px solid rgba(255, 255, 255, .4);
    position: relative;
  }

  .scroll-wheel {
    width: 4px;
    height: 8px;
    background: #fff;
    border-radius: 4px;
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    animation: wheel 1.8s infinite;
  }

  @keyframes wheel {
    0% {
      opacity: 0;
      transform: translate(-50%, 0);
    }

    50% {
      opacity: 1;
    }

    100% {
      opacity: 0;
      transform: translate(-50%, 10px);
    }
  }

  /* Features grid */
  .features-grid {
    display: grid;
    grid-template-columns: repeat(1, minmax(0, 1fr));
    gap: 1rem;
  }

  @media (min-width: 720px) {
    .features-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  .feature-card {
    background: var(--gradient-card);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: var(--radius-xl);
    padding: 1.1rem;
    transition: transform var(--transition-base), border-color var(--transition-base);
  }

  .feature-card:hover {
    transform: translateY(-4px);
    border-color: rgba(255, 255, 255, 0.18);
  }

  .feature-icon {
    font-size: 1.6rem;
  }

  .animate-glow {
    text-shadow: 0 0 14px rgba(255, 255, 255, 0.45);
  }

  .animate-pulse {
    animation: gentlePulse 2s infinite;
  }

  @keyframes gentlePulse {

    0%,
    100% {
      transform: scale(1);
    }

    50% {
      transform: scale(1.06);
    }
  }

  /* Practice grid */
  .practice-grid {
    display: grid;
    grid-template-columns: repeat(1, minmax(0, 1fr));
    gap: 1rem;
  }

  @media (min-width: 900px) {
    .practice-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  .practice-card {
    background: var(--gradient-card);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: var(--radius-xl);
    padding: 1.2rem;
  }

  .practice-icon {
    font-size: 1.8rem;
    margin-bottom: .35rem;
  }

  /* ==== Test System Enhancements ==== */
  .question-progress {
    margin-bottom: 2rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px solid rgba(220, 38, 38, 0.2);
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(220, 38, 38, 0.2);
    border-radius: var(--radius-full);
    overflow: hidden;
    margin-bottom: 0.5rem;
  }

  .progress-fill {
    height: 100%;
    background: var(--gradient-fire);
    border-radius: var(--radius-full);
    transition: width 0.3s ease;
  }

  .progress-text {
    text-align: center;
    color: var(--text-secondary);
    font-weight: 500;
  }

  .question-card {
    background: var(--gradient-card);
    border: 1px solid rgba(220, 38, 38, 0.2);
    border-radius: var(--radius-xl);
    padding: 2rem;
    margin-bottom: 2rem;
  }

  .question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .question-number {
    color: var(--text-accent, #f59e0b);
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .difficulty-badge {
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .difficulty-easy {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.3);
  }

  .difficulty-medium {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
    border: 1px solid rgba(245, 158, 11, 0.3);
  }

  .difficulty-hard {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .question-text {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    line-height: 1.6;
  }

  .options-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .option-label {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.02);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    position: relative;
    overflow: hidden;
  }

  .option-label:hover {
    background: rgba(220, 38, 38, 0.05);
    border-color: rgba(220, 38, 38, 0.3);
    transform: translateY(-2px);
  }

  .option-label:has(.option-input:checked) {
    background: rgba(220, 38, 38, 0.1);
    border-color: var(--primary-red);
    box-shadow: 0 0 0 1px var(--primary-red);
  }

  .option-input {
    display: none;
  }

  .option-content {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
  }

  .option-letter {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: var(--gradient-fire);
    color: white;
    border-radius: var(--radius-full);
    font-weight: 600;
    font-size: 0.875rem;
  }

  .option-text {
    color: var(--text-primary);
    font-weight: 500;
  }

  .option-indicator {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-full);
    transition: all var(--transition-base);
  }

  .option-label:has(.option-input:checked) .option-indicator {
    background: var(--primary-red);
    border-color: var(--primary-red);
  }

  .option-label:has(.option-input:checked) .option-indicator::after {
    content: '✓';
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.75rem;
  }

  .question-dots {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: center;
    margin: 0 1rem;
  }

  .question-dot {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-full);
    border: 2px solid rgba(255, 255, 255, 0.2);
    background: transparent;
    color: var(--text-secondary);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-base);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .question-dot:hover {
    border-color: var(--primary-red);
    color: var(--primary-red);
    transform: scale(1.1);
  }

  .question-dot.active {
    background: var(--primary-red);
    border-color: var(--primary-red);
    color: #fff;
  }

  .question-dot.answered {
    background: rgba(34, 197, 94, 0.2);
    border-color: #22c55e;
    color: #22c55e;
  }

  .question-dot.answered.active {
    background: #22c55e;
    color: #fff;
  }

  /* ==== Results Styling ==== */
  .results-container {
    background: var(--gradient-card);
    border: 1px solid rgba(220, 38, 38, 0.2);
    border-radius: var(--radius-xl);
    padding: 2rem;
    margin-top: 2rem;
  }

  .results-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }

  .results-summary {
    display: flex;
    gap: 1.2rem;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
  }

  .score-circle {
    width: 120px;
    height: 120px;
    border-radius: var(--radius-full);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 6px solid currentColor;
    color: #ef4444;
    /* default failed */
  }

  .score-circle.passed {
    color: #22c55e;
  }

  .score-number {
    font-size: 1.6rem;
    font-weight: 800;
    line-height: 1;
  }

  .score-label {
    font-weight: 700;
    font-size: .9rem;
    opacity: .85;
  }

  .score-details {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .score-detail {
    text-align: center;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.08);
    padding: .6rem .8rem;
    border-radius: var(--radius-lg);
  }

  .detail-number {
    display: block;
    font-weight: 800;
    color: var(--text-primary);
  }

  .detail-label {
    color: var(--text-secondary);
    font-size: .85rem;
  }

  .results-content {
    display: grid;
    gap: 1rem;
    margin-top: 1rem;
  }

  .result-card {
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: var(--radius-lg);
    padding: 1rem;
    background: rgba(255, 255, 255, 0.03);
  }

  .result-card.correct {
    border-color: rgba(34, 197, 94, 0.35);
  }

  .result-card.incorrect {
    border-color: rgba(239, 68, 68, 0.35);
  }

  .result-header {
    display: flex;
    align-items: center;
    gap: .5rem;
    margin-bottom: .4rem;
  }

  .answer-comparison {
    display: grid;
    gap: .6rem;
    grid-template-columns: 1fr;
  }

  @media (min-width: 720px) {
    .answer-comparison {
      grid-template-columns: 1fr 1fr;
    }
  }

  .answer-label {
    display: block;
    color: var(--text-secondary);
    font-size: .85rem;
  }

  .answer-value {
    display: inline-block;
    margin-top: .15rem;
    padding: .25rem .5rem;
    border-radius: var(--radius-sm);
    border: 1px solid rgba(255, 255, 255, 0.12);
  }

  .answer-value.correct {
    background: rgba(34, 197, 94, 0.15);
    border-color: #22c55e;
    color: #22c55e;
  }

  .answer-value.incorrect {
    background: rgba(239, 68, 68, 0.12);
    border-color: #ef4444;
    color: #ef4444;
  }

  .explanation h4 {
    margin: .6rem 0 .25rem;
  }

  .loading-results {
    text-align: center;
    color: var(--text-secondary);
  }

  /* ==== CTA / Testimonials ==== */
  .cta-section {
    padding: 2.2rem 0;
  }

  .cta-content {
    background: var(--gradient-card);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: var(--radius-xl);
    padding: 1.5rem;
    text-align: center;
  }

  .cta-icon {
    font-size: 2rem;
  }

  .cta-title {
    color: var(--text-primary);
    margin: .5rem 0;
  }

  .cta-subtitle {
    color: var(--text-secondary);
    margin-bottom: 1rem;
  }

  .cta-features {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: .8rem;
  }

  .cta-feature {
    display: flex;
    align-items: center;
    gap: .5rem;
    color: var(--text-secondary);
  }

  .testimonials-grid {
    display: grid;
    grid-template-columns: repeat(1, minmax(0, 1fr));
    gap: 1rem;
  }

  @media (min-width: 900px) {
    .testimonials-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  .testimonial-card {
    background: var(--gradient-card);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: var(--radius-xl);
    padding: 1.1rem;
  }

  .author-avatar {
    width: 38px;
    height: 38px;
    border-radius: var(--radius-full);
    background: rgba(255, 255, 255, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
  }

  .author-info h4 {
    margin: 0;
  }

  /* ==== Animaciones de entrada ==== */
  .animate-on-scroll {
    opacity: 0;
    transform: translateY(12px);
  }

  .animate-in {
    opacity: 1 !important;
    transform: translateY(0) !important;
    transition: opacity .6s ease, transform .6s ease;
  }

  /* ==== Botón de carga ==== */
  .btn-loading {
    display: flex;
    align-items: center;
    gap: .5rem;
  }

  .loading-spinner {
    width: 18px;
    height: 18px;
    border-radius: var(--radius-full);
    border: 3px solid rgba(255, 255, 255, 0.35);
    border-top-color: #fff;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* ==== Pulso del botón ==== */
  @keyframes pulseGlow {
    0% {
      box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.42);
    }

    70% {
      box-shadow: 0 0 0 22px rgba(220, 38, 38, 0);
    }

    100% {
      box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
    }
  }
</style>
{% endblock %}