{% extends "layout.html" %}

{% block title %}Estudio | FirefighterAI{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/study.css') }}">
{% endblock %}

{% block content %}
<section class="study-page">
  <div class="study-head">
    <div class="title-wrap">
      <h1 class="title">ğŸ§  Sistema Leitner</h1>
      <p class="subtitle">Entrena con repeticiÃ³n espaciada. Prioriza tarjetas que tocan "hoy".</p>
    </div>

    <div class="toolbar">
      <div class="pill due-pill" title="Tarjetas vencidas para hoy">
        <span class="pill-icon">â³</span>
        <span>Vencidas hoy</span>
        <strong id="dueTotal">{{ due_total or 0 }}</strong>
      </div>

      <button id="btnNext" class="btn btn-primary">
        <span class="btn-text">Siguiente tarjeta</span>
        <span class="btn-spinner" hidden>ğŸŒ€</span>
      </button>
    </div>
  </div>

  <div class="study-grid">
    <!-- Resumen por cajas -->
    <aside class="panel">
      <h2 class="panel-title">Resumen por cajas</h2>

      <div class="boxes-grid">
        {% for b in range(1, max_box + 1) %}
        <div class="box-tile" data-box="{{ b }}">
          <div class="box-top">
            <span class="box-chip">Caja {{ b }}</span>
            {% set iv = intervals.get(b, {}) %}
            <small class="interval muted">
              {% if iv.days == 0 %}Hoy
              {% elif iv.days == 1 %}1 dÃ­a
              {% else %}{{ iv.days }} dÃ­as
              {% endif %}
            </small>
          </div>

          <div class="box-metrics">
            <div class="metric">
              <span class="label">Vencidas</span>
              <strong class="value" id="due-{{ b }}">{{ box_counts.get(b, {}).get('due', 0) }}</strong>
            </div>
            <div class="metric">
              <span class="label">Total</span>
              <strong class="value" id="total-{{ b }}">{{ box_counts.get(b, {}).get('total', 0) }}</strong>
            </div>
          </div>

          <div class="box-bar">
            {% set total = box_counts.get(b, {}).get('total', 0) %}
            {% set due = box_counts.get(b, {}).get('due', 0) %}
            {% set pct = (due * 100 // total) if total > 0 else 0 %}
            <div class="bar">
              <div class="fill" style="width: {{ pct }}%"></div>
            </div>
            <small class="muted">{{ pct }}% vencidas</small>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="hints">
        <h3 class="hints-title">Atajos de teclado</h3>
        <ul class="hints-list">
          <li><kbd>Espacio</kbd> Mostrar/ocultar respuesta</li>
          <li><kbd>X</kbd> FallÃ©</li>
          <li><kbd>C</kbd> Correcto</li>
          <li><kbd>N</kbd> Siguiente tarjeta</li>
        </ul>
      </div>
    </aside>

    <!-- Tarjeta actual -->
    <main class="panel main-panel">
      <div class="card-view" id="cardView">
        <header class="card-head">
          <div class="badge">Tarjeta de Estudio</div>
          <div class="statline">
            <span class="muted">Caja actual:</span>
            <strong id="stateBox">â€”</strong>
            <span class="dot"></span>
            <span class="muted">PrÃ³xima revisiÃ³n:</span>
            <strong id="stateNext">â€”</strong>
          </div>
        </header>

        <div class="qa">
          <div class="question" id="question">Pulsa "Siguiente tarjeta" para empezar.</div>

          <div class="answer-wrap">
            <button id="btnToggle" class="btn btn-ghost reveal-btn">
              <span class="eye">ğŸ‘ï¸</span> Mostrar respuesta
            </button>
            <div id="answer" class="answer is-hidden"></div>
          </div>
        </div>

        <footer class="actions">
          <button id="btnWrong" class="btn btn-danger" disabled>
            âŒ FallÃ©
          </button>
          <button id="btnRight" class="btn btn-success" disabled>
            âœ… Correcto
          </button>
        </footer>

        <div class="empty" id="emptyState" hidden>
          <div class="empty-emoji">ğŸ‰</div>
          <h3>Â¡No hay tarjetas pendientes!</h3>
          <p class="muted">EstÃ¡s al dÃ­a con tus repasos. Â¡Buen trabajo!</p>
          <button id="btnTryNew" class="btn btn-primary">Buscar mÃ¡s tarjetas</button>
        </div>
      </div>
    </main>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/study.js') }}"></script>
{% endblock %}