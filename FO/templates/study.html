{% extends "layout.html" %}

{% block title %}Estudio | FirefighterAI{% endblock %}

{% block content %}
<section class="study-page">
  <div class="study-head">
    <div class="title-wrap">
      <h1 class="title">üß† Sistema Leitner</h1>
      <p class="subtitle">Entrena con repetici√≥n espaciada. Prioriza tarjetas que tocan "hoy".</p>
    </div>

    <div class="toolbar">
      <div class="pill due-pill" title="Tarjetas vencidas para hoy">
        <span class="pill-icon">‚è≥</span>
        <span>Vencidas hoy</span>
        <strong id="dueTotal">{{ due_total or 0 }}</strong>
      </div>

      <button id="btnNext" class="btn btn-primary">
        <span class="btn-text">Siguiente tarjeta</span>
        <span class="btn-spinner" hidden>üåÄ</span>
      </button>
    </div>
  </div>

  <div class="study-grid">
    <!-- Resumen por cajas -->
    <aside class="panel">
      <h2 class="panel-title">Resumen por cajas</h2>

      <div class="boxes-grid">
        {% for b in range(1, max_box + 1) %}
        <div class="box-tile" data-box="{{ b }}">
          <div class="box-top">
            <span class="box-chip">Caja {{ b }}</span>
            {% set iv = intervals.get(b, {}) %}
            <small class="interval muted">
              {% if iv.days == 0 %}Hoy
              {% elif iv.days == 1 %}1 d√≠a
              {% else %}{{ iv.days }} d√≠as
              {% endif %}
            </small>
          </div>

          <div class="box-metrics">
            <div class="metric">
              <span class="label">Vencidas</span>
              <strong class="value" id="due-{{ b }}">{{ box_counts.get(b, {}).get('due', 0) }}</strong>
            </div>
            <div class="metric">
              <span class="label">Total</span>
              <strong class="value" id="total-{{ b }}">{{ box_counts.get(b, {}).get('total', 0) }}</strong>
            </div>
          </div>

          <div class="box-bar">
            {% set total = box_counts.get(b, {}).get('total', 0) %}
            {% set due = box_counts.get(b, {}).get('due', 0) %}
            {% set pct = (due * 100 // total) if total > 0 else 0 %}
            <div class="bar">
              <div class="fill" style="width: {{ pct }}%"></div>
            </div>
            <small class="muted">{{ pct }}% vencidas</small>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="hints">
        <h3 class="hints-title">Atajos de teclado</h3>
        <ul class="hints-list">
          <li><kbd>Espacio</kbd> Mostrar/ocultar respuesta</li>
          <li><kbd>X</kbd> Fall√©</li>
          <li><kbd>C</kbd> Correcto</li>
          <li><kbd>N</kbd> Siguiente tarjeta</li>
        </ul>
      </div>
    </aside>

    <!-- Tarjeta actual -->
    <main class="panel main-panel">
      <div class="card-view" id="cardView">
        <header class="card-head">
          <div class="badge">Tarjeta de Estudio</div>
          <div class="statline">
            <span class="muted">Caja actual:</span>
            <strong id="stateBox">‚Äî</strong>
            <span class="dot"></span>
            <span class="muted">Pr√≥xima revisi√≥n:</span>
            <strong id="stateNext">‚Äî</strong>
          </div>
        </header>

        <div class="qa">
          <div class="question" id="question">Pulsa "Siguiente tarjeta" para empezar.</div>

          <div class="answer-wrap">
            <button id="btnToggle" class="btn btn-ghost reveal-btn">
              <span class="eye">üëÅÔ∏è</span> Mostrar respuesta
            </button>
            <div id="answer" class="answer is-hidden"></div>
          </div>
        </div>

        <footer class="actions">
          <button id="btnWrong" class="btn btn-danger" disabled>
            ‚ùå Fall√©
          </button>
          <button id="btnRight" class="btn btn-success" disabled>
            ‚úÖ Correcto
          </button>
        </footer>

        <div class="empty" id="emptyState" hidden>
          <div class="empty-emoji">üéâ</div>
          <h3>¬°No hay tarjetas pendientes!</h3>
          <p class="muted">Est√°s al d√≠a con tus repasos. ¬°Buen trabajo!</p>
          <button id="btnTryNew" class="btn btn-primary">Buscar m√°s tarjetas</button>
        </div>
      </div>
    </main>
  </div>
</section>
{% endblock %}

{% block scripts %}
<style>
/* ===== Layout ===== */
.study-page {
  padding: 2rem 1rem;
  min-height: 100vh;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
}

.study-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  margin: 0 auto 2rem;
  max-width: 1200px;
}

.title-wrap .title {
  margin: 0;
  font-size: 2rem;
  background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.subtitle {
  color: #94a3b8;
  margin: 0.5rem 0 0;
}

.toolbar {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.pill {
  display: inline-flex;
  gap: 0.5rem;
  align-items: center;
  padding: 0.75rem 1rem;
  border-radius: 999px;
  border: 2px solid rgba(245, 158, 11, 0.3);
  background: rgba(245, 158, 11, 0.1);
  backdrop-filter: blur(10px);
}

.pill-icon {
  font-size: 1.2rem;
}

/* ===== Grid ===== */
.study-grid {
  max-width: 1200px;
  margin: 0 auto;
  display: grid;
  gap: 2rem;
  grid-template-columns: 1fr;
}

@media (min-width: 1024px) {
  .study-grid {
    grid-template-columns: 1fr 1.5fr;
  }
}

/* ===== Panels ===== */
.panel {
  background: rgba(30, 41, 59, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 1rem;
  padding: 1.5rem;
  backdrop-filter: blur(10px);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.main-panel {
  background: rgba(30, 41, 59, 0.9);
  border: 1px solid rgba(245, 158, 11, 0.2);
}

/* ===== Boxes grid ===== */
.boxes-grid {
  display: grid;
  gap: 1rem;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
}

.box-tile {
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 0.75rem;
  padding: 1rem;
  background: rgba(15, 23, 42, 0.6);
  transition: all 0.3s ease;
}

.box-tile:hover {
  border-color: rgba(245, 158, 11, 0.3);
  transform: translateY(-2px);
}

.box-chip {
  font-weight: 700;
  font-size: 0.9rem;
  padding: 0.3rem 0.7rem;
  border-radius: 999px;
  background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
  color: white;
}

/* ===== Card view ===== */
.card-view {
  min-height: 400px;
  display: flex;
  flex-direction: column;
}

.qa {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 2rem 0;
}

.question {
  font-size: 1.5rem;
  font-weight: 600;
  line-height: 1.6;
  text-align: center;
  margin-bottom: 2rem;
  color: #f8fafc;
}

.answer {
  font-size: 1.2rem;
  line-height: 1.6;
  padding: 1.5rem;
  background: rgba(15, 23, 42, 0.6);
  border-radius: 0.75rem;
  border-left: 4px solid #10b981;
  margin-top: 1rem;
}

/* ===== Botones ===== */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border-radius: 0.75rem;
  border: 2px solid transparent;
  font-weight: 600;
  transition: all 0.3s ease;
  cursor: pointer;
}

.btn-primary {
  background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
  color: white;
  border-color: rgba(245, 158, 11, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
}

.btn-success {
  background: rgba(16, 185, 129, 0.2);
  border-color: rgba(16, 185, 129, 0.4);
  color: #10b981;
}

.btn-danger {
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.4);
  color: #ef4444;
}

/* ===== Estados vac√≠os ===== */
.empty {
  text-align: center;
  padding: 3rem 2rem;
}

.empty-emoji {
  font-size: 4rem;
  margin-bottom: 1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const elements = {
    question: document.getElementById('question'),
    answer: document.getElementById('answer'),
    stateBox: document.getElementById('stateBox'),
    stateNext: document.getElementById('stateNext'),
    btnToggle: document.getElementById('btnToggle'),
    btnNext: document.getElementById('btnNext'),
    btnRight: document.getElementById('btnRight'),
    btnWrong: document.getElementById('btnWrong'),
    btnTryNew: document.getElementById('btnTryNew'),
    emptyState: document.getElementById('emptyState'),
    dueTotal: document.getElementById('dueTotal')
  };

  let currentCard = null;

  // Funciones de utilidad
  function formatDate(dateString) {
    if (!dateString) return '‚Äî';
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: '2-digit'
      });
    } catch {
      return '‚Äî';
    }
  }

  function setLoading(loading) {
    elements.btnNext.disabled = loading;
    const spinner = elements.btnNext.querySelector('.btn-spinner');
    const text = elements.btnNext.querySelector('.btn-text');
    if (spinner && text) {
      spinner.hidden = !loading;
      text.hidden = loading;
    }
  }

  function hideAnswer() {
    elements.answer.classList.add('is-hidden');
    elements.btnToggle.innerHTML = '<span class="eye">üëÅÔ∏è</span> Mostrar respuesta';
  }

  function showAnswer() {
    elements.answer.classList.remove('is-hidden');
    elements.btnToggle.innerHTML = '<span class="eye">üôà</span> Ocultar respuesta';
  }

  function enableAnswerButtons(enable) {
    elements.btnRight.disabled = !enable;
    elements.btnWrong.disabled = !enable;
  }

  // Funciones de API
  async function fetchJSON(url, options = {}) {
    try {
      const response = await fetch(url, {
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      });
      
      if (response.status === 401) {
        window.location.href = '/login';
        return null;
      }
      
      return await response.json();
    } catch (error) {
      console.error('Fetch error:', error);
      return null;
    }
  }

  async function loadNextCard() {
    setLoading(true);
    hideAnswer();
    elements.emptyState.hidden = true;
    enableAnswerButtons(false);
    
    const response = await fetchJSON('/api/leitner/next');
    
    setLoading(false);
    
    if (!response || !response.ok) {
      showEmptyState();
      return;
    }
    
    if (!response.card) {
      showEmptyState();
      return;
    }
    
    currentCard = response.card;
    elements.question.textContent = currentCard.question;
    elements.answer.textContent = currentCard.answer;
    elements.stateBox.textContent = `Caja ${currentCard.box}`;
    elements.stateNext.textContent = formatDate(response.state?.next_review_at);
    
    hideAnswer();
    enableAnswerButtons(true);
    elements.emptyState.hidden = true;
  }

  function showEmptyState() {
    elements.question.textContent = 'No hay tarjetas pendientes';
    elements.answer.textContent = '';
    elements.stateBox.textContent = '‚Äî';
    elements.stateNext.textContent = '‚Äî';
    enableAnswerButtons(false);
    elements.emptyState.hidden = false;
  }

  async function submitAnswer(isCorrect) {
    if (!currentCard) return;
    
    enableAnswerButtons(false);
    
    const response = await fetchJSON('/api/leitner/answer', {
      method: 'POST',
      body: JSON.stringify({
        card_id: currentCard.id,
        correct: isCorrect
      })
    });
    
    if (response && response.ok) {
      await loadNextCard();
    } else {
      enableAnswerButtons(true);
    }
  }

  // Event listeners
  elements.btnToggle.addEventListener('click', function() {
    if (elements.answer.classList.contains('is-hidden')) {
      showAnswer();
    } else {
      hideAnswer();
    }
  });

  elements.btnNext.addEventListener('click', loadNextCard);
  elements.btnTryNew.addEventListener('click', loadNextCard);
  elements.btnRight.addEventListener('click', () => submitAnswer(true));
  elements.btnWrong.addEventListener('click', () => submitAnswer(false));

  // Atajos de teclado
  document.addEventListener('keydown', function(event) {
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
      return;
    }
    
    switch (event.key.toLowerCase()) {
      case ' ':
        event.preventDefault();
        elements.btnToggle.click();
        break;
      case 'x':
        elements.btnWrong.click();
        break;
      case 'c':
        elements.btnRight.click();
        break;
      case 'n':
        elements.btnNext.click();
        break;
    }
  });

  // Cargar primera tarjeta
  loadNextCard();
});
</script>
{% endblock %}