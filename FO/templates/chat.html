{% extends "layout.html" %}
{% block title %}Chat de Estudio | FirefighterAI{% endblock %}

{% block content %}
<section class="chat-page">
  <header class="chat-header">
    <div class="lh">
      <h1>💬 Chat de Estudio</h1>
      <p class="muted">Respuestas basadas en tus tarjetas del sistema Leitner.</p>
    </div>
    <div class="rh">
      <label class="deck-select">
        <span>Baraja</span>
        <select id="deckSelect">
          <option value="">Todas</option>
        </select>
      </label>

      <label class="strict-switch" title="Si está activo, el bot se limita al contexto encontrado">
        <input id="strictMode" type="checkbox" />
        <span class="slider"></span>
        <span class="label">Solo contexto</span>
      </label>

      <button id="btnNew" class="btn ghost" title="Nuevo chat">🧹 Nuevo</button>
    </div>
  </header>

  <main id="chatBox" class="chat-box" aria-live="polite">
    {% for item in history %}
    <div class="msg user">
      <div class="avatar">👤</div>
      <div class="bubble">
        <div class="text">{{ item.user }}</div>
        <div class="meta">{{ item.time }}</div>
      </div>
    </div>
    <div class="msg bot">
      <div class="avatar">🤖</div>
      <div class="bubble">
        <div class="text">{{ item.bot }}</div>
        {% if item.sources %}
        <details class="sources">
          <summary>Tarjetas consultadas</summary>
          <ul>
            {% for s in item.sources %}
            <li>
              <strong>{{ s.front }}</strong><br>
              <small class="muted">{{ s.back }}</small>
              {% if s.deck %}<small class="tag">#{{ s.deck }}</small>{% endif %}
              {% if s.box %}<small class="tag">Caja {{ s.box }}</small>{% endif %}
            </li>
            {% endfor %}
          </ul>
        </details>
        {% endif %}
        <div class="meta">{{ item.time }}</div>
      </div>
    </div>
    {% endfor %}
  </main>

  <footer class="composer">
    <form id="chatForm" autocomplete="off">
      <div class="field">
        <textarea id="userInput" rows="1" placeholder="Pregunta algo del temario..."
          required></textarea style ="height: 42px; overflow-y: hidden;" oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 220) + 'px'" ></textarea>
        <div id="typing" class="typing" hidden>
          <span></span><span></span><span></span>
          <em>Pensando…</em>
        </div>
      </div>
      <button id="sendBtn" class="btn primary" type="submit">Enviar</button>
    </form>
  </footer>
</section>
{% endblock %}

{% block scripts %}
<style>
  .chat-page {
    padding: clamp(72px, 10vh, 120px) 1rem 1rem;
    min-height: 100vh;
    display: grid;
    grid-template-rows: auto 1fr auto;
    gap: .75rem
  }

  .chat-header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    gap: 1rem;
    width: min(1100px, 100%);
    margin: 0 auto
  }

  .chat-header h1 {
    margin: 0
  }

  .muted {
    color: var(--text-secondary)
  }

  .rh {
    display: flex;
    align-items: center;
    gap: .6rem;
    flex-wrap: wrap
  }

  .deck-select {
    display: flex;
    align-items: center;
    gap: .4rem;
    background: rgba(255, 255, 255, .05);
    padding: .4rem .6rem;
    border-radius: .6rem;
    border: 1px solid rgba(255, 255, 255, .12)
  }

  .deck-select select {
    background: transparent;
    color: var(--text-primary);
    border: none;
    outline: none
  }

  .strict-switch {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    background: rgba(255, 255, 255, .05);
    padding: .25rem .5rem;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, .12)
  }

  .strict-switch input {
    display: none
  }

  .strict-switch .slider {
    width: 34px;
    height: 18px;
    border-radius: 999px;
    background: rgba(255, 255, 255, .15);
    position: relative;
    transition: .2s
  }

  .strict-switch .slider::after {
    content: "";
    position: absolute;
    left: 2px;
    top: 2px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #fff;
    transition: .2s
  }

  .strict-switch input:checked+.slider {
    background: linear-gradient(135deg, #dc2626, #f59e0b)
  }

  .strict-switch input:checked+.slider::after {
    transform: translateX(16px)
  }

  .strict-switch .label {
    font-size: .85rem;
    color: var(--text-secondary)
  }

  .btn {
    border: 1px solid rgba(255, 255, 255, .12);
    background: rgba(255, 255, 255, .06);
    border-radius: .6rem;
    padding: .45rem .7rem;
    cursor: pointer
  }

  .btn:hover {
    background: rgba(255, 255, 255, .1)
  }

  .btn.ghost {
    background: transparent
  }

  .btn.primary {
    background: var(--gradient-fire);
    border: 1px solid rgba(251, 191, 36, .4);
    color: #fff
  }

  .chat-box {
    width: min(1100px, 100%);
    margin: 0 auto;
    background: var(--gradient-card);
    border: 1px solid rgba(255, 255, 255, .08);
    border-radius: 1rem;
    padding: 1rem;
    overflow: auto
  }

  .msg {
    display: flex;
    gap: .6rem;
    margin: .5rem 0
  }

  .msg.user {
    flex-direction: row-reverse
  }

  .msg .avatar {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, .08);
    border: 1px solid rgba(255, 255, 255, .12)
  }

  .bubble {
    max-width: 75%;
    background: rgba(255, 255, 255, .06);
    border: 1px solid rgba(255, 255, 255, .12);
    padding: .65rem .75rem;
    border-radius: .9rem
  }

  .msg.user .bubble {
    background: rgba(251, 191, 36, .12);
    border-color: rgba(251, 191, 36, .35)
  }

  .text {
    white-space: pre-wrap;
    line-height: 1.55
  }

  .meta {
    margin-top: .25rem;
    font-size: .8rem;
    color: var(--text-secondary)
  }

  .sources {
    margin-top: .45rem
  }

  .sources summary {
    cursor: pointer
  }

  .sources .tag {
    margin-left: .35rem;
    opacity: .8
  }

  .composer {
    width: min(1100px, 100%);
    margin: 0 auto
  }

  #chatForm {
    display: flex;
    gap: .6rem
  }

  .field {
    position: relative;
    flex: 1
  }

  #userInput {
    width: 100%;
    resize: none;
    min-height: 42px;
    max-height: 220px;
    border-radius: .75rem;
    border: 1px solid rgba(255, 255, 255, .12);
    background: rgba(255, 255, 255, .04);
    padding: .6rem .9rem;
    color: var(--text-primary);
    outline: none
  }

  #userInput:focus {
    border-color: rgba(251, 191, 36, .5)
  }

  .typing {
    position: absolute;
    right: .6rem;
    bottom: .45rem;
    display: flex;
    align-items: center;
    gap: .25rem
  }

  .typing span {
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: rgba(255, 255, 255, .6);
    display: inline-block;
    animation: blink 1s infinite ease-in-out
  }

  .typing span:nth-child(2) {
    animation-delay: .15s
  }

  .typing span:nth-child(3) {
    animation-delay: .3s
  }

  .typing em {
    font-style: normal;
    color: var(--text-secondary);
    font-size: .85rem;
    margin-left: .25rem
  }

  @keyframes blink {

    0%,
    80%,
    100% {
      opacity: .2
    }

    40% {
      opacity: 1
    }
  }
</style>

<script>
  (() => {
    const chatBox = document.getElementById('chatBox');
    const chatForm = document.getElementById('chatForm');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const typing = document.getElementById('typing');
    const deckSelect = document.getElementById('deckSelect');
    const strictMode = document.getElementById('strictMode');
    const btnNew = document.getElementById('btnNew');

    // Helpers
    const nowTime = () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const scrollBottom = () => chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
    const autogrow = () => { userInput.style.height = 'auto'; userInput.style.height = Math.min(userInput.scrollHeight, 220) + 'px'; };

    function appendUser(text) {
      const node = document.createElement('div');
      node.className = 'msg user';
      node.innerHTML = `
      <div class="avatar">👤</div>
      <div class="bubble">
        <div class="text"></div>
        <div class="meta">${nowTime()}</div>
      </div>`;
      node.querySelector('.text').textContent = text;
      chatBox.appendChild(node);
      scrollBottom();
    }

    function appendTyping() {
      const node = document.createElement('div');
      node.className = 'msg bot typing-row';
      node.innerHTML = `
      <div class="avatar">🤖</div>
      <div class="bubble">
        <div class="text">
          <span class="dots">···</span>
        </div>
        <div class="meta">Pensando…</div>
      </div>`;
      chatBox.appendChild(node);
      scrollBottom();
    }

    function replaceTypingWithBot(answer, sources) {
      const typingRow = chatBox.querySelector('.typing-row');
      const node = document.createElement('div');
      node.className = 'msg bot';
      const srcBlock = sources && sources.length ? `
      <details class="sources" open>
        <summary>Tarjetas consultadas</summary>
        <ul>
          ${sources.map(s => `
            <li>
              <strong>${s.front || ''}</strong><br>
              <small class="muted">${s.back || ''}</small>
              ${s.deck ? `<small class="tag">#${s.deck}</small>` : ``}
              ${s.box ? `<small class="tag">Caja ${s.box}</small>` : ``}
            </li>`).join('')}
        </ul>
      </details>` : ``;

      node.innerHTML = `
      <div class="avatar">🤖</div>
      <div class="bubble">
        <div class="text"></div>
        ${srcBlock}
        <div class="meta">${nowTime()}</div>
      </div>`;
      const textEl = node.querySelector('.text');

      // efecto "typed"
      let i = 0; const speed = 12;
      const timer = setInterval(() => {
        textEl.textContent = answer.slice(0, i += Math.max(1, Math.floor(answer.length / 300)));
        if (i >= answer.length) clearInterval(timer);
        scrollBottom();
      }, speed);

      if (typingRow) typingRow.replaceWith(node); else chatBox.appendChild(node);
      scrollBottom();
    }

    async function loadDecks() {
      try {
        const res = await fetch('/api/leitner/decks');
        const { ok, decks } = await res.json();
        if (!ok || !Array.isArray(decks)) return;
        decks.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d; opt.textContent = d || 'general';
          deckSelect.appendChild(opt);
        });
      } catch { }
    }

    async function askBackend(question) {
      const body = {
        message: question,
        deck: deckSelect.value || '',
        strict: !!strictMode.checked
      };
      const res = await fetch('/api/chat/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await res.json().catch(() => ({}));
      if (data && data.response) {
        data.answer = data.response; // ← Mantener compatibilidad con el frontend
      }
      return data;
    }

    // Events
    userInput.addEventListener('input', autogrow);
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = userInput.value.trim();
      if (!q) return;

      // pinta usuario
      appendUser(q);

      // estado cargando
      sendBtn.disabled = true;
      typing.hidden = false;
      appendTyping();

      try {
        const data = await askBackend(q);
        const answer = (data && data.response) || 'No he podido generar una respuesta.';
        replaceTypingWithBot(answer, data.sources || []);
      } catch (err) {
        replaceTypingWithBot('⚠️ Error consultando el servicio. Inténtalo de nuevo.', []);
      } finally {
        typing.hidden = true;
        sendBtn.disabled = false;
        userInput.value = '';
        autogrow();
      }
    });

    btnNew.addEventListener('click', async () => {
      await fetch('/api/chat/clear', { method: 'POST' });
      window.location.reload();
    });

    // init
    autogrow();
    loadDecks();
  })();
</script>
{% endblock %}