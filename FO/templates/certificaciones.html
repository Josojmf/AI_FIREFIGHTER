{% extends "layout.html" %}

{% block title %}Certificaciones - Onfire AI{% endblock %}

{% block styles %}
<style>
  /* Estilos especÃ­ficos para certificaciones */
  .certificaciones-hero {
    padding: 2.5rem 0 1rem;
    text-align: center;
  }

  .hero-badge {
    display: inline-flex;
    gap: .5rem;
    align-items: center;
    padding: .35rem .7rem;
    border-radius: 999px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.12);
    color: var(--text-secondary);
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .hero-title {
    font-size: clamp(1.8rem, 5vw, 2.6rem);
    font-weight: 800;
    margin: .6rem 0 .3rem;
    line-height: 1.2;
  }

  .hero-subtitle {
    color: var(--text-secondary);
    max-width: 820px;
    margin: 0 auto 1.5rem;
    font-size: 1.1rem;
  }

  .hero-features {
    display: flex;
    gap: .8rem;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 1rem;
  }

  .feature-item {
    display: flex;
    gap: .4rem;
    align-items: center;
    padding: .45rem .7rem;
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 999px;
    background: rgba(255,255,255,.04);
    color: var(--text-secondary);
    font-weight: 600;
  }

  .platform-controls {
    padding: 1rem 0;
  }

  .controls-wrapper {
    background: var(--gradient-card);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: var(--radius-xl);
    padding: 1.5rem;
    text-align: center;
  }

  .controls-header {
    margin-bottom: 1rem;
  }

  .controls-header h2 {
    margin-bottom: .5rem;
  }

  /* Indicador del sitio actual */
  .current-site-indicator {
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: .4rem .8rem;
    border-radius: 999px;
    background: rgba(220, 38, 38, 0.15);
    border: 1px solid rgba(220, 38, 38, 0.3);
    color: #ef4444;
    font-weight: 600;
    font-size: .9rem;
    margin-bottom: .5rem;
  }

  .controls-grid {
    display: flex;
    gap: .6rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .control-btn {
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: .8rem 1.1rem;
    border-radius: var(--radius-lg);
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    cursor: pointer;
    font-weight: 600;
    transition: all var(--transition-base);
    text-decoration: none;
    color: inherit;
  }

  .control-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,.2);
  }

  .iframe-container {
    position: relative;
    border-radius: var(--radius-xl);
    background: var(--gradient-card);
    border: 1px solid rgba(255,255,255,.08);
    box-shadow: 0 14px 40px rgba(0,0,0,.35);
    overflow: hidden;
    min-height: 600px; /* Aumentado para mejor visualizaciÃ³n */
  }

  .iframe-wrapper {
    width: 100%;
    height: 600px;
    position: relative;
  }

  .iframe-wrapper iframe {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: var(--radius-xl);
  }

  .iframe-loading {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(180deg, rgba(11,11,15,.75), rgba(11,11,15,.35));
    backdrop-filter: blur(4px);
    z-index: 10;
    text-align: center;
    padding: 2rem;
  }

  .iframe-error {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(180deg, rgba(11,11,15,.9), rgba(11,11,15,.6));
    backdrop-filter: blur(6px);
    z-index: 10;
    text-align: center;
    padding: 2rem;
  }

  .loading-spinner-large {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 4px solid rgba(255,255,255,.2);
    border-top-color: #fff;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .error-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .error-actions {
    display: flex;
    gap: .8rem;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 1.5rem;
  }

  .platform-info {
    margin: 2rem 0;
  }

  .info-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
  }

  .info-card {
    background: var(--gradient-card);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    text-align: center;
  }

  .card-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    display: block;
  }

  .faq-section {
    margin: 2rem 0;
  }

  .faq-container {
    display: flex;
    flex-direction: column;
    gap: .8rem;
  }

  .faq-item {
    background: var(--gradient-card);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .faq-question {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    font-weight: 600;
    padding: 1rem;
    list-style: none;
  }

  .faq-question::-webkit-details-marker {
    display: none;
  }

  .faq-answer {
    padding: 0 1rem 1rem;
    color: var(--text-secondary);
  }

  .cta-section {
    padding: 2rem 0;
    text-align: center;
  }

  .cta-content {
    background: var(--gradient-card);
    border-radius: var(--radius-xl);
    padding: 2rem;
    border: 1px solid rgba(255,255,255,.08);
  }

  .cta-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .cta-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  /* Animaciones */
  .animate-on-scroll {
    opacity: 0;
    transform: translateY(12px);
    transition: opacity .6s ease, transform .6s ease;
  }

  .animate-in {
    opacity: 1 !important;
    transform: translateY(0) !important;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .controls-grid {
      flex-direction: column;
      align-items: center;
    }
    
    .control-btn {
      width: 100%;
      justify-content: center;
    }
    
    .error-actions, .cta-buttons {
      flex-direction: column;
    }
    
    .info-cards {
      grid-template-columns: 1fr;
    }

    .iframe-container {
      min-height: 400px;
    }

    .iframe-wrapper {
      height: 400px;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Certificaciones Hero Section -->
<section class="certificaciones-hero">
  <div class="container">
    <div class="hero-content animate-on-scroll">
      <div class="hero-badge">
        <span class="badge-icon">ğŸ“</span>
        <span class="badge-text">Plataforma de Certificaciones Profesionales</span>
      </div>
      <h1 class="hero-title">
        <span class="text-gradient">Certificaciones</span><br>
        Oficiales y FormaciÃ³n <span class="text-gradient">Reconocida</span>
      </h1>
      <p class="hero-subtitle">
        Accede a contenidos acreditados, programas con reconocimiento oficial
        y vÃ­as de certificaciÃ³n profesional para tu desarrollo como bombero.
      </p>
      <div class="hero-features">
        <div class="feature-item"><span class="feature-icon">ğŸ†</span><span class="feature-text">Reconocimiento Oficial</span></div>
        <div class="feature-item"><span class="feature-icon">ğŸ“‹</span><span class="feature-text">Programas Acreditados</span></div>
        <div class="feature-item"><span class="feature-icon">ğŸ¯</span><span class="feature-text">Desarrollo Profesional</span></div>
      </div>
    </div>
  </div>
</section>

<!-- Platform Controls -->
<section class="platform-controls">
  <div class="container">
    <div class="controls-wrapper animate-on-scroll">
      <div class="controls-header">
        <h2>Plataforma de FormaciÃ³n Certificada</h2>
        
        <!-- Indicador del sitio actual -->
        {% if current_mode %}
        <div class="current-site-indicator">
          {% if current_mode == 'main' %}
            <span>ğŸ </span><span>OnFire Academy - Principal</span>
          {% elif current_mode == 'header' %}
            <span>ğŸ¯</span><span>OnFire Academy - Header</span>
          {% elif current_mode == 'examinadores' %}
            <span>ğŸ‘¨â€ğŸ«</span><span>OnFire Academy - Examinadores</span>
          {% elif current_mode == 'formacion' %}
            <span>ğŸ“</span><span>FormaciÃ³n Certificado Profesional</span>
          {% else %}
            <span>ğŸ”¥</span><span>Plataforma de CertificaciÃ³n</span>
          {% endif %}
        </div>
        {% endif %}
        
        <p>Gestiona tu experiencia de aprendizaje con los controles avanzados</p>
      </div>
      
      <div class="controls-grid">
        <a href="/certificaciones/selector" class="control-btn btn-primary">
          <span class="btn-icon">ğŸ </span><span class="btn-text">Selector de Sitios</span>
        </a>
        
        {% if current_mode == 'main' %}
        <a href="https://www.onfireacademy.es/" target="_blank" rel="noopener" class="control-btn btn-accent" id="openExternal">
          <span class="btn-icon">ğŸŒ</span><span class="btn-text">OnFire Academy</span>
        </a>
        {% elif current_mode == 'formacion' %}
        <a href="https://www.formacioncertificadoprofesional.com/" target="_blank" rel="noopener" class="control-btn btn-accent" id="openExternal">
          <span class="btn-icon">ğŸŒ</span><span class="btn-text">FormaciÃ³n Profesional</span>
        </a>
        {% elif current_mode == 'examinadores' %}
        <a href="https://www.onfireacademy.es/examinadores.html" target="_blank" rel="noopener" class="control-btn btn-accent" id="openExternal">
          <span class="btn-icon">ğŸŒ</span><span class="btn-text">Examinadores</span>
        </a>
        {% elif current_mode == 'header' %}
        <a href="https://www.onfireacademy.es/index.html#header13-2w" target="_blank" rel="noopener" class="control-btn btn-accent" id="openExternal">
          <span class="btn-icon">ğŸŒ</span><span class="btn-text">SecciÃ³n Header</span>
        </a>
        {% else %}
        <a href="https://www.onfireacademy.es/" target="_blank" rel="noopener" class="control-btn btn-accent" id="openExternal">
          <span class="btn-icon">ğŸŒ</span><span class="btn-text">Abrir Externa</span>
        </a>
        {% endif %}
        
        <button type="button" class="control-btn btn-secondary" id="reloadFrame">
          <span class="btn-icon">ğŸ”„</span><span class="btn-text">Recargar</span>
        </button>
        
        <button type="button" class="control-btn btn-secondary" id="enterFullscreen">
          <span class="btn-icon">â›¶</span><span class="btn-text">Pantalla Completa</span>
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Embedded Platform -->
<section class="embedded-platform-section">
  <div class="container">
    <div class="iframe-container animate-on-scroll" id="embedCard">
      <!-- Loader - Mostrado inicialmente -->
      <div id="loader" class="iframe-loading">
        <div class="loading-content">
          <div class="loading-spinner-large"></div>
          <h3>Cargando Plataforma de Certificaciones</h3>
          <p>Conectando con la plataforma oficial...</p>
        </div>
      </div>

      <!-- Bloqueado - Mostrado si falla la carga -->
      <div id="frameBlocked" class="iframe-error" style="display:none;">
        <div class="error-content">
          <div class="error-icon">ğŸ›¡ï¸</div>
          <h3>Contenido Bloqueado por Seguridad</h3>
          <p>La plataforma utiliza polÃ­ticas que impiden su visualizaciÃ³n embebida.</p>
          <div class="error-details">
            <h4>Detalles tÃ©cnicos:</h4>
            <ul class="error-reasons">
              <li><code>X-Frame-Options</code></li>
              <li><code>Content-Security-Policy: frame-ancestors</code></li>
              <li>ProtecciÃ³n contra clickjacking</li>
            </ul>
          </div>
          <div class="error-actions">
            {% if current_mode == 'formacion' %}
            <a href="https://www.formacioncertificadoprofesional.com/" target="_blank" rel="noopener" class="btn btn-primary">
              <span class="btn-icon">ğŸ”—</span><span class="btn-text">Abrir FormaciÃ³n Profesional</span>
            </a>
            {% elif current_mode == 'examinadores' %}
            <a href="https://www.onfireacademy.es/examinadores.html" target="_blank" rel="noopener" class="btn btn-primary">
              <span class="btn-icon">ğŸ”—</span><span class="btn-text">Abrir Examinadores</span>
            </a>
            {% else %}
            <a href="https://www.onfireacademy.es/" target="_blank" rel="noopener" class="btn btn-primary">
              <span class="btn-icon">ğŸ”—</span><span class="btn-text">Abrir en Nueva Ventana</span>
            </a>
            {% endif %}
            <button type="button" class="btn btn-secondary" id="tryAgain">
              <span class="btn-icon">ğŸ”„</span><span class="btn-text">Reintentar Carga</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Iframe - Oculto inicialmente -->
      <div class="iframe-wrapper" id="embedAspect" style="display:none;">
        <iframe id="certFrame" 
                src="{{ proxied_url if proxied_url else '/onfire-academy/' }}" 
                frameborder="0"
                allowfullscreen 
                referrerpolicy="no-referrer-when-downgrade"
                sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation allow-modals"
                title="Plataforma de Certificaciones Profesionales" 
                loading="lazy">
        </iframe>
      </div>
    </div>

    <!-- Info Cards -->
    <div class="platform-info animate-on-scroll">
      <div class="info-cards">
        <div class="info-card">
          <div class="card-icon">ğŸ“œ</div>
          <h3>Certificaciones Oficiales</h3>
          <p>Certificados reconocidos por organismos oficiales del sector.</p>
        </div>
        <div class="info-card">
          <div class="card-icon">ğŸ‘¨â€ğŸ«</div>
          <h3>Instructores Expertos</h3>
          <p>Aprende con profesionales con aÃ±os de experiencia.</p>
        </div>
        <div class="info-card">
          <div class="card-icon">ğŸ¯</div>
          <h3>FormaciÃ³n Especializada</h3>
          <p>Programas adaptados a necesidades del sector.</p>
        </div>
      </div>
    </div>

    <!-- FAQ -->
    <div class="faq-section animate-on-scroll">
      <h2 class="section-title">Preguntas Frecuentes</h2>
      <div class="faq-container">
        <details class="faq-item">
          <summary class="faq-question"><span>Â¿Por quÃ© a veces no se muestra el contenido embebido?</span><span class="faq-icon">â–¼</span></summary>
          <div class="faq-answer">
            <p>Algunos sitios bloquean iframes por seguridad (XFO/CSP). Nuestro proxy avanzado intenta solucionarlo automÃ¡ticamente.</p>
          </div>
        </details>
        <details class="faq-item">
          <summary class="faq-question"><span>Â¿Puedo cambiar entre diferentes plataformas?</span><span class="faq-icon">â–¼</span></summary>
          <div class="faq-answer">
            <p>SÃ­, usa el "Selector de Sitios" para acceder a OnFire Academy, FormaciÃ³n Profesional y pÃ¡ginas especÃ­ficas.</p>
          </div>
        </details>
        <details class="faq-item">
          <summary class="faq-question"><span>Â¿Las certificaciones tienen validez oficial?</span><span class="faq-icon">â–¼</span></summary>
          <div class="faq-answer">
            <p>SÃ­: reconocimiento institucional, certificados verificables y vÃ¡lidos en procesos oficiales.</p>
          </div>
        </details>
      </div>
    </div>
  </div>
</section>

<!-- CTA -->
<section class="cta-section">
  <div class="container">
    <div class="cta-content animate-on-scroll">
      <div class="cta-icon">ğŸ“</div>
      <h2 class="cta-title">Â¿Listo para obtener tu certificaciÃ³n profesional?</h2>
      <p class="cta-subtitle">Accede a la formaciÃ³n mÃ¡s completa y reconocida del sector.</p>
      <div class="cta-buttons">
        {% if current_mode == 'formacion' %}
        <a href="https://www.formacioncertificadoprofesional.com/" target="_blank" rel="noopener" class="btn btn-primary btn-large">
          <span class="btn-icon">ğŸš€</span><span class="btn-text">Comenzar FormaciÃ³n</span>
        </a>
        {% else %}
        <a href="https://www.onfireacademy.es/" target="_blank" rel="noopener" class="btn btn-primary btn-large">
          <span class="btn-icon">ğŸš€</span><span class="btn-text">Comenzar CertificaciÃ³n</span>
        </a>
        {% endif %}
        <a href="/certificaciones/selector" class="btn btn-secondary btn-large">
          <span class="btn-icon">ğŸ </span><span class="btn-text">Ver Todas las Opciones</span>
        </a>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // InicializaciÃ³n de elementos
  const loader = document.getElementById('loader');
  const blocked = document.getElementById('frameBlocked');
  const iframeWrapper = document.getElementById('embedAspect');
  const frame = document.getElementById('certFrame');

  // Estado inicial
  loader.style.display = 'flex';
  iframeWrapper.style.display = 'none';
  blocked.style.display = 'none';

  let isBlocked = false;
  let loadAttempts = 0;
  const maxAttempts = 3;

  // FunciÃ³n para detectar si el iframe estÃ¡ bloqueado
  function detectBlocking() {
    try {
      const iframeDoc = frame.contentDocument || frame.contentWindow.document;
      if (iframeDoc && iframeDoc.body && iframeDoc.body.children.length > 0) {
        // Carga exitosa
        console.log('ğŸ”¥ Iframe loaded successfully');
        loader.style.display = 'none';
        iframeWrapper.style.display = 'block';
        return true;
      }
    } catch (e) {
      console.warn('ğŸ›¡ï¸ Iframe access blocked:', e.message);
    }
    return false;
  }

  // Timeout para detectar bloqueo
  const blockTimeout = setTimeout(() => {
    if (!detectBlocking()) {
      console.log('ğŸš« Iframe appears to be blocked');
      loader.style.display = 'none';
      blocked.style.display = 'flex';
      iframeWrapper.style.display = 'none';
      isBlocked = true;
    }
  }, 5000); // Aumentado a 5 segundos para dar mÃ¡s tiempo

  // Event listener para carga exitosa
  frame.addEventListener('load', () => {
    clearTimeout(blockTimeout);
    
    // PequeÃ±o delay para asegurar que el contenido se ha cargado
    setTimeout(() => {
      if (detectBlocking()) {
        console.log('ğŸ”¥ Iframe content loaded via proxy');
      } else {
        console.log('ğŸš« Iframe loaded but content blocked');
        loader.style.display = 'none';
        blocked.style.display = 'flex';
        iframeWrapper.style.display = 'none';
        isBlocked = true;
      }
    }, 1000);
  });

  // Event listener para errores
  frame.addEventListener('error', () => {
    clearTimeout(blockTimeout);
    console.log('âŒ Iframe failed to load');
    loader.style.display = 'none';
    blocked.style.display = 'flex';
    iframeWrapper.style.display = 'none';
    isBlocked = true;
  });

  // Botones de control
  const tryAgain = document.getElementById('tryAgain');
  const reloadBtn = document.getElementById('reloadFrame');
  const fsBtn = document.getElementById('enterFullscreen');
  const card = document.getElementById('embedCard');

  if (tryAgain) {
    tryAgain.addEventListener('click', () => {
      if (loadAttempts < maxAttempts) {
        loadAttempts++;
        console.log(`ğŸ”„ Retry attempt ${loadAttempts}/${maxAttempts}`);
        
        loader.style.display = 'flex';
        blocked.style.display = 'none';
        iframeWrapper.style.display = 'none';
        
        // Forzar recarga con timestamp para evitar cachÃ©
        const currentSrc = frame.src.split('?')[0];
        frame.src = currentSrc + '?t=' + Date.now() + '&retry=' + loadAttempts;
        isBlocked = false;
      } else {
        alert('Se han agotado los intentos de recarga. Usa "Abrir en Nueva Ventana".');
      }
    });
  }

  if (reloadBtn) {
    reloadBtn.addEventListener('click', () => {
      loader.style.display = 'flex';
      blocked.style.display = 'none';
      iframeWrapper.style.display = 'none';
      
      try {
        frame.contentWindow.location.reload();
      } catch {
        const currentSrc = frame.src.split('?')[0];
        frame.src = currentSrc + '?t=' + Date.now();
      }
      isBlocked = false;
    });
  }

  if (fsBtn && card) {
    fsBtn.addEventListener('click', async () => {
      try {
        if (document.fullscreenElement) {
          await document.exitFullscreen();
          fsBtn.innerHTML = '<span class="btn-icon">â›¶</span><span class="btn-text">Pantalla Completa</span>';
        } else {
          await card.requestFullscreen();
          fsBtn.innerHTML = '<span class="btn-icon">â›¶</span><span class="btn-text">Salir Pantalla Completa</span>';
        }
      } catch (e) {
        console.warn('Fullscreen no disponible:', e);
        alert('Pantalla completa no disponible en este navegador');
      }
    });

    // Detectar salida de pantalla completa
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        fsBtn.innerHTML = '<span class="btn-icon">â›¶</span><span class="btn-text">Pantalla Completa</span>';
      }
    });
  }

  // Animaciones de scroll
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('animate-in');
      }
    });
  }, {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  });

  document.querySelectorAll('.animate-on-scroll').forEach(el => {
    observer.observe(el);
  });

  // Log inicial para debugging
  console.log('ğŸ”¥ FirefighterAI Certificaciones initialized');
  console.log('ğŸ“„ Current iframe src:', frame.src);
});
</script>
{% endblock %}