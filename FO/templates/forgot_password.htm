{% extends "layout.html" %}
{% block title %}Recuperar contrase√±a | FirefighterAI{% endblock %}

{% block content %}
<section class="auth-forgot">
  <!-- Fondo decorativo (no captura clics) -->
  <div class="auth-bg" aria-hidden="true">
    <div class="bg-gradient"></div>
    <div class="bg-particles"></div>
    <div class="bg-grid"></div>
  </div>

  <div class="auth-grid">
    <!-- Aside informativo -->
    <aside class="auth-aside animate-fade-in">
      <div class="aside-head">
        <div class="flame">üõ†Ô∏è</div>
        <h1>Recupera tu acceso</h1>
        <p class="muted">Te enviaremos un enlace de restablecimiento si tu cuenta existe.</p>
      </div>

      <ul class="aside-list">
        <li>üîí Enlace √∫nico y temporal</li>
        <li>üìß Revisa tu carpeta de spam</li>
        <li>üïí El enlace expira por seguridad</li>
      </ul>

      <div class="aside-footer">
        <small>¬øProblemas? Escr√≠benos y te ayudamos.</small>
      </div>
    </aside>

    <!-- Card de recuperaci√≥n -->
    <div class="auth-card animate-fade-in">
      <header class="auth-header">
        <div class="icon-wrap">üõ°Ô∏è</div>
        <div>
          <h2>Restablecer contrase√±a</h2>
          <p class="muted">Elige el m√©todo y recibe instrucciones</p>
        </div>
      </header>

      <!-- Tabs -->
      <div class="tabs" role="tablist" aria-label="M√©todo de recuperaci√≥n">
        <button class="tab" role="tab" aria-selected="true" aria-controls="panel-email" id="tab-email">Por email</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="panel-username" id="tab-username">Por usuario</button>
      </div>

      <form method="POST" id="forgot-form" action="{{ url_for('forgot_password') }}" novalidate>
        {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}

        <!-- Panel: Email -->
        <div id="panel-email" class="tab-panel active" role="tabpanel" aria-labelledby="tab-email">
          <div class="field">
            <label for="email">Email</label>
            <div class="input-wrap">
              <span class="input-icon">üìß</span>
              <input id="email" name="email" type="email" placeholder="tu.email@ejemplo.com" autocomplete="email">
            </div>
            <small class="hint">Usa el correo con el que te registraste.</small>
          </div>
        </div>

        <!-- Panel: Usuario -->
        <div id="panel-username" class="tab-panel" role="tabpanel" aria-labelledby="tab-username" hidden>
          <div class="field">
            <label for="username">Usuario</label>
            <div class="input-wrap">
              <span class="input-icon">üë§</span>
              <input id="username" name="username" type="text" placeholder="Ej. m.lopez" autocomplete="username">
            </div>
            <small class="hint">Te enviaremos el enlace al email asociado.</small>
          </div>
        </div>

        <button class="btn btn-primary submit-btn" type="submit" id="submit-forgot">
          <span class="btn-text">Enviar enlace</span>
          <span class="btn-spinner" aria-hidden="true"></span>
        </button>

        <div class="auth-links">
          <a href="{{ url_for('login') }}" class="link">‚Üê Volver a iniciar sesi√≥n</a>
          <span class="sep">¬∑</span>
          <a href="{{ url_for('register') }}" class="link">Crear cuenta</a>
        </div>

        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="flash-local" role="status" aria-live="polite">
              {% for msg in messages %}
                <p>‚ö†Ô∏è {{ msg }}</p>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<style>
/* ===== Layout general ===== */
.auth-forgot{
  padding: clamp(90px, 12vh, 120px) 1rem 3rem;
  min-height: 100vh;
  position: relative;
}
.auth-grid{
  margin: 0 auto;
  width: min(1100px, 100%);
  display: grid;
  grid-template-columns: 1.1fr 1fr;
  gap: clamp(1rem, 2.5vw, 2rem);
}

/* Fondo (no captura clics) */
.auth-bg{ position:absolute; inset:0; z-index:0; pointer-events:none; }
.auth-grid, .auth-card, .auth-aside{ position:relative; z-index:1; }

/* Aside */
.auth-aside{
  background: var(--gradient-card);
  border: 1px solid rgba(220, 38, 38, .25);
  border-radius: var(--radius-2xl);
  padding: clamp(1.2rem, 2.5vw, 2rem);
  box-shadow: var(--shadow-lg);
  overflow: hidden;
}
.auth-aside::after{
  content:"";
  position:absolute; inset:-30%;
  background:
    radial-gradient(600px 300px at 15% 20%, rgba(220, 38, 38, .16), transparent 60%),
    radial-gradient(520px 260px at 90% 80%, rgba(14, 165, 233, .12), transparent 60%);
  filter: blur(8px);
  z-index:-1;
}
.aside-head{ display:grid; gap:.6rem; }
.aside-head .flame{ font-size:2rem; filter: drop-shadow(0 8px 30px rgba(220,38,38,.35)); }
.auth-aside h1{ font-size: clamp(1.5rem, 4vw, 2.2rem); font-weight: 800; }
.muted{ color: var(--text-secondary); }
.aside-list{ list-style:none; display:grid; gap:.45rem; margin:.8rem 0 1rem; font-weight:600; }
.aside-footer{ color: var(--text-muted); }

/* Card */
.auth-card{
  background: var(--bg-secondary);
  border: 1px solid rgba(220, 38, 38, .22);
  border-radius: var(--radius-2xl);
  padding: clamp(1.2rem, 2.6vw, 2rem);
  box-shadow: var(--shadow-xl);
}
.auth-header{ display:flex; align-items:center; gap:.9rem; margin-bottom: 1rem; }
.icon-wrap{
  width:44px;height:44px;display:grid;place-items:center;border-radius:12px;
  background: rgba(220,38,38,.15); border:1px solid rgba(220,38,38,.35);
  font-size:1.2rem;
}
.auth-header h2{ font-size:1.5rem; margin:0; }
.auth-header .muted{ margin-top:.2rem; }

/* Tabs */
.tabs{
  display:flex; gap:.5rem; background: rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.08);
  padding:.35rem; border-radius: var(--radius-lg);
  margin-bottom:1rem;
}
.tab{
  flex:1; padding:.6rem .8rem; border:0; cursor:pointer;
  background: transparent; color: var(--text-secondary); font-weight:700;
  border-radius: var(--radius-md); transition: all var(--transition-base);
}
.tab[aria-selected="true"]{
  color:#fff; background: rgba(255,255,255,.08); box-shadow: var(--shadow-sm);
  border: 1px solid rgba(255,255,255,.12);
}
.tab:focus{ outline:2px solid var(--primary-red); outline-offset:2px; }

/* Panels */
.tab-panel{ margin-top:.5rem; }
.tab-panel[hidden]{ display:none; }

/* Form */
.field{ margin-bottom:1rem; }
.field label{ display:block; font-weight:700; margin-bottom:.4rem; }
.input-wrap{
  position:relative; display:flex; align-items:center;
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.12);
  border-radius: var(--radius-lg);
  padding: .25rem .6rem .25rem .9rem;
  transition: border var(--transition-base), box-shadow var(--transition-base);
}
.input-wrap:focus-within{
  border-color: rgba(220,38,38,.55);
  box-shadow: 0 0 0 4px rgba(220,38,38,.12);
}
.input-icon{ opacity:.9; margin-right:.4rem; }
.input-wrap input{
  width:100%; background:transparent; border:0; outline:none; color:var(--text-primary);
  padding:.75rem .4rem; font-weight:600;
}
.hint{ color:var(--text-muted); font-size:.85rem; }

/* Bot√≥n */
.submit-btn{ width:100%; justify-content:center; margin-top:.6rem; position:relative; overflow:hidden; }
.btn-spinner{
  width:1.1rem;height:1.1rem;border-radius:50%;
  border:3px solid rgba(255,255,255,.35); border-top-color:#fff;
  margin-left:.6rem; display:none; animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.submit-btn.loading .btn-spinner{ display:inline-block; }
.submit-btn.loading .btn-text{ opacity:.75; }

/* Links inferiores */
.auth-links{
  display:flex; align-items:center; justify-content:center; gap:.6rem;
  margin-top: .9rem; color: var(--text-secondary);
}
.link{ color: var(--text-accent); border-bottom:1px dashed rgba(251,191,36,.5); }
.link:hover{ color:#fff; border-bottom-color:#fff; }
.sep{ opacity:.5; }

/* Flash local */
.flash-local{
  margin-top:.9rem; background: linear-gradient(145deg, rgba(220,38,38,.12), var(--bg-secondary));
  border:1px solid rgba(220,38,38,.35); padding:.75rem; border-radius:12px;
}

/* Responsive */
@media (max-width: 980px){
  .auth-grid{ grid-template-columns: 1fr; }
  .auth-aside{ order:2; }
  .auth-card{ order:1; }
}
</style>

<script>
(() => {
  // Tabs
  const tabEmail = document.getElementById('tab-email');
  const tabUser  = document.getElementById('tab-username');
  const panelEmail = document.getElementById('panel-email');
  const panelUser  = document.getElementById('panel-username');

  function activateTab(which){
    const isEmail = which === 'email';
    tabEmail.setAttribute('aria-selected', isEmail ? 'true' : 'false');
    tabUser.setAttribute('aria-selected', isEmail ? 'false' : 'true');
    panelEmail.hidden = !isEmail;
    panelUser.hidden  =  isEmail;
    panelEmail.classList.toggle('active', isEmail);
    panelUser.classList.toggle('active', !isEmail);
  }

  tabEmail?.addEventListener('click', () => activateTab('email'));
  tabUser?.addEventListener('click',  () => activateTab('user'));

  // Submit UX
  const form = document.getElementById('forgot-form');
  const btn  = document.getElementById('submit-forgot');
  const email = document.getElementById('email');
  const username = document.getElementById('username');

  form?.addEventListener('submit', (e) => {
    const emailSelected = tabEmail.getAttribute('aria-selected') === 'true';
    const emailVal = email?.value.trim() || '';
    const userVal  = username?.value.trim() || '';

    // Validaci√≥n m√≠nima en cliente
    if (emailSelected) {
      if (!emailVal) { e.preventDefault(); shake(panelEmail); focusInput(email); return; }
    } else {
      if (!userVal)  { e.preventDefault(); shake(panelUser);  focusInput(username); return; }
    }

    btn.classList.add('loading');
    btn.setAttribute('disabled','disabled');
  });

  function shake(el){
    el.style.animation = 'shake .5s ease-in-out';
    setTimeout(() => el.style.animation = '', 500);
  }
  function focusInput(i){ try { i?.focus(); } catch {} }

  // Agregamos animaci√≥n "shake"
  const style = document.createElement('style');
  style.textContent = `
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      10%,30%,50%,70%,90% { transform: translateX(-3px); }
      20%,40%,60%,80% { transform: translateX(3px); }
    }
  `;
  document.head.appendChild(style);
})();
</script>
{% endblock %}
