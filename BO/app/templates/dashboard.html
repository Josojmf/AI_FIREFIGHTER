{% extends "backoffice_layout.html" %}

{% block title %}Dashboard - Onfire AI BackOffice{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard">
  <!-- MÃ©tricas principales -->
  <div class="metrics-grid">
    <div class="metric-card" data-metric="users">
      <div class="metric-icon">ğŸ‘¥</div>
      <div class="metric-content">
        <div class="metric-value" id="totalUsers">{{ stats.total_users or 0 }}</div>
        <div class="metric-label">Total Usuarios</div>
        <div class="metric-trend" id="usersTrend">
          <span class="trend-icon">â†—</span>
          <span class="trend-value">Cargando...</span>
        </div>
      </div>
      <div class="metric-actions">
        <button class="metric-action-btn" onclick="refreshMetric('users')" title="Actualizar">
          <span>ğŸ”„</span>
        </button>
      </div>
    </div>

    <div class="metric-card" data-metric="active">
      <div class="metric-icon">âœ…</div>
      <div class="metric-content">
        <div class="metric-value" id="activeUsers">{{ stats.active_users or 0 }}</div>
        <div class="metric-label">Usuarios Activos</div>
        <div class="metric-trend" id="activeTrend">
          <span class="trend-icon">â†—</span>
          <span class="trend-value">Cargando...</span>
        </div>
      </div>
      <div class="metric-actions">
        <button class="metric-action-btn" onclick="refreshMetric('active')" title="Actualizar">
          <span>ğŸ”„</span>
        </button>
      </div>
    </div>

    <div class="metric-card" data-metric="cards">
      <div class="metric-icon">ğŸ—ƒï¸</div>
      <div class="metric-content">
        <div class="metric-value" id="totalCards">{{ stats.total_cards or 0 }}</div>
        <div class="metric-label">Memory Cards</div>
        <div class="metric-trend" id="cardsTrend">
          <span class="trend-icon">â†—</span>
          <span class="trend-value">Cargando...</span>
        </div>
      </div>
      <div class="metric-actions">
        <button class="metric-action-btn" onclick="refreshMetric('cards')" title="Actualizar">
          <span>ğŸ”„</span>
        </button>
      </div>
    </div>

    <div class="metric-card" data-metric="api">
      <div class="metric-icon">ğŸŒ</div>
      <div class="metric-content">
        <div class="metric-value api-status-value" id="apiStatus">
          {% if stats.api_status == 'online' %}Online
          {% else %}Offline
          {% endif %}
        </div>
        <div class="metric-label">Estado API</div>
        <div class="metric-trend" id="apiTrend">
          <span class="trend-icon">{% if stats.api_status == 'online' %}âœ…{% else %}âŒ{% endif %}</span>
          <span class="trend-value">{{ stats.api_status|title or 'Offline' }}</span>
        </div>
      </div>
      <div class="metric-actions">
        <button class="metric-action-btn" onclick="checkApiHealth()" title="Verificar API">
          <span>ğŸ”</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Widgets principales -->
  <div class="widgets-grid">
    <!-- Actividad reciente REAL -->
    <div class="widget">
      <div class="widget-header">
        <h3 class="widget-title">
          <span class="widget-icon">ğŸ“ˆ</span>
          Actividad Reciente
        </h3>
        <div class="widget-actions">
          <button class="widget-btn" onclick="refreshActivity()" title="Actualizar">ğŸ”„</button>
          <button class="widget-btn" onclick="expandWidget(this)" title="Expandir">â›¶</button>
        </div>
      </div>
      <div class="widget-content">
        <div class="activity-list" id="activityList">
          {% if stats.recent_activity %}
          {% for activity in stats.recent_activity %}
          <div class="activity-item">
            <div class="activity-icon">{{ activity.icon }}</div>
            <div class="activity-content">
              <div class="activity-text">{{ activity.text }}</div>
              <div class="activity-time">{{ activity.time }}</div>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <div class="activity-item">
            <div class="activity-icon">â³</div>
            <div class="activity-content">
              <div class="activity-text">Cargando actividad...</div>
              <div class="activity-time">Espere por favor</div>
            </div>
          </div>
          {% endif %}
        </div>
        <div class="widget-footer">
          <a href="{{ url_for('users.user_list') }}" class="widget-link">Ver todos los usuarios</a>
        </div>
      </div>
    </div>

    <!-- GrÃ¡fico de usuarios (placeholder para datos reales) -->
    <div class="widget">
      <div class="widget-header">
        <h3 class="widget-title">
          <span class="widget-icon">ğŸ“Š</span>
          Resumen del Sistema
        </h3>
        <div class="widget-actions">
          <button class="widget-btn" onclick="refreshCharts()" title="Actualizar grÃ¡ficos">ğŸ”„</button>
        </div>
      </div>
      <div class="widget-content">
        <div class="stats-summary">
          <div class="stat-item">
            <span class="stat-label">Usuarios registrados:</span>
            <span class="stat-value" id="summaryUsers">{{ stats.total_users }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Tarjetas creadas:</span>
            <span class="stat-value" id="summaryCards">{{ stats.total_cards }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Tasa de actividad:</span>
            <span class="stat-value">
              {% if stats.total_users > 0 %}
              {{ ((stats.active_users / stats.total_users) * 100)|round(1) }}%
              {% else %}
              0%
              {% endif %}
            </span>
          </div>
        </div>
        <div class="simple-chart">
          <canvas id="systemChart" width="400" height="150"></canvas>
        </div>
      </div>
    </div>

    <!-- Estado del sistema REAL -->
    <div class="widget">
      <div class="widget-header">
        <h3 class="widget-title">
          <span class="widget-icon">âš™ï¸</span>
          Estado del Sistema
        </h3>
        <div class="widget-actions">
          <span
            class="status-indicator {% if stats.api_status == 'online' %}status-online{% else %}status-offline{% endif %}"
            id="systemStatusIndicator">
            {% if stats.api_status == 'online' %}ğŸŸ¢{% else %}ğŸ”´{% endif %}
          </span>
        </div>
      </div>
      <div class="widget-content">
        <div class="system-stats">
          <div class="system-stat">
            <div class="stat-label">API Principal</div>
            <div class="stat-value">
              <span class="status-dot status-{{ stats.api_status or 'offline' }}"></span>
              <span id="apiStatusText">{{ stats.api_status|title or 'Offline' }}</span>
            </div>
          </div>
          <div class="system-stat">
            <div class="stat-label">Base de Datos</div>
            <div class="stat-value">
              <span class="status-dot status-online"></span>
              <span id="dbStatus">Conectada</span>
            </div>
          </div>
          <div class="system-stat">
            <div class="stat-label">Usuarios en DB</div>
            <div class="stat-value">
              <span class="status-dot status-online"></span>
              <span id="dbUsersCount">{{ stats.users_count or 'N/A' }}</span>
            </div>
          </div>
          <div class="system-stat">
            <div class="stat-label">Ãšltima actualizaciÃ³n</div>
            <div class="stat-value">
              <span class="status-dot status-online"></span>
              <span id="lastUpdate">{{ now.strftime('%H:%M:%S') if now else 'N/A' }}</span>
            </div>
          </div>
        </div>
        <div class="widget-footer">
          <button class="btn-secondary" onclick="runSystemDiagnostics()">
            <span>ğŸ”</span> DiagnÃ³stico
          </button>
          <button class="btn-secondary" onclick="refreshAllData()">
            <span>ğŸ”„</span> Actualizar
          </button>
        </div>
      </div>
    </div>

    <!-- Acciones rÃ¡pidas -->
    <div class="widget">
      <div class="widget-header">
        <h3 class="widget-title">
          <span class="widget-icon">âš¡</span>
          Acciones RÃ¡pidas
        </h3>
      </div>
      <div class="widget-content">
        <div class="quick-actions">
          <a href="{{ url_for('users.user_list') }}" class="quick-action">
            <div class="action-icon">ğŸ‘¥</div>
            <div class="action-content">
              <div class="action-title">Gestionar Usuarios</div>
              <div class="action-description">Ver y administrar cuentas</div>
            </div>
            <div class="action-arrow">â†’</div>
          </a>

          <a href="{{ url_for('memory_cards.card_list') }}" class="quick-action">
            <div class="action-icon">ğŸ—ƒï¸</div>
            <div class="action-content">
              <div class="action-title">Memory Cards</div>
              <div class="action-description">Crear y editar tarjetas</div>
            </div>
            <div class="action-arrow">â†’</div>
          </a>

          <a href="{{ url_for('auth.setup_mfa') }}" class="quick-action">
            <div class="action-icon">ğŸ›¡ï¸</div>
            <div class="action-content">
              <div class="action-title">Configurar MFA</div>
              <div class="action-description">AutenticaciÃ³n de dos factores</div>
            </div>
            <div class="action-arrow">â†’</div>
          </a>

          <button class="quick-action" onclick="exportData()">
            <div class="action-icon">ğŸ“¥</div>
            <div class="action-content">
              <div class="action-title">Exportar Datos</div>
              <div class="action-description">Descargar respaldo</div>
            </div>
            <div class="action-arrow">â†’</div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Logs del sistema en tiempo real -->
  <div class="full-width-widget">
    <div class="widget">
      <div class="widget-header">
        <h3 class="widget-title">
          <span class="widget-icon">ğŸ³</span>
          Logs de Contenedores Docker - Tiempo Real
        </h3>
        <div class="widget-actions">
          <div class="log-controls">
            <div class="log-controls-top">
              <span class="log-stats">
                <span class="stat-item">
                  <span class="stat-label">Total:</span>
                  <span class="stat-value" id="logsCount">0</span>
                </span>
                <span class="stat-item">
                  <span class="stat-label">INFO:</span>
                  <span class="stat-value info-count" id="infoCount">0</span>
                </span>
                <span class="stat-item">
                  <span class="stat-label">WARN:</span>
                  <span class="stat-value warning-count" id="warningCount">0</span>
                </span>
                <span class="stat-item">
                  <span class="stat-label">ERROR:</span>
                  <span class="stat-value error-count" id="errorCount">0</span>
                </span>
              </span>
            </div>
          </div>
        </div>
      </div>
      <div class="widget-content">
        <div class="logs-container" id="logsContainer">
          <div class="log-entry log-info">
            <span class="log-time">--:--:--</span>
            <span class="log-container">system</span>
            <span class="log-level">INFO</span>
            <span class="log-message">Inicializando sistema de logs Docker...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Inicializar dashboard con datos reales
  document.addEventListener('DOMContentLoaded', function () {
    initializeRealTimeUpdates();
    loadRealData();
  });

  function initializeRealTimeUpdates() {
    // Actualizar cada 30 segundos
    setInterval(loadRealData, 30000);

    // Actualizar hora actual cada segundo
    setInterval(updateCurrentTime, 1000);
  }

  function loadRealData() {
    fetch('http://localhost:5000/api/dashboard/stats')    // URL CORREGIDA
      .then(response => response.json())
      .then(data => {
        updateDashboardData(data);
      })
      .catch(error => {
        console.error('Error loading real data:', error);
        addLog('ERROR', 'Error cargando datos del dashboard');
      });
  }

  function updateDashboardData(data) {
    // Actualizar mÃ©tricas
    if (data.total_users !== undefined) {
      document.getElementById('totalUsers').textContent = data.total_users;
      document.getElementById('summaryUsers').textContent = data.total_users;
    }

    if (data.active_users !== undefined) {
      document.getElementById('activeUsers').textContent = data.active_users;
    }

    if (data.total_cards !== undefined) {
      document.getElementById('totalCards').textContent = data.total_cards;
      document.getElementById('summaryCards').textContent = data.total_cards;
    }

    // Actualizar estado API
    const apiStatusElement = document.getElementById('apiStatus');
    const apiStatusText = document.getElementById('apiStatusText');
    const apiTrend = document.getElementById('apiTrend');
    const systemStatusIndicator = document.getElementById('systemStatusIndicator');

    if (data.api_status) {
      const isOnline = data.api_status === 'online';
      apiStatusElement.textContent = isOnline ? 'Online' : 'Offline';
      apiStatusElement.className = `metric-value api-status-value ${isOnline ? 'online' : 'offline'}`;
      apiStatusText.textContent = isOnline ? 'Online' : 'Offline';
      systemStatusIndicator.textContent = isOnline ? 'ğŸŸ¢' : 'ğŸ”´';
      systemStatusIndicator.className = `status-indicator ${isOnline ? 'status-online' : 'status-offline'}`;

      apiTrend.innerHTML = isOnline ?
        '<span class="trend-icon">âœ…</span><span class="trend-value">Online</span>' :
        '<span class="trend-icon">âŒ</span><span class="trend-value">Offline</span>';
    }

    // âœ… ACTUALIZAR TREND VALUES - SOLUCION AGREGADA
    const usersTrend = document.querySelector('#usersTrend .trend-value');
    const activeTrend = document.querySelector('#activeTrend .trend-value');
    const cardsTrend = document.querySelector('#cardsTrend .trend-value');
    
    if (usersTrend) usersTrend.textContent = `${data.total_users || 0} usuarios`;
    if (activeTrend) activeTrend.textContent = `${data.active_users || 0} activos`;
    if (cardsTrend) cardsTrend.textContent = `${data.total_cards || 0} tarjetas`;
    
    console.log('âœ… Trend values actualizados desde HTML inline');

    // Actualizar actividad
    if (data.recent_activity && data.recent_activity.length > 0) {
      updateActivityList(data.recent_activity);
    }

    // Agregar log de actualizaciÃ³n
    addLog('INFO', 'Datos del dashboard actualizados');
  }

  function updateActivityList(activities) {
    const activityList = document.getElementById('activityList');
    activityList.innerHTML = '';

    activities.forEach(activity => {
      const activityItem = document.createElement('div');
      activityItem.className = 'activity-item';
      activityItem.innerHTML = `
                <div class="activity-icon">${activity.icon}</div>
                <div class="activity-content">
                    <div class="activity-text">${activity.text}</div>
                    <div class="activity-time">${activity.time}</div>
                </div>
            `;
      activityList.appendChild(activityItem);
    });
  }

  function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toTimeString().split(' ')[0];
    const lastUpdateElement = document.getElementById('lastUpdate');
    if (lastUpdateElement) {
      lastUpdateElement.textContent = timeString;
    }
  }

  function addLog(level, message) {
    const logsContainer = document.getElementById('logsContainer');
    const now = new Date();
    const timeString = now.toTimeString().split(' ')[0];

    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${level.toLowerCase()}`;
    logEntry.innerHTML = `
            <span class="log-time">${timeString}</span>
            <span class="log-level">${level}</span>
            <span class="log-message">${message}</span>
        `;

    logsContainer.insertBefore(logEntry, logsContainer.firstChild);

    // Mantener mÃ¡ximo 50 logs
    if (logsContainer.children.length > 50) {
      logsContainer.removeChild(logsContainer.lastChild);
    }
  }

  // Funciones globales para los botones
  function refreshAllData() {
    addLog('INFO', 'Actualizando todos los datos...');
    loadRealData();
  }

  function checkApiHealth() {
    addLog('INFO', 'Verificando salud de la API...');
    fetch('http://localhost:5000/api/dashboard/health')    // URL CORREGIDA
      .then(response => response.json())
      .then(data => {
        if (data.ok) {
          addLog('SUCCESS', 'API saludable y funcionando');
        } else {
          addLog('ERROR', 'API no responde correctamente');
        }
      });
  }
</script>
{% endblock %}