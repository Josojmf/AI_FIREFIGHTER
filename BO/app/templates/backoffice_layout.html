<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Backoffice Â· FirefighterAI{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  {# CSS base del layout + backoffice global #}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/backoffice.css') }}">

  {# CSS especÃ­fico de cada pÃ¡gina (dashboard, etc.) #}
  {% block styles %}{% endblock %}
</head>
<body>
  <div class="layout{% if request.endpoint == 'auth.login' %} login-layout{% endif %}">
    {% if current_user.is_authenticated %}
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <div class="brand-icon">ğŸš’</div>
          <div class="brand-text">FirefighterAI</div>
          <div class="brand-subtitle">Backoffice</div>
        </div>
        <button class="sidebar-toggle" type="button" id="sidebarToggle">
          <span class="toggle-icon">âŸ·</span>
        </button>
      </div>

      <nav class="sidebar-nav">
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="{{ url_for('dashboard.index') }}"
               class="nav-link{% if request.endpoint and request.endpoint.startswith('dashboard') %} active{% endif %}">
              <span class="nav-icon">ğŸ </span>
              <span class="nav-text">Dashboard</span>
            </a>
          </li>

          <li class="nav-item">
            <a href="{{ url_for('users.user_list') }}"
               class="nav-link{% if request.endpoint and request.endpoint.startswith('users') %} active{% endif %}">
              <span class="nav-icon">ğŸ‘¥</span>
              <span class="nav-text">Usuarios</span>
            </a>
          </li>

          <li class="nav-item">
            <a href="{{ url_for('memory_cards.card_list') }}"
               class="nav-link{% if request.endpoint and request.endpoint.startswith('memory_cards') %} active{% endif %}">
              <span class="nav-icon">ğŸ§ </span>
              <span class="nav-text">Memory Cards</span>
            </a>
          </li>

          {# AÃ±adir aquÃ­ nuevos enlaces SOLO cuando tengas esos endpoints creados #}
          {#
          <li class="nav-item">
            <a href="{{ url_for('dashboard.metrics') }}"
               class="nav-link{% if request.endpoint == 'dashboard.metrics' %} active{% endif %}">
              <span class="nav-icon">ğŸ“Š</span>
              <span class="nav-text">MÃ©tricas</span>
            </a>
          </li>
          #}
        </ul>
      </nav>

      <div class="sidebar-user">
        <div class="user-avatar">
          {{ (current_user.username or current_user.email or 'A')[:1] | upper }}
        </div>
        <div class="user-info">
          <div class="user-name">{{ current_user.username or current_user.email }}</div>
          <div class="user-role">Admin</div>
        </div>
        <div class="user-actions">
          {# Enlace temporal al dashboard hasta que se implemente auth.profile #}
          <a href="{{ url_for('dashboard.index') }}" class="user-action" title="Dashboard">ğŸ </a>
          <a href="{{ url_for('auth.logout') }}" class="user-action" title="Salir">â»</a>
        </div>
      </div>
    </aside>
    {% endif %}

    <div class="main-content">
      {% if current_user.is_authenticated %}
      <header class="top-header">
        <div class="header-left">
          <button class="mobile-menu-toggle" type="button" id="mobileMenuToggle">
            <span class="hamburger"></span>
            <span class="hamburger"></span>
            <span class="hamburger"></span>
          </button>
          <h1 class="page-title">
            {% block page_title %}Backoffice{% endblock %}
          </h1>
        </div>
        <div class="header-right">
          <div class="header-actions">
            <button class="header-btn" type="button" title="Notificaciones">ğŸ””</button>
          </div>

          <div class="user-menu" id="userMenu">
            <button class="user-menu-trigger" type="button" id="userMenuTrigger">
              <div class="user-avatar-sm">
                {{ (current_user.username or current_user.email or 'A')[:1] | upper }}
              </div>
              <span class="user-name-sm">{{ current_user.username or current_user.email }}</span>
              <span class="dropdown-arrow">â–¾</span>
            </button>
            <div class="user-menu-dropdown" id="userMenuDropdown">
              <div class="user-menu-header">
                <div class="user-avatar-sm">
                  {{ (current_user.username or current_user.email or 'A')[:1] | upper }}
                </div>
                <div class="user-details">
                  <div class="user-name-sm">{{ current_user.username or current_user.email }}</div>
                  <div class="user-email">{{ current_user.email }}</div>
                </div>
              </div>
              <div class="user-menu-actions">
                {# Enlace temporal al dashboard hasta que se implemente auth.profile #}
                <a href="{{ url_for('dashboard.index') }}" class="user-menu-item">
                  <span>ğŸ </span>
                  <span>Dashboard</span>
                </a>
                {# Comentado temporalmente hasta que se implementen #}
                {#
                <a href="{{ url_for('auth.setup_mfa') }}" class="user-menu-item">
                  <span>ğŸ”</span>
                  <span>Configurar MFA</span>
                </a>
                #}
                <a href="{{ url_for('auth.logout') }}" class="user-menu-item logout">
                  <span>â»</span>
                  <span>Cerrar sesiÃ³n</span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="mobile-overlay" id="mobileOverlay"></div>
      {% endif %}

      <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="flash flash-{{ category }}">
                <div class="flash-icon">
                  {% if category == 'error' %}âŒ
                  {% elif category == 'warning' %}âš ï¸
                  {% elif category == 'success' %}âœ…
                  {% else %}â„¹ï¸{% endif %}
                </div>
                <div class="flash-content">
                  {{ message }}
                </div>
                <button class="flash-close" type="button" onclick="this.parentElement.remove()">âœ•</button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      </div>

      <main class="page-content">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebarToggle');
      const mobileToggle = document.getElementById('mobileMenuToggle');
      const mobileOverlay = document.getElementById('mobileOverlay');
      const userMenu = document.getElementById('userMenu');
      const userMenuTrigger = document.getElementById('userMenuTrigger');
      const userMenuDropdown = document.getElementById('userMenuDropdown');

      if (sidebar && sidebarToggle) {
        sidebarToggle.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
          document.body.classList.toggle('sidebar-collapsed');
        });
      }

      if (sidebar && mobileToggle && mobileOverlay) {
        const closeMobileMenu = () => {
          sidebar.classList.remove('mobile-open');
          mobileOverlay.classList.remove('active');
        };

        mobileToggle.addEventListener('click', () => {
          sidebar.classList.toggle('mobile-open');
          mobileOverlay.classList.toggle('active');
        });

        mobileOverlay.addEventListener('click', closeMobileMenu);
      }

      if (userMenu && userMenuTrigger && userMenuDropdown) {
        const toggleMenu = () => {
          userMenu.classList.toggle('active');
          userMenuDropdown.classList.toggle('show');
        };

        userMenuTrigger.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleMenu();
        });

        document.addEventListener('click', (e) => {
          if (!userMenu.contains(e.target)) {
            userMenu.classList.remove('active');
            userMenuDropdown.classList.remove('show');
          }
        });
      }
    });
  </script>
</body>
</html>