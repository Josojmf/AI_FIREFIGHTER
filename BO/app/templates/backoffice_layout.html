<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>{% block title %}Onfire AI BackOffice{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  {# CSS base del layout + backoffice global #}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">

  {# CSS espec√≠fico de login/MFA #}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">

  {# CSS espec√≠fico de cada p√°gina (dashboard, MFA, etc.) #}
  {% block styles %}{% endblock %}
</head>

<body class="{% block body_class %}{% endblock %}" data-api-base-url="{{ api_base_url }}">
  <div class="layout {% block layout_class %}{% endblock %}">

    {# SIDEBAR - Solo visible cuando est√° logueado #}
    {% if current_user.is_authenticated %}
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <div class="brand-icon">üî•</div>
          <div class="brand-text">Onfire AI</div>
          <div class="brand-subtitle">BackOffice</div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <ul class="nav-menu">
          {# ========== SECCI√ìN PRINCIPAL ========== #}
          <li class="nav-section">Panel Principal</li>

          <li class="nav-item">
            <a href="/dashboard"
              class="nav-link {% if request.endpoint and request.endpoint.startswith('dashboard') %}active{% endif %}">
              <span class="nav-icon">üìä</span>
              <span class="nav-text">Dashboard</span>
            </a>
          </li>

          {# ========== GESTI√ìN DE USUARIOS ========== #}
          <li class="nav-section">Gesti√≥n de Usuarios</li>

          <li class="nav-item">
            <a href="/users"
              class="nav-link {% if request.endpoint and request.endpoint.startswith('users') %}active{% endif %}">
              <span class="nav-icon">üë•</span>
              <span class="nav-text">Usuarios</span>
            </a>
          </li>

          <li class="nav-item">
            <a href="/access_tokens"
              class="nav-link {% if request.endpoint and request.endpoint.startswith('access_tokens') %}active{% endif %}">
              <span class="nav-icon">üé´</span>
              <span class="nav-text">Tokens de Acceso</span>
            </a>
          </li>

          {# ========== CONTENIDO EDUCATIVO ========== #}
          <li class="nav-section">Contenido</li>

          <li class="nav-item">
            <a href="/memory-cards"
              class="nav-link {% if request.endpoint and request.endpoint.startswith('memory_cards') %}active{% endif %}">
              <span class="nav-icon">üß†</span>
              <span class="nav-text">Memory Cards</span>
            </a>
          </li>

          {# ========== SISTEMA Y SEGURIDAD ========== #}
          <li class="nav-section">Sistema</li>

          <li class="nav-item">
            <a href="/health" class="nav-link {% if request.endpoint == 'health' %}active{% endif %}">
              <span class="nav-icon">üíì</span>
              <span class="nav-text">API Health</span>
            </a>
          </li>

          <li class="nav-item">
            <a href="/auth/setup-mfa" class="nav-link {% if request.endpoint == 'auth.setup_mfa' %}active{% endif %}">
              <span class="nav-icon">üõ°Ô∏è</span>
              <span class="nav-text">Configurar MFA</span>
            </a>
          </li>

          {# ========== HERRAMIENTAS ADMIN ========== #}
          <li class="nav-section">Administraci√≥n</li>

          <li class="nav-item">
            <a href="/access_tokens/test-api-connection"
              class="nav-link {% if request.endpoint == 'access_tokens.test_api_connection' %}active{% endif %}">
              <span class="nav-icon">üîß</span>
              <span class="nav-text">Test API</span>
            </a>
          </li>
        </ul>
      </nav>

      {# USER INFO EN SIDEBAR #}
      <div class="sidebar-user">
        <div class="user-avatar">
          {{ (current_user.username[0] if current_user.is_authenticated else 'U')|upper }}
        </div>
        <div class="user-info">
          <div class="user-name">
            {% if current_user.is_authenticated %}
            {{ current_user.username }}
            {% else %}
            Invitado
            {% endif %}
          </div>
          <div class="user-role">
            {% if current_user.is_authenticated %}
            {{ current_user.role or 'ADMIN' }}
            {% else %}
            No autenticado
            {% endif %}
          </div>
        </div>
        <div class="user-actions">
          {% if current_user.is_authenticated %}
          <a href="/auth/logout" class="user-action" title="Cerrar sesi√≥n">
            ‚èè
          </a>
          {% endif %}
        </div>
      </div>
    </aside>
    {% endif %}

    {# MAIN CONTENT #}
    <div class="main-content">

      {# HEADER SUPERIOR - Solo visible cuando est√° logueado #}
      {% if current_user.is_authenticated %}
      <header class="top-header">
        <div class="header-left">
          <button id="mobileMenuToggle" class="mobile-menu-toggle" type="button">
            <span class="hamburger"></span>
            <span class="hamburger"></span>
            <span class="hamburger"></span>
          </button>
          <h1 class="page-title">
            {% block page_title %}Dashboard{% endblock %}
          </h1>
        </div>
        <div class="header-right">
          <div class="header-actions">
            <button class="header-btn" type="button" title="Notificaciones">
              üîî
            </button>
            <button class="header-btn" type="button" title="Configuraci√≥n r√°pida">
              ‚öôÔ∏è
            </button>
          </div>
          <div class="user-menu">
            <button class="user-menu-toggle user-menu-trigger" type="button">
              <div class="user-avatar-sm">
                {{ current_user.username[0]|upper }}
              </div>
              <span class="user-name-sm">{{ current_user.username }}</span>
              <span class="dropdown-arrow">‚ñæ</span>
            </button>
            <div id="userMenuDropdown" class="user-menu-dropdown">
              <div class="user-menu-header">
                <div class="user-avatar-sm">
                  {{ current_user.username[0]|upper }}
                </div>
                <div class="user-details">
                  <div class="user-name-sm">{{ current_user.username }}</div>
                  <div class="user-email">{{ current_user.email or current_user.username + '@onfire.ai' }}</div>
                </div>
              </div>
              <div class="user-menu-items">
                <a href="/auth/setup-mfa" class="user-menu-item">
                  <span class="menu-icon">üõ°Ô∏è</span>
                  <span>Configurar MFA</span>
                </a>
                <a href="/profile" class="user-menu-item">
                  <span class="menu-icon">üë§</span>
                  <span>Mi Perfil</span>
                </a>
                <hr class="menu-divider">
                <a href="/auth/logout" class="user-menu-item logout">
                  <span class="menu-icon">‚èè</span>
                  <span>Cerrar Sesi√≥n</span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </header>
      {% endif %}

      {# FLASH MESSAGES GLOBALES #}
      <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, msg in messages %}
        <div class="flash flash-{{ category }}">
          <div class="flash-content">{{ msg }}</div>
          <button class="flash-close" onclick="this.parentElement.remove()">√ó</button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}
      </div>

      {# CONTENIDO DE LA P√ÅGINA #}
      <main class="page-content">
        {% block content %}
        {# Contenido por defecto si no hay contenido espec√≠fico #}
        <div class="default-content">
          <h2>Bienvenido al BackOffice de Onfire AI</h2>
          <p>Selecciona una opci√≥n del men√∫ lateral para comenzar.</p>

          {% if current_user.is_authenticated %}
          <div style="margin-top: 2rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px;">
            <h3>Enlaces r√°pidos:</h3>
            <ul>
              <li><a href="/dashboard">üìä Dashboard</a></li>
              <li><a href="/users">üë• Usuarios</a></li>
              <li><a href="/access_tokens">üé´ Tokens de Acceso</a></li>
              <li><a href="/memory-cards">üß† Memory Cards</a></li>
            </ul>
          </div>
          {% endif %}
        </div>
        {% endblock %}
      </main>
    </div>
  </div>

  {# OVERLAY m√≥vil #}
  <div id="mobileOverlay" class="mobile-overlay"></div>

  {# JS global backoffice #}
  <script>
    window.API_BASE_URL = "{{ api_base_url }}";

    // Funcionalidad b√°sica del sidebar
    document.addEventListener('DOMContentLoaded', function () {
      // Toggle sidebar
      const sidebarToggle = document.getElementById('sidebarToggle');
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');

      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function () {
          sidebar.classList.toggle('collapsed');
        });
      }

      if (mobileMenuToggle) {
        mobileMenuToggle.addEventListener('click', function () {
          sidebar.classList.toggle('mobile-open');
          overlay.classList.toggle('active');
        });
      }

      if (overlay) {
        overlay.addEventListener('click', function () {
          sidebar.classList.remove('mobile-open');
          overlay.classList.remove('active');
        });
      }

      // User menu dropdown
      const userMenuTrigger = document.querySelector('.user-menu-trigger');
      const userMenuDropdown = document.getElementById('userMenuDropdown');

      if (userMenuTrigger && userMenuDropdown) {
        userMenuTrigger.addEventListener('click', function (e) {
          e.stopPropagation();
          userMenuDropdown.classList.toggle('active');
        });

        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', function () {
          userMenuDropdown.classList.remove('active');
        });
      }

      // Auto-cerrar flash messages despu√©s de 5 segundos
      const flashMessages = document.querySelectorAll('.flash');
      flashMessages.forEach(function (flash) {
        if (!flash.classList.contains('flash-error')) { // No auto-cerrar errores
          setTimeout(function () {
            flash.style.opacity = '0';
            setTimeout(function () {
              flash.remove();
            }, 300);
          }, 5000);
        }
      });
    });
  </script>
  <script src="{{ url_for('static', filename='js/backoffice.js') }}"></script>

  {# JS espec√≠fico de cada p√°gina (login, MFA, dashboard, etc.) #}
  {% block scripts %}{% endblock %}
</body>

</html>