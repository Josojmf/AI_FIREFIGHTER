{% extends "backoffice_layout.html" %}

{% block title %}Onfire AI | Verificaci√≥n MFA{% endblock %}
{% block page_title %}{% endblock %}
{% block body_class %}login-page login-layout{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
<style>
.mfa-container {
  background: var(--gradient-card);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: var(--border-radius-lg);
  padding: 3rem 2.5rem;
  width: 100%;
  box-shadow: var(--box-shadow-lg);
  backdrop-filter: blur(20px);
  position: relative;
  overflow: hidden;
  animation: fadeInUp 0.6s ease;
}
.mfa-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gradient-brand);
}
.mfa-header {
  text-align: center;
  margin-bottom: 2.5rem;
}
.mfa-brand {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
}
.mfa-brand-icon {
  font-size: 3.5rem;
  filter: drop-shadow(0 0 15px rgba(245, 158, 11, 0.5));
}
.mfa-title {
  font-size: 1.75rem;
  font-weight: 800;
  background: var(--gradient-brand);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}
.mfa-subtitle {
  color: var(--text-secondary);
  font-size: 0.95rem;
  margin: 0;
}
.mfa-flash-messages { margin-bottom: 1.5rem; }

.mfa-form { margin-bottom: 1.5rem; }

.mfa-code-label {
  text-align: center;
  margin-bottom: 0.75rem;
  font-weight: 500;
  color: var(--text-primary);
  font-size: 0.9rem;
}
.mfa-boxes-container {
  display: flex;
  justify-content: center;
  gap: 0.75rem;
}
.mfa-input {
  width: 2.75rem;
  height: 2.75rem;
  text-align: center;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(255, 255, 255, 0.1);
  border-radius: var(--border-radius-sm);
  color: var(--text-primary);
  font-size: 1.25rem;
  font-family: 'Consolas','Monaco','Courier New',monospace;
  transition: var(--transition-fast);
}
.mfa-input:focus {
  outline: none;
  border-color: var(--text-accent);
  background: rgba(255, 255, 255, 0.08);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
.mfa-input.filled {
  border-color: var(--success);
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
}
.mfa-timer {
  text-align: center;
  margin: 1.25rem 0 1.75rem;
  padding: 0.75rem 1rem;
  background: rgba(255, 255, 255, 0.05);
  border-radius: var(--border-radius-sm);
  border: 1px solid rgba(255, 255, 255, 0.1);
  font-size: 0.85rem;
  color: var(--text-secondary);
}
.mfa-timer-value {
  margin-left: 0.3rem;
  font-weight: 600;
  color: var(--text-accent);
}
.btn[disabled] {
  background: var(--bg-tertiary);
  color: var(--text-muted);
  cursor: not-allowed;
  opacity: 0.6;
}
</style>
{% endblock %}

{% block content %}
<div class="login-container mfa-container">
  <div class="mfa-header">
    <div class="mfa-brand">
      <div class="mfa-brand-icon">üõ°Ô∏è</div>
      <div class="mfa-title">Verificaci√≥n de Seguridad</div>
    </div>
    <p class="mfa-subtitle">
      Hola <strong>{{ username }}</strong>, ingresa el c√≥digo de 6 d√≠gitos de tu Microsoft Authenticator.
    </p>
  </div>

  <div class="mfa-flash-messages">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash {{ category }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if attempts > 0 %}
      <div class="flash flash-warning">
        Intentos fallidos: {{ attempts }}/5
      </div>
    {% endif %}
  </div>

  <form method="POST" id="mfaForm" class="mfa-form" autocomplete="off" novalidate>
    <div class="form-group">
      <label class="mfa-code-label">C√≥digo MFA de 6 d√≠gitos</label>

      <div class="mfa-boxes-container" id="mfaBoxes">
        {% for i in range(6) %}
        <input
          type="text"
          class="mfa-input"
          maxlength="1"
          inputmode="numeric"
          pattern="[0-9]*"
          data-index="{{ i }}"
        >
        {% endfor %}
      </div>

      <input type="hidden" name="mfa_code" id="mfaCodeHidden">
    </div>

    <div class="mfa-timer">
      Tiempo restante:
      <span class="mfa-timer-value" id="timeRemaining">30:00</span>
    </div>

    <button type="submit" id="verifyBtn" class="btn btn-primary" disabled>
      <span class="btn-icon"></span>
      <span>Verificar C√≥digo</span>
    </button>
  </form>

  <div class="login-footer">
    <p class="login-help">
      ¬øProblemas para acceder?
      <a href="{{ url_for('auth.mfa_recovery') }}" class="login-link">Recuperar acceso</a>
      ¬∑
      <a href="{{ url_for('auth.login') }}" class="login-link">Volver al login</a>
    </p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isSubmitting = false;

function getEls() {
  return {
    inputs: Array.from(document.querySelectorAll('.mfa-input')),
    hidden: document.getElementById('mfaCodeHidden'),
    button: document.getElementById('verifyBtn'),
    form: document.getElementById('mfaForm'),
  };
}

function getCode() {
  const { inputs } = getEls();
  return inputs.map(i => i.value).join('');
}

function updateButtonState() {
  const { button, hidden, inputs } = getEls();
  console.log('inputs length:', inputs.length, 'button:', !!button, 'hidden:', !!hidden);

  if (!button || !hidden || inputs.length !== 6) return;

  const code = getCode();
  const complete = code.length === 6 && /^\d{6}$/.test(code);

  hidden.value = code;
  button.disabled = !complete || isSubmitting;

  console.log('CODE:', code, 'len:', code.length, 'btn.disabled:', button.disabled);
}

function moveFocus(index, dir) {
  const { inputs } = getEls();
  const next = index + dir;
  if (next >= 0 && next < inputs.length) {
    inputs[next].focus();
    inputs[next].select();
  }
}

function onInput(e) {
  const input = e.target;
  const index = parseInt(input.dataset.index, 10);
  let value = input.value.replace(/\D/g, '');
  if (value.length > 1) value = value[0];
  input.value = value;

  if (value && index < 5) {
    moveFocus(index, +1);
  }

  updateButtonState();
}

function onKeyDown(e) {
  const input = e.target;
  const index = parseInt(input.dataset.index, 10);

  if (e.key === 'Backspace') {
    if (!input.value && index > 0) {
      e.preventDefault();
      moveFocus(index, -1);
    }
    return;
  }

  if (e.key === 'ArrowLeft') { e.preventDefault(); moveFocus(index, -1); return; }
  if (e.key === 'ArrowRight') { e.preventDefault(); moveFocus(index, +1); return; }

  if (e.key === 'Tab') return;
  if (!/^[0-9]$/.test(e.key)) e.preventDefault();
}

function initMFA() {
  const { inputs, form } = getEls();
  console.log('initMFA, inputs:', inputs.length, 'form:', !!form);

  if (inputs.length !== 6 || !form) return;

  inputs.forEach((input, index) => {
    input.addEventListener('input', onInput);
    input.addEventListener('keydown', onKeyDown);
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    if (isSubmitting) return;
    const code = getCode();
    if (code.length !== 6 || !/^\d{6}$/.test(code)) return;
    isSubmitting = true;
    form.submit();
  });

  inputs[0].focus();
  updateButtonState();
}

document.addEventListener('DOMContentLoaded', initMFA);
</script>
{% endblock %}
