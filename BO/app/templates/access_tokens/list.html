{% extends "backoffice_layout.html" %}

{% block title %}Access Tokens - Onfire AI BackOffice{% endblock %}
{% block page_title %}Tokens de Acceso{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/access_tokens.css') }}">
{% endblock %}

{% block content %}
<div class="tokens-container">
  
  <!-- Header -->
  <div class="tokens-header">
    <div class="tokens-title">
      <span class="icon">üîë</span>
      <h1>Tokens de Acceso</h1>
    </div>
    <div class="tokens-actions">
      <button class="btn btn-secondary" onclick="refreshTokens()">
        <span>üîÑ</span>
        Actualizar
      </button>
      <a href="{{ url_for('access_tokens.create_token') }}" class="btn btn-primary">
        <span>‚ûï</span>
        Crear Token
      </a>
    </div>
  </div>

  <!-- Estad√≠sticas -->
  <div class="stats-grid" id="statsGrid">
    <div class="stat-card">
      <div class="stat-icon">üîë</div>
      <div class="stat-value" id="totalTokens">{{ tokens|length }}</div>
      <div class="stat-label">Total Tokens</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-value" id="activeTokens">{{ tokens|selectattr('status', 'equalto', 'active')|list|length }}</div>
      <div class="stat-label">Activos</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üö´</div>
      <div class="stat-value" id="revokedTokens">{{ tokens|selectattr('status', 'equalto', 'revoked')|list|length }}</div>
      <div class="stat-label">Revocados</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üìä</div>
      <div class="stat-value" id="totalUses">
        {% set total_uses = tokens|sum(attribute='current_uses') %}
        {{ total_uses if total_uses else 0 }}
      </div>
      <div class="stat-label">Total Usos</div>
    </div>
  </div>

  <!-- Tabla de tokens -->
  <div class="tokens-table-container">
    {% if tokens %}
    <table class="tokens-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Estado</th>
          <th>Usos</th>
          <th>Tipo Usuario</th>
          <th class="hidden-md">Creado</th>
          <th class="hidden-md">Expira</th>
          <th>Token</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for token in tokens %}
        <tr style="animation-delay: {{ loop.index0 * 0.1 }}s;">
          <td>
            <div>
              <div style="font-weight: 600; color: black">{{ token.name }}</div>
              {% if token.description %}
              <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                {{ token.description }}
              </div>
              {% endif %}
            </div>
          </td>
          <td>
            {% set status_class = 'active' %}
            {% if token.status == 'revoked' %}{% set status_class = 'revoked' %}
            {% elif token.current_uses >= token.max_uses %}{% set status_class = 'exhausted' %}
            {% endif %}
            <span class="token-status {{ status_class }}">
              {{ token.status|title if token.status else 'Active' }}
            </span>
          </td>
          <td>
            <div class="usage-container">
              <div class="usage-progress">
                {% set usage_percent = (token.current_uses / token.max_uses * 100) if token.max_uses > 0 else 0 %}
                {% set bar_class = '' %}
                {% if usage_percent >= 90 %}{% set bar_class = 'danger' %}
                {% elif usage_percent >= 70 %}{% set bar_class = 'warning' %}
                {% endif %}
                <div class="usage-progress-bar {{ bar_class }}" style="width: {{ usage_percent }}%;"></div>
              </div>
              <div class="usage-info">
                {{ token.current_uses or 0 }} / {{ token.max_uses }} usos
              </div>
            </div>
          </td>
          <td>
            <span class="token-badge">{{ token.user_type or 'student' }}</span>
          </td>
          <td class="hidden-md">
            <div class="token-badge">
              {% if token.created_at_formatted %}
                {{ token.created_at_formatted }}
              {% else %}
                {{ token.created_at[:10] if token.created_at else 'N/A' }}
              {% endif %}
            </div>
            {% if token.created_by %}
            <div style="font-size: 0.75rem; color: #6b7280;">
              por {{ token.created_by }}
            </div>
            {% endif %}
          </td>
          <td class="hidden-md">
            <div class="token-badge">
              {% if token.expires_at_formatted %}
                {{ token.expires_at_formatted }}
              {% else %}
                {{ token.expires_at[:10] if token.expires_at else 'N/A' }}
              {% endif %}
            </div>
          </td>
          <td>
            <div class="token-display" onclick="copyToClipboard('{{ token.token }}')" title="Click para copiar">
              <span class="token-text">{{ token.token[:12] }}...</span>
              <span class="copy-icon">üìã</span>
            </div>
          </td>
          <td>
            <div class="token-actions">
              <a href="{{ url_for('access_tokens.edit_token', token_id=token._id) }}" 
                 class="btn btn-sm btn-secondary" title="Editar">
                ‚úèÔ∏è
              </a>
              
              {% if token.status != 'revoked' %}
              <button onclick="confirmAction('revoke', '{{ token._id }}', '{{ token.name }}')" 
                      class="btn btn-sm btn-warning" title="Revocar">
                üö´
              </button>
              {% else %}
              <button onclick="confirmAction('reactivate', '{{ token._id }}', '{{ token.name }}')" 
                      class="btn btn-sm btn-success" title="Reactivar">
                ‚úÖ
              </button>
              {% endif %}
              
              {% if token.current_uses > 0 %}
              <button onclick="confirmAction('reset', '{{ token._id }}', '{{ token.name }}')" 
                      class="btn btn-sm btn-secondary" title="Reiniciar usos">
                üîÑ
              </button>
              {% endif %}
              
              <button onclick="confirmAction('delete', '{{ token._id }}', '{{ token.name }}')" 
                      class="btn btn-sm btn-danger" title="Eliminar">
                üóëÔ∏è
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty-state">
      <div class="icon">üîë</div>
      <h3>No hay tokens de acceso</h3>
      <p>Crea tu primer token para permitir el registro de nuevos usuarios</p>
      <a href="{{ url_for('access_tokens.create_token') }}" class="btn btn-primary">
        <span>‚ûï</span>
        Crear Primer Token
      </a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Modal de confirmaci√≥n -->
<div id="confirmModal" class="modal" style="display: none;">
  <div class="modal-backdrop" onclick="closeModal()"></div>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="confirmTitle">Confirmar Acci√≥n</h3>
      </div>
      <div class="modal-body">
        <p id="confirmMessage">¬øEst√°s seguro de realizar esta acci√≥n?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        <button type="button" id="confirmButton" class="btn btn-danger" onclick="executeAction()">Confirmar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// JavaScript unificado para todas las p√°ginas de tokens
let currentAction = null;
let currentTokenId = null;
let currentTokenName = null;

function refreshTokens() {
  const refreshBtn = document.querySelector('.btn-secondary');
  refreshBtn.classList.add('loading');
  
  setTimeout(() => {
    window.location.reload();
  }, 500);
}

function copyToClipboard(text) {
  // M√©todo 1: Usando navigator.clipboard (moderno)
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(() => {
      showNotification('‚úÖ Token copiado al portapapeles');
    }).catch(() => {
      fallbackCopyToClipboard(text);
    });
  } else {
    fallbackCopyToClipboard(text);
  }
}

function fallbackCopyToClipboard(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.left = '-999999px';
  textArea.style.top = '-999999px';
  textArea.style.opacity = '0';
  
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    const successful = document.execCommand('copy');
    document.body.removeChild(textArea);
    
    if (successful) {
      showNotification('‚úÖ Token copiado al portapapeles');
    } else {
      showNotification('‚ùå Error al copiar, intente manualmente', true);
    }
  } catch (err) {
    document.body.removeChild(textArea);
    showCopyPrompt(text);
  }
}

function showCopyPrompt(text) {
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    background: white;
    padding: 2rem;
    border-radius: 0.5rem;
    max-width: 500px;
    width: 90%;
    text-align: center;
  `;
  
  modal.innerHTML = `
    <h3 style="margin-bottom: 1rem; color: #1f2937;">Copiar Token</h3>
    <p style="margin-bottom: 1.5rem; color: #6b7280;">Selecciona el token y c√≥pialo manualmente:</p>
    <textarea 
      style="
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.375rem;
        font-family: monospace;
        resize: none;
        background: #f9fafb;
        margin-bottom: 1.5rem;
      "
      rows="4"
      readonly
    >${text}</textarea>
    <button onclick="this.closest('.copy-overlay').remove()" style="
      background: #3b82f6;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: 600;
    ">
      Cerrar
    </button>
  `;
  
  overlay.className = 'copy-overlay';
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  
  // Seleccionar autom√°ticamente el texto
  const textarea = overlay.querySelector('textarea');
  textarea.select();
}

function showNotification(message, isError = false) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${isError ? '#ef4444' : '#10b981'};
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 0.5rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    font-weight: 600;
    animation: slideInRight 0.3s ease-out;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'fadeOut 0.3s ease-out';
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, 2000);
}

function confirmAction(action, tokenId, tokenName) {
  currentAction = action;
  currentTokenId = tokenId;
  currentTokenName = tokenName;
  
  const modal = document.getElementById('confirmModal');
  const title = document.getElementById('confirmTitle');
  const message = document.getElementById('confirmMessage');
  const button = document.getElementById('confirmButton');
  
  // A√±adir efecto de vibraci√≥n al bot√≥n presionado
  const clickedButton = event.target.closest('.btn');
  if (clickedButton) {
    clickedButton.style.transform = 'scale(0.95)';
    setTimeout(() => {
      clickedButton.style.transform = '';
    }, 150);
  }
  
  switch(action) {
    case 'revoke':
      title.textContent = 'Revocar Token';
      message.textContent = `¬øEst√°s seguro de revocar el token "${tokenName}"? Los usuarios no podr√°n usarlo para registrarse.`;
      button.textContent = 'Revocar';
      button.className = 'btn btn-warning';
      break;
    case 'reactivate':
      title.textContent = 'Reactivar Token';
      message.textContent = `¬øEst√°s seguro de reactivar el token "${tokenName}"?`;
      button.textContent = 'Reactivar';
      button.className = 'btn btn-success';
      break;
    case 'reset':
      title.textContent = 'Reiniciar Usos';
      message.textContent = `¬øEst√°s seguro de reiniciar el contador de usos del token "${tokenName}" a 0?`;
      button.textContent = 'Reiniciar';
      button.className = 'btn btn-secondary';
      break;
    case 'delete':
      title.textContent = 'Eliminar Token';
      message.textContent = `¬øEst√°s seguro de eliminar permanentemente el token "${tokenName}"? Esta acci√≥n no se puede deshacer.`;
      button.textContent = 'Eliminar';
      button.className = 'btn btn-danger';
      break;
  }
  
  modal.style.display = 'block';
}

function closeModal() {
  const modal = document.getElementById('confirmModal');
  modal.style.animation = 'fadeOut 0.3s ease-out';
  setTimeout(() => {
    modal.style.display = 'none';
    modal.style.animation = '';
  }, 300);
  currentAction = null;
  currentTokenId = null;
  currentTokenName = null;
}

function executeAction() {
  if (!currentAction || !currentTokenId) {
    closeModal();
    return;
  }
  
  const confirmButton = document.getElementById('confirmButton');
  const originalText = confirmButton.textContent;
  confirmButton.textContent = 'Procesando...';
  confirmButton.disabled = true;
  confirmButton.classList.add('loading');
  
  setTimeout(() => {
    const form = document.createElement('form');
    form.method = 'POST';
    
    switch(currentAction) {
      case 'revoke':
        form.action = `{{ url_for('access_tokens.revoke_token', token_id='TOKEN_ID') }}`.replace('TOKEN_ID', currentTokenId);
        break;
      case 'reactivate':
        form.action = `{{ url_for('access_tokens.reactivate_token', token_id='TOKEN_ID') }}`.replace('TOKEN_ID', currentTokenId);
        break;
      case 'reset':
        form.action = `{{ url_for('access_tokens.reset_uses', token_id='TOKEN_ID') }}`.replace('TOKEN_ID', currentTokenId);
        break;
      case 'delete':
        form.action = `{{ url_for('access_tokens.delete_token', token_id='TOKEN_ID') }}`.replace('TOKEN_ID', currentTokenId);
        break;
    }
    
    // CSRF token si existe
    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (csrfToken) {
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrf_token';
      csrfInput.value = csrfToken.getAttribute('content');
      form.appendChild(csrfInput);
    }
    
    document.body.appendChild(form);
    form.submit();
  }, 1000);
}

// Cerrar modal con Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeModal();
  }
});

// Tooltips personalizados
document.addEventListener('DOMContentLoaded', function() {
  // Efecto de aparici√≥n escalonada para las filas de la tabla
  const tableRows = document.querySelectorAll('.tokens-table tbody tr');
  tableRows.forEach((row, index) => {
    row.style.animationDelay = `${index * 0.1}s`;
  });

  // Tooltips mejorados
  const tooltips = document.querySelectorAll('[title]');
  tooltips.forEach(tooltip => {
    tooltip.addEventListener('mouseenter', function(e) {
      // Crear tooltip personalizado
      const tooltipText = this.getAttribute('title');
      const tooltipEl = document.createElement('div');
      tooltipEl.className = 'custom-tooltip';
      tooltipEl.textContent = tooltipText;
      document.body.appendChild(tooltipEl);
      
      const rect = this.getBoundingClientRect();
      tooltipEl.style.left = `${rect.left + rect.width / 2}px`;
      tooltipEl.style.top = `${rect.top - 10}px`;
      tooltipEl.style.transform = 'translateX(-50%) translateY(-100%)';
      
      this.setAttribute('title', '');
    });
    
    tooltip.addEventListener('mouseleave', function() {
      const tooltipEl = document.querySelector('.custom-tooltip');
      if (tooltipEl) {
        this.setAttribute('title', tooltipEl.textContent);
        tooltipEl.remove();
      }
    });
  });

  // Efecto de carga para acciones
  const actionButtons = document.querySelectorAll('.token-actions .btn');
  actionButtons.forEach(btn => {
    btn.addEventListener('click', function(e) {
      if (this.classList.contains('btn-danger') || 
          this.classList.contains('btn-warning')) {
        this.classList.add('loading');
        setTimeout(() => {
          this.classList.remove('loading');
        }, 1500);
      }
    });
  });

  // Forzar aplicaci√≥n de estilos de modo oscuro
  applyDarkModeStyles();
});

// Actualizar estad√≠sticas din√°micamente
function updateStats() {
  fetch('{{ url_for("access_tokens.token_stats") }}')
    .then(response => response.json())
    .then(data => {
      if (data.total_tokens !== undefined) {
        // Animaci√≥n de conteo
        animateCounter('totalTokens', data.total_tokens);
        animateCounter('activeTokens', data.active_tokens || 0);
        animateCounter('revokedTokens', data.revoked_tokens || 0);
        animateCounter('totalUses', data.total_uses || 0);
      }
    })
    .catch(error => {
      console.error('Error al actualizar estad√≠sticas:', error);
    });
}

// Animaci√≥n de contador
function animateCounter(elementId, targetValue) {
  const element = document.getElementById(elementId);
  const currentValue = parseInt(element.textContent);
  const duration = 1000;
  const step = (targetValue - currentValue) / (duration / 16);
  let current = currentValue;

  const timer = setInterval(() => {
    current += step;
    if ((step > 0 && current >= targetValue) || (step < 0 && current <= targetValue)) {
      clearInterval(timer);
      current = targetValue;
    }
    element.textContent = Math.round(current);
  }, 16);
}

// Actualizar estad√≠sticas cada 30 segundos
setInterval(updateStats, 30000);

// Detectar y aplicar modo oscuro inmediatamente
function applyDarkModeStyles() {
  if (document.body.classList.contains('dark-mode')) {
    console.log('Modo oscuro detectado - aplicando correcciones inmediatas');
    
    // Aplicar estilos directamente a las stats cards
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach(card => {
      card.style.background = '#1f2937';
      card.style.borderColor = '#374151';
      card.style.color = '#f9fafb';
    });
    
    const statValues = document.querySelectorAll('.stat-value');
    statValues.forEach(value => {
      value.style.color = '#f9fafb';
    });
    
    const statLabels = document.querySelectorAll('.stat-label');
    statLabels.forEach(label => {
      label.style.color = '#d1d5db';
    });
  }
}

// Ejecutar inmediatamente y en cada cambio
setTimeout(applyDarkModeStyles, 500);
setTimeout(applyDarkModeStyles, 1000);
</script>
{% endblock %}