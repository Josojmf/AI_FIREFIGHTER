{% extends "backoffice_layout.html" %}

{% block title %}Crear Token - FirefighterAI BackOffice{% endblock %}
{% block page_title %}Crear Token{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/access_tokens.css') }}">
{% endblock %}

{% block content %}
<div class="edit-token-container">
  <div class="form-header">
    <h1>➕ Crear Token</h1>
    <p>Crea un nuevo token de acceso para registro de usuarios</p>
  </div>

  <div class="form-container">
    <form id="createTokenForm" method="POST" action="{{ url_for('access_tokens.create_token') }}">
      
      <!-- Información básica -->
      <div class="form-group">
        <label for="name" class="form-label required">Nombre del Token</label>
        <input type="text" id="name" name="name" class="form-input" 
               value="{{ form.name if form }}" required maxlength="100" placeholder="Ej: Token para estudiantes 2024">
        <div class="form-help">Nombre descriptivo para identificar el token</div>
      </div>

      <div class="form-group">
        <label for="description" class="form-label">Descripción</label>
        <textarea id="description" name="description" class="form-input form-textarea" 
                  placeholder="Descripción opcional del propósito del token...">{{ form.description if form }}</textarea>
        <div class="form-help">Descripción opcional para documentar el uso del token</div>
      </div>

      <!-- NUEVO: Campo para email del destinatario (OPCIONAL) -->
      <div class="form-group">
        <label for="recipient_email" class="form-label">Enviar por Email (Opcional)</label>
        <input type="email" id="recipient_email" name="recipient_email" class="form-input" 
               value="{{ form.recipient_email if form }}" placeholder="destinatario@ejemplo.com">
        <div class="form-help">Si se especifica, el token se enviará automáticamente por email. Dejar vacío para crear solo el token.</div>
      </div>

      <!-- Configuración de usos -->
      <div class="form-grid">
        <div class="form-group">
          <label for="max_uses" class="form-label required">Máximo de Usos</label>
          <input type="number" id="max_uses" name="max_uses" class="form-input" 
                 value="{{ form.max_uses if form else '50' }}" min="1" max="1000" required>
          <div class="form-help">Número máximo de registros permitidos</div>
        </div>

        <div class="form-group">
          <label for="user_type" class="form-label required">Tipo de Usuario</label>
          <select id="user_type" name="user_type" class="form-select" required>
            <option value="student" {% if form and form.user_type == 'student' %}selected{% endif %}>Estudiante</option>
            <option value="instructor" {% if form and form.user_type == 'instructor' %}selected{% endif %}>Instructor</option>
            <option value="admin" {% if form and form.user_type == 'admin' %}selected{% endif %}>Administrador</option>
          </select>
          <div class="form-help">Tipo de usuario que podrá registrarse con este token</div>
        </div>
      </div>

      <!-- Configuración de expiración -->
      <div class="form-group">
        <label for="expires_days" class="form-label">Días hasta expiración</label>
        <input type="number" id="expires_days" name="expires_days" class="form-input" 
               value="{{ form.expires_days if form else '30' }}" min="1" max="365">
        <div class="form-help">Número de días hasta que el token expire (1-365). Dejar vacío para que no expire.</div>
      </div>

      <!-- Acciones -->
      <div class="form-actions">
        <a href="{{ url_for('access_tokens.token_list') }}" class="btn btn-secondary">
          <span>❌</span>
          Cancelar
        </a>
        <button type="submit" class="btn btn-primary" id="submitButton">
          <span>✅</span>
          Crear Token
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('createTokenForm');
  const nameInput = document.getElementById('name');
  const maxUsesInput = document.getElementById('max_uses');
  const userTypeInput = document.getElementById('user_type');
  const emailInput = document.getElementById('recipient_email');
  const submitButton = document.getElementById('submitButton');

  // Validación en tiempo real
  function validateForm() {
    const name = nameInput.value.trim();
    const maxUses = parseInt(maxUsesInput.value);
    const userType = userTypeInput.value;
    const email = emailInput.value.trim();
    
    let isValid = true;
    
    // Limpiar errores anteriores
    document.querySelectorAll('.validation-error').forEach(el => el.remove());
    
    // Validar nombre
    if (!name) {
      showError(nameInput, 'El nombre es obligatorio');
      isValid = false;
    } else if (name.length < 3) {
      showError(nameInput, 'El nombre debe tener al menos 3 caracteres');
      isValid = false;
    }
    
    // Validar usos máximos
    if (!maxUses || maxUses < 1 || maxUses > 1000) {
      showError(maxUsesInput, 'Los usos máximos deben estar entre 1 y 1000');
      isValid = false;
    }
    
    // Validar tipo de usuario
    if (!userType) {
      showError(userTypeInput, 'El tipo de usuario es obligatorio');
      isValid = false;
    }
    
    // Validar email si se proporciona (OPCIONAL)
    if (email && !isValidEmail(email)) {
      showError(emailInput, 'Por favor ingresa un email válido');
      isValid = false;
    }
    
    // Actualizar botón
    submitButton.disabled = !isValid;
    
    return isValid;
  }

  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function showError(input, message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'validation-error';
    errorDiv.textContent = message;
    input.parentNode.appendChild(errorDiv);
    input.style.borderColor = '#ef4444';
  }

  // Event listeners para validación
  [nameInput, maxUsesInput, userTypeInput, emailInput].forEach(input => {
    input.addEventListener('input', validateForm);
    input.addEventListener('blur', validateForm);
  });

  // Validar al enviar
  form.addEventListener('submit', function(e) {
    if (!validateForm()) {
      e.preventDefault();
      return false;
    }
    
    // Mostrar loading
    submitButton.disabled = true;
    submitButton.innerHTML = '<span>⏳</span> Creando...';
  });

  // Inicializar validación
  validateForm();
});
</script>
{% endblock %}