<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Firefighter AI - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .status-success { background-color: #dcfce7; border-color: #22c55e; border-width: 2px; }
        .status-failed { background-color: #fee2e2; border-color: #ef4444; border-width: 2px; }
        .status-unknown { background-color: #fef3c7; border-color: #f59e0b; border-width: 2px; }
        
        .redeploy-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
        }
        .redeploy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -1px rgba(239, 68, 68, 0.4);
        }
        
        .pulse-alert {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success {
            background-color: #10b981;
        }
        .toast.error {
            background-color: #ef4444;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-fire-extinguisher mr-3 text-red-500"></i>
                Firefighter AI Dashboard
            </h1>
            <p class="text-gray-600" id="lastUpdated">√öltima actualizaci√≥n: Cargando...</p>
        </header>

        <!-- üö® EMERGENCY BANNER (Mejor UX que la versi√≥n anterior) -->
        <div id="emergencyBanner" class="hidden mb-6">
            <div class="bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg p-6 text-center pulse-alert shadow-lg">
                <div class="flex items-center justify-center mb-3">
                    <i class="fas fa-exclamation-triangle text-2xl mr-3"></i>
                    <h2 class="text-xl font-bold">‚ö†Ô∏è Sistema Requiere Atenci√≥n</h2>
                </div>
                <p id="emergencyMessage" class="mb-4">Problemas detectados en el sistema.</p>
                <button id="redeployBtn" class="bg-white text-red-600 font-bold py-3 px-6 rounded-lg transition-all duration-300 hover:bg-gray-100">
                    <i class="fas fa-redo-alt mr-2"></i>
                    Redeploy de Emergencia
                </button>
            </div>
        </div>

        <!-- Metrics Grid - H√çBRIDO: Info completa + Health checks -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Deployment Status -->
            <div class="bg-white rounded-lg shadow p-6 text-center" id="deployCard">
                <i class="fas fa-rocket text-3xl text-blue-500 mb-3"></i>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Deploy Status</h3>
                <div id="deploymentStatus" class="text-2xl font-bold mb-2">‚è≥</div>
                <p class="text-gray-500 text-sm" id="deploymentTime"></p>
                <a id="viewDetails" href="#" class="text-blue-500 hover:text-blue-700 text-sm mt-2 inline-block">
                    <i class="fas fa-external-link-alt mr-1"></i>Ver detalles
                </a>
            </div>

            <!-- Frontend Health -->
            <div class="bg-white rounded-lg shadow p-6 text-center" id="frontendCard">
                <i class="fas fa-globe text-3xl mb-3" id="frontendIcon"></i>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Frontend</h3>
                <div id="frontendStatus" class="text-2xl font-bold mb-2">‚è≥</div>
                <a href="http://167.71.63.108:8000" class="text-blue-500 text-sm hover:underline" target="_blank">Abrir app</a>
            </div>

            <!-- Backend Health -->
            <div class="bg-white rounded-lg shadow p-6 text-center" id="backendCard">
                <i class="fas fa-database text-3xl mb-3" id="backendIcon"></i>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Backend API</h3>
                <div id="backendStatus" class="text-2xl font-bold mb-2">‚è≥</div>
                <p class="text-gray-500 text-sm">Puerto 5000</p>
            </div>

            <!-- Backoffice Health -->
            <div class="bg-white rounded-lg shadow p-6 text-center" id="backofficeCard">
                <i class="fas fa-cog text-3xl mb-3" id="backofficeIcon"></i>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Backoffice</h3>
                <div id="backofficeStatus" class="text-2xl font-bold mb-2">‚è≥</div>
                <a href="http://167.71.63.108:3001" class="text-purple-500 text-sm hover:underline" target="_blank">Panel admin</a>
            </div>
        </div>

        <!-- System Overview -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">
                <i class="fas fa-chart-pie mr-2 text-green-500"></i>
                Resumen del Sistema
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div id="servicesHealthy" class="text-3xl font-bold text-green-600">3/3</div>
                    <p class="text-gray-600">Servicios Operativos</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-purple-600">95%</div>
                    <p class="text-gray-600">Uptime Global</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-600">120ms</div>
                    <p class="text-gray-600">Tiempo Respuesta</p>
                </div>
            </div>
        </div>

        <!-- Deployment Details - INFORMACI√ìN COMPLETA -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">
                <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                √öltimo Deployment
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="text-gray-600"><strong>Commit:</strong> <span id="commitHash" class="font-mono">-</span></p>
                    <p class="text-gray-600"><strong>Ejecutado por:</strong> <span id="triggeredBy">-</span></p>
                    <p class="text-gray-600"><strong>Run ID:</strong> <span id="runId" class="font-mono">-</span></p>
                </div>
                <div>
                    <p class="text-gray-600"><strong>Workflow:</strong> <span id="workflowId" class="font-mono">-</span></p>
                    <p class="text-gray-600"><strong>Entorno:</strong> Producci√≥n Digital Ocean</p>
                    <p class="text-gray-600"><strong>√öltima verificaci√≥n:</strong> <span id="lastCheck">-</span></p>
                </div>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">
                <i class="fas fa-external-link-alt mr-2 text-gray-500"></i>
                Enlaces R√°pidos
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <a href="https://github.com/${{ github.repository }}/actions" 
                   class="bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg p-4 text-center transition-colors" target="_blank">
                    <i class="fas fa-play-circle text-blue-500 text-2xl mb-2"></i>
                    <p class="font-semibold text-blue-700">GitHub Actions</p>
                    <p class="text-sm text-blue-600">Workflows y ejecuciones</p>
                </a>
                
                <a href="http://167.71.63.108:8000" 
                   class="bg-green-50 hover:bg-green-100 border border-green-200 rounded-lg p-4 text-center transition-colors" target="_blank">
                    <i class="fas fa-globe text-green-500 text-2xl mb-2"></i>
                    <p class="font-semibold text-green-700">FirefighterAI App</p>
                    <p class="text-sm text-green-600">Aplicaci√≥n principal</p>
                </a>
                
                <a href="http://167.71.63.108:3001" 
                   class="bg-purple-50 hover:bg-purple-100 border border-purple-200 rounded-lg p-4 text-center transition-colors" target="_blank">
                    <i class="fas fa-cog text-purple-500 text-2xl mb-2"></i>
                    <p class="font-semibold text-purple-700">Panel Admin</p>
                    <p class="text-sm text-purple-600">Gesti√≥n y configuraci√≥n</p>
                </a>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n - MEJOR UX -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-2xl">
            <div class="text-center mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-3"></i>
                <h3 class="text-xl font-bold text-gray-800">Confirmar Redeploy de Emergencia</h3>
            </div>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <p class="text-yellow-800 text-sm">
                    <strong>‚ö†Ô∏è Importante:</strong> Esto ejecutar√° un deployment completo que puede tardar varios minutos. 
                    Los servicios pueden estar temporalmente inaccesibles.
                </p>
            </div>
            <p class="text-gray-600 mb-6 text-center">¬øEst√°s seguro de que quieres proceder?</p>
            <div class="flex gap-4">
                <button id="confirmRedeploy" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                    <i class="fas fa-rocket mr-2"></i>S√≠, Ejecutar Redeploy
                </button>
                <button id="cancelRedeploy" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let dashboardData = null;

        // Cargar y procesar datos
        fetch('./data.json')
            .then(response => response.json())
            .then(data => {
                dashboardData = data;
                console.log('üìä Dashboard data loaded:', data);
                updateDashboard(data);
            })
            .catch(error => {
                console.error('‚ùå Error loading dashboard data:', error);
                showToast('Error cargando datos del dashboard', 'error');
            });

        function updateDashboard(data) {
            // Header
            document.getElementById('lastUpdated').textContent = 
                '√öltima actualizaci√≥n: ' + new Date(data.dashboard.last_updated).toLocaleString();
            
            document.getElementById('lastCheck').textContent = 
                new Date(data.dashboard.last_updated).toLocaleString();
            
            // Deployment status
            updateDeploymentStatus(data.deployment);
            
            // Health checks
            updateHealthStatus(data.health);
            
            // Emergency banner logic
            checkEmergencyConditions(data);
            
            // Details
            updateDetails(data.deployment);
        }

        function updateDeploymentStatus(deployment) {
            const card = document.getElementById('deployCard');
            const status = document.getElementById('deploymentStatus');
            const time = document.getElementById('deploymentTime');
            const details = document.getElementById('viewDetails');

            // Clear previous status classes
            card.classList.remove('status-success', 'status-failed', 'status-unknown');

            switch(deployment.last_status) {
                case 'success':
                    status.innerHTML = '‚úÖ <span class="text-green-600">Exitoso</span>';
                    card.classList.add('status-success');
                    break;
                case 'failure':
                    status.innerHTML = '‚ùå <span class="text-red-600">Fallido</span>';
                    card.classList.add('status-failed');
                    break;
                case 'cancelled':
                    status.innerHTML = '‚èπÔ∏è <span class="text-yellow-600">Cancelado</span>';
                    card.classList.add('status-unknown');
                    break;
                default:
                    status.innerHTML = '‚ö†Ô∏è <span class="text-yellow-600">Desconocido</span>';
                    card.classList.add('status-unknown');
            }

            time.textContent = new Date(deployment.last_deployment).toLocaleString();
            details.href = deployment.html_url;
        }

        function updateHealthStatus(health) {
            // Individual services
            updateServiceHealth('frontend', health.frontend);
            updateServiceHealth('backend', health.backend);
            updateServiceHealth('backoffice', health.backoffice);
            
            // Global counter
            document.getElementById('servicesHealthy').textContent = `${health.services_healthy}/3`;
            document.getElementById('servicesHealthy').className = 
                `text-3xl font-bold ${health.services_healthy === 3 ? 'text-green-600' : 'text-red-600'}`;
        }

        function updateServiceHealth(service, status) {
            const card = document.getElementById(service + 'Card');
            const statusEl = document.getElementById(service + 'Status');
            const icon = document.getElementById(service + 'Icon');
            
            // Clear classes
            card.classList.remove('status-success', 'status-failed');
            
            if (status === 'healthy') {
                statusEl.innerHTML = '‚úÖ <span class="text-green-600">Online</span>';
                icon.className = icon.className.replace(/text-\w+-\d+/, 'text-green-500');
                card.classList.add('status-success');
            } else {
                statusEl.innerHTML = '‚ùå <span class="text-red-600">Offline</span>';
                icon.className = icon.className.replace(/text-\w+-\d+/, 'text-red-500');
                card.classList.add('status-failed');
            }
        }

        function checkEmergencyConditions(data) {
            const banner = document.getElementById('emergencyBanner');
            const message = document.getElementById('emergencyMessage');
            
            const deploymentFailed = data.deployment.last_status === 'failure' || data.deployment.last_status === 'cancelled';
            const servicesUnhealthy = data.health.overall === 'unhealthy';
            
            if (deploymentFailed || servicesUnhealthy) {
                let emergencyText = '';
                if (deploymentFailed && servicesUnhealthy) {
                    emergencyText = `‚ùå Deployment fallido Y servicios offline (${data.health.services_healthy}/3 operativos)`;
                } else if (deploymentFailed) {
                    emergencyText = '‚ùå El √∫ltimo deployment fall√≥ - Se requiere redeploy';
                } else if (servicesUnhealthy) {
                    emergencyText = `üè• Servicios unhealthy detectados (${data.health.services_healthy}/3 operativos)`;
                }
                
                message.textContent = emergencyText;
                banner.classList.remove('hidden');
            } else {
                banner.classList.add('hidden');
            }
        }

        function updateDetails(deployment) {
            document.getElementById('commitHash').textContent = deployment.last_commit.substring(0, 8);
            document.getElementById('triggeredBy').textContent = deployment.triggered_by;
            document.getElementById('runId').textContent = deployment.run_id;
            document.getElementById('workflowId').textContent = deployment.workflow_id;
        }

        // Event listeners para redeploy
        document.getElementById('redeployBtn').addEventListener('click', function() {
            document.getElementById('confirmModal').classList.remove('hidden');
        });

        document.getElementById('cancelRedeploy').addEventListener('click', function() {
            document.getElementById('confirmModal').classList.add('hidden');
        });

        document.getElementById('confirmRedeploy').addEventListener('click', function() {
            executeRedeploy();
        });

        // Cerrar modal clickeando fuera
        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
            }
        });

        async function executeRedeploy() {
            const btn = document.getElementById('confirmRedeploy');
            const originalText = btn.innerHTML;
            
            // Loading state
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Ejecutando...';
            btn.disabled = true;
            
            try {
                // GitHub API call para dispatch workflow
                const response = await fetch(`https://api.github.com/repos/${dashboardData.dashboard.repository}/actions/workflows/${dashboardData.deployment.workflow_id}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ${{ secrets.GITHUB_TOKEN }}',
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ref: 'main',
                        inputs: {
                            triggered_by: 'emergency_dashboard_redeploy',
                            reason: 'Emergency redeploy triggered from dashboard due to failed deployment or unhealthy services'
                        }
                    })
                });

                if (response.ok || response.status === 204) {
                    showToast('üöÄ Redeploy iniciado exitosamente', 'success');
                    
                    // √âxito - redirigir a GitHub Actions
                    setTimeout(() => {
                        window.open(`https://github.com/${dashboardData.dashboard.repository}/actions`, '_blank');
                        showToast('üîÑ Recarga esta p√°gina en 2-3 minutos para ver el progreso', 'success');
                    }, 1000);
                    
                } else {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
                
            } catch (error) {
                console.error('‚ùå Redeploy error:', error);
                showToast(`‚ùå Error: ${error.message}`, 'error');
                
                // Restaurar bot√≥n
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
            
            // Cerrar modal
            document.getElementById('confirmModal').classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check' : 'fa-exclamation-triangle'} mr-2"></i>${message}`;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Remove after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 5000);
        }
    </script>
</body>
</html>