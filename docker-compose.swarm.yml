version: "3.8"

services:
  # üî• BACKEND (API) - SWARM
  backend:
    image: ghcr.io/josojmf/ai-firefighter-backend:${IMAGE_TAG:-latest}
    ports:
      - target: 5000
        published: 5000
        mode: host
    environment:
      - PUBLIC_API_URL=http://backend:5000
      - ENVIRONMENT=production
      - DEBUG=false
      - DOCKER_ENV=true
      - REDIS_URL=redis://redis:6379/0
      - MONGODB_URI=${MONGODB_URI}
      - SECRET_KEY=${SECRET_KEY}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    deploy:
      replicas: 2
      labels:
        app: firefighter
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
    networks:
      - firefighter_network

  # üåê FRONTEND - SWARM
  frontend:
    image: ghcr.io/josojmf/ai-firefighter-frontend:${IMAGE_TAG:-latest}
    ports:
      - target: 8000
        published: 8000
        mode: host
    environment:
      - API_BASE_URL=http://backend:5000
      - ENVIRONMENT=production
      - DEBUG=false
      - DOCKER_ENV=true
      - REDIS_URL=redis://redis:6379/0
    deploy:
      replicas: 2
      labels:
        app: firefighter
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
    networks:
      - firefighter_network

  # üè¢ BACKOFFICE - SWARM
  backoffice:
    image: ghcr.io/josojmf/ai-firefighter-backoffice:${IMAGE_TAG:-latest}
    ports:
      - target: 3001
        published: 3001
        mode: host
    environment:
      - API_BASE_URL=http://backend:5000
      - ENVIRONMENT=production
      - DEBUG=false
      - DOCKER_ENV=true
      - MFA_ISSUER=FirefighterAI
      - REDIS_URL=redis://redis:6379/0
    deploy:
      replicas: 1
      labels:
        app: firefighter
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    networks:
      - firefighter_network

  # üî¥ REDIS - SWARM
  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data-prod:/data
    deploy:
      replicas: 1
      labels:
        app: firefighter
      restart_policy:
        condition: on-failure
    networks:
      - firefighter_network

networks:
  firefighter_network:
    driver: overlay
    attachable: true

volumes:
  redis-data-prod:
    driver: local
