name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  critical-checks:
    name: Critical Checks Only
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install essential dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install flake8==7.1.1 bandit==1.7.9
          # deps mínimas para parsear código
          pip install flask pymongo requests python-dotenv

      - name: Critical syntax check
        run: |
          echo "Running critical syntax checks..."
          python_files=$(find API BO FO -name "*.py" -not -path "*/.*" -not -path "*/__pycache__/*" | head -40)
          if [ -n "$python_files" ]; then
            for file in $python_files; do
              echo "Checking syntax: $file"
              python -m py_compile "$file" || {
                echo "CRITICAL: Syntax error in $file"
                exit 1
              }
            done
            echo "✅ All sampled Python files have valid syntax"
          else
            echo "No Python files found to check"
          fi

      - name: Critical security check
        run: |
          echo "Running critical security checks..."
          bandit -r API BO -ll --skip="**/__pycache__/**,**/venv/**,**/.git/**" -f json -o bandit-critical.json || true
          if [ -f bandit-critical.json ]; then
            python3 -c "
            import json, sys
            try:
                with open('bandit-critical.json', 'r') as f:
                    data = json.load(f)
                critical = [r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH']
                if critical:
                    print(f'CRITICAL SECURITY ISSUES FOUND: {len(critical)}')
                    for issue in critical[:3]:
                        print(f'- {issue.get(\"test_name\", \"Unknown\")}: {issue.get(\"issue_text\", \"No description\")}')
                    sys.exit(1)
                else:
                    print('No critical security issues found')
            except Exception as e:
                print(f'Security scan completed with warnings: {e}')
            "
          fi

      - name: Set deployment readiness
        id: readiness
        run: |
          echo "deployment_ready=true" >> $GITHUB_OUTPUT
          echo "CI cleared for deployment"

  quality-checks:
    name: Quality Checks (Non-blocking)
    runs-on: ubuntu-latest
    needs: critical-checks
    timeout-minutes: 30
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install quality tools
        continue-on-error: true
        run: |
          python -m pip install --upgrade pip setuptools wheel packaging==21.3
          pip install \
            black==24.8.0 \
            isort==5.13.2 \
            flake8==7.1.1 \
            mypy==1.11.2 \
            pytest==7.4.4 \
            pytest-cov==4.1.0 \
            safety==3.2.7
          # deps básicas para ejecutar tests de API/FO/BO
          pip install flask flask-cors pymongo bcrypt python-dotenv requests gunicorn werkzeug
          for req_file in "requirements.txt" "FO/requirements.txt" "API/requirements.txt" "BO/requirements.txt"; do
            if [ -f "$req_file" ]; then
              pip install -r "$req_file" --no-deps || echo "Some packages from $req_file may already be installed"
            fi
          done

      - name: Code formatting & style (non-blocking)
        continue-on-error: true
        run: |
          echo "Checking code formatting and style..."
          python_dirs=()
          for dir in "FO" "API" "BO"; do
            if [ -d "$dir" ] && find "$dir" -maxdepth 5 -name "*.py" -not -path "*/.*" -not -path "*/__pycache__/*" -print -quit | grep -q .; then
              python_dirs+=("$dir")
            fi
          done
          if [ ${#python_dirs[@]} -eq 0 ]; then
            echo "No Python files found"
            exit 0
          fi
          for dir in "${python_dirs[@]}"; do
            echo "Checking formatting in $dir..."
            black "$dir" --check --diff --exclude='(__pycache__|\.git|\.egg-info|venv|env)' || echo "Black found issues in $dir"
            isort "$dir" --check-only --diff --skip-glob='**/__pycache__/**' --skip-glob='**/.git/**' || echo "Isort found issues in $dir"
            flake8 "$dir" \
              --count \
              --statistics \
              --exclude=__pycache__,*.egg-info,.git,venv,env \
              --max-line-length=88 \
              --ignore=E203,W503,E501 || echo "Flake8 found style issues in $dir"
          done

      - name: Run tests (non-blocking)
        continue-on-error: true
        run: |
          echo "Running tests..."
          mkdir -p test-results
          test_files=$(find . -name "test_*.py" -o -name "*_test.py" 2>/dev/null | head -20)
          if [ -n "$test_files" ]; then
            echo "Found test files, running pytest..."
            pytest \
              --cov=./ \
              --cov-report=xml:coverage.xml \
              --cov-report=term-missing \
              --junitxml=test-results/junit.xml \
              -v \
              --tb=short \
              --maxfail=10 \
              --ignore=venv \
              --ignore=env \
              --ignore=.git || echo "Tests completed with some failures"
          else
            echo "No test files found"
          fi

      - name: Lint Dockerfiles and compose (non-blocking)
        continue-on-error: true
        run: |
          pip install hadolint yamllint || true
          for df in API/Dockerfile BO/Dockerfile FO/Dockerfile; do
            if [ -f "$df" ]; then
              echo "Linting $df"
              hadolint "$df" || echo "Hadolint warnings in $df"
            fi
          done
          for y in docker-compose.dev.yml docker-compose.prod.yml docker-compose.override.yml docker-compose.swarm.yml docker-compose-monitoring.yml; do
            if [ -f "$y" ]; then
              echo "Yamllint $y"
              yamllint "$y" || echo "Yamllint warnings in $y"
            fi
          done

  docker-smoke:
    name: Docker Build & Smoke Tests
    runs-on: ubuntu-latest
    needs: critical-checks
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build dev stack
        run: docker-compose -f docker-compose.dev.yml build

      - name: Start dev stack
        run: |
          docker-compose -f docker-compose.dev.yml up -d
          # esperar a healthchecks
          sleep 40

      - name: Smoke test backend
        run: |
          curl -fsS http://localhost:5000/health || curl -fsS http://localhost:5000/api/health

      - name: Smoke test backoffice
        run: |
          curl -fsS http://localhost:3001/health

      - name: Smoke test frontend (non-blocking)
        run: |
          curl -fsS http://localhost:8080/ || echo "Frontend smoke test non-blocking"

      - name: Tear down
        if: always()
        run: docker-compose -f docker-compose.dev.yml down --remove-orphans
