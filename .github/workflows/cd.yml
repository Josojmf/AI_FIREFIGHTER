name: CD - Multi Image Deploy with Auto Cleanup - COMPLETE

on:
  push:
    branches:
      - main
    paths:
      - "FO/**"
      - "API/**"
      - "BO/**"
      - "docker-compose.prod.yml"
      - "Dockerfile"
      - "**.yml"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:

  # -------------------------------------------------------------------
  # 1) BUILD & PUSH ALL DOCKER IMAGES TO GHCR
  # -------------------------------------------------------------------
  build-and-push:
    name: 🏗️ Build & Push All Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Owner lowercase
        id: lc
        run: echo "owner_lc=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USER }}
          password: ${{ secrets.GHCR_PAT }}

      # FRONTEND
      - name: Build + Push FRONTEND
        uses: docker/build-push-action@v6
        with:
          context: ./FO
          file: ./FO/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.lc.outputs.owner_lc }}/ai-firefighter-frontend:latest
            ghcr.io/${{ steps.lc.outputs.owner_lc }}/ai-firefighter-frontend:${{ github.sha }}
          build-args: |
            API_BASE_URL=http://backend:5000/api
          no-cache: true

      # BACKEND
      - name: Build + Push BACKEND
        uses: docker/build-push-action@v6
        with:
          context: ./API
          file: ./API/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.lc.outputs.owner_lc }}/ai-firefighter-backend:latest
            ghcr.io/${{ steps.lc.outputs.owner_lc }}/ai-firefighter-backend:${{ github.sha }}
          no-cache: true

      # BACKOFFICE
      - name: Build + Push BACKOFFICE
        uses: docker/build-push-action@v6
        with:
          context: ./BO
          file: ./BO/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.lc.outputs.owner_lc }}/ai-firefighter-backoffice:latest
            ghcr.io/${{ steps.lc.outputs.owner_lc }}/ai-firefighter-backoffice:${{ github.sha }}
          no-cache: true

  # -------------------------------------------------------------------
  # 2) DEPLOY TO DROPLET
  # -------------------------------------------------------------------
  deploy:
    name: 🚀 Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Create deploy folder
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 300s
          script: |
            set -e
            echo "📁 Ensuring deploy directory..."
            mkdir -p /opt/emergency
            cd /opt/emergency
            echo "✅ Deploy directory ready"

      - name: Upload docker-compose.prod.yml
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          source: "docker-compose.prod.yml"
          target: "/opt/emergency/"

      - name: Install Docker & Compose
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 600s
          script: |
            set -e
            echo "🐳 Checking Docker installation..."
            
            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "📥 Installing Docker..."
              apt-get update -y
              apt-get install -y docker.io
              systemctl enable --now docker
              echo "✅ Docker installed"
            else
              echo "✅ Docker already installed"
            fi

            # Install Docker Compose
            if ! command -v docker-compose &> /dev/null; then
              echo "📥 Installing Docker Compose..."
              apt-get update -y
              apt-get install -y curl
              curl -SL https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
              echo "✅ Docker Compose installed"
            else
              echo "✅ Docker Compose already installed"
            fi

      - name: Login GHCR in server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 180s
          script: |
            set -e
            echo "🔐 Logging into GHCR..."
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.GHCR_USER }}" --password-stdin
            echo "✅ Logged into GHCR"

      - name: Generate environment file
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 120s
          script: |
            set -e
            echo "🔧 Generating environment file..."
            cat << EOF > /root/firefighter.env
            # 🔥 CLAVES SECRETAS SEPARADAS PARA SESIONES
            FRONTEND_SECRET_KEY=${{ secrets.FRONTEND_SECRET_KEY }}
            BACKOFFICE_SECRET_KEY=${{ secrets.BACKOFFICE_SECRET_KEY }}
            
            # Variables originales (mantener)
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            JWT_EXPIRES_HOURS=${{ secrets.JWT_EXPIRES_HOURS }}
            MONGO_CLUSTER=${{ secrets.MONGO_CLUSTER }}
            MONGO_USER=${{ secrets.MONGO_USER }}
            MONGO_PASS=${{ secrets.MONGO_PASS }}
            DB_CLUSTER=${{ secrets.DB_CLUSTER }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=${{ secrets.DB_NAME }}
            VAPID_PUBLIC_KEY=${{ secrets.VAPID_PUBLIC_KEY }}
            VAPID_PRIVATE_KEY=${{ secrets.VAPID_PRIVATE_KEY }}
            
            # 🔥 CONFIGURACIÓN DE SESIONES
            FRONTEND_SESSION_TIMEOUT=86400
            BACKOFFICE_SESSION_TIMEOUT=28800
            
            # Admin y MFA
            ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}
            ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
            MFA_ISSUER=FirefighterAI
            
            # Configuración general
            DEBUG=false
            EOF
            chmod 600 /root/firefighter.env
            echo "✅ Environment file created with session separation"
            
            # Mostrar configuración (sin secretos)
            echo "📋 Environment variables configured:"
            echo "   - Frontend session: FRONTEND_SECRET_KEY (set)"
            echo "   - Backoffice session: BACKOFFICE_SECRET_KEY (set)"
            echo "   - Session timeouts configured"

      - name: Check disk space and cleanup
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 600s
          script: |
            set -e
            echo "💾 Checking disk space..."
            df -h /
            
            # Get available space in GB
            AVAILABLE_GB=$(df / | awk 'NR==2 {print int($4/1024/1024)}')
            echo "Available space: ${AVAILABLE_GB}GB"
            
            # If less than 5GB available, do aggressive cleanup
            if [ "$AVAILABLE_GB" -lt 5 ]; then
              echo "⚠️ Low disk space detected! Starting cleanup..."
              
              # Stop containers first
              cd /opt/emergency
              docker-compose -f docker-compose.prod.yml down --remove-orphans --timeout 30 || true
              
              echo "🧹 Aggressive Docker cleanup..."
              
              # Remove all stopped containers
              docker container prune -f
              
              # Remove all unused images (keeping only what we need)
              docker image prune -a -f
              
              # Remove unused volumes
              docker volume prune -f
              
              # Remove build cache
              docker builder prune -a -f
              
              # Remove unused networks
              docker network prune -f
              
              # Final system cleanup
              docker system prune -a -f --volumes
              
              echo "🗑️ Cleaning system logs..."
              # Clean system logs if they're too large
              journalctl --vacuum-time=7d || true
              
              # Clean apt cache
              apt-get clean || true
              
              echo "✅ Cleanup completed"
              df -h /
              
              AVAILABLE_AFTER=$(df / | awk 'NR==2 {print int($4/1024/1024)}')
              echo "Space freed: $((AVAILABLE_AFTER - AVAILABLE_GB))GB"
            else
              echo "✅ Sufficient disk space available"
            fi

      - name: Stop existing containers and backup
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 300s
          script: |
            set -e
            echo "🛑 Stopping existing containers..."
            cd /opt/emergency
            
            # Backup current compose file
            if [ -f docker-compose.prod.yml ]; then
              cp docker-compose.prod.yml docker-compose.prod.yml.backup.$(date +%Y%m%d_%H%M%S)
              echo "✅ Compose file backed up"
            fi
            
            # Stop existing containers - CORREGIDO: verificar si el archivo existe primero
            if [ -f docker-compose.prod.yml ]; then
              docker-compose -f docker-compose.prod.yml down --remove-orphans --timeout 30 || true
              echo "✅ Containers stopped"
            else
              echo "ℹ️ No existing compose file found, skipping stop"
            fi
            
            # Remove old backups (keep only last 5)
            ls -t docker-compose.prod.yml.backup.* 2>/dev/null | tail -n +6 | xargs rm -f || true
            
            echo "✅ Cleanup completed"

      - name: Pull latest images with space management
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 1200s
          script: |
            set -e
            echo "📥 Pulling latest images with space management..."
            cd /opt/emergency
            
            # Check space before pulling
            AVAILABLE_GB=$(df / | awk 'NR==2 {print int($4/1024/1024)}')
            echo "Available space before pull: ${AVAILABLE_GB}GB"
            
            if [ "$AVAILABLE_GB" -lt 3 ]; then
              echo "❌ Insufficient space for pull (need at least 3GB)"
              exit 1
            fi
            
            # Pull images one by one with space checking and cleanup
            echo "🔄 Pulling frontend image..."
            docker-compose -f docker-compose.prod.yml pull frontend
            docker image prune -f  # Clean after each pull
            
            echo "🔄 Pulling backend image..."
            docker-compose -f docker-compose.prod.yml pull backend
            docker image prune -f
            
            echo "🔄 Pulling backoffice image..."  
            docker-compose -f docker-compose.prod.yml pull backoffice
            docker image prune -f
            
            # Final verification
            echo "🔍 Verifying images..."
            docker images | grep ai-firefighter
            
            # Check space after pull
            AVAILABLE_AFTER=$(df / | awk 'NR==2 {print int($4/1024/1024)}')
            echo "Available space after pull: ${AVAILABLE_AFTER}GB"
            
            echo "✅ Images pulled successfully"

      - name: Start services
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 600s
          script: |
            set -e
            echo "🚀 Starting services..."
            cd /opt/emergency
            
            # Start all services
            docker-compose -f docker-compose.prod.yml up -d --remove-orphans
            
            # Wait for services to initialize
            echo "⏳ Waiting for services to start..."
            sleep 30
            
            # Check container status
            echo "📋 Container status:"
            docker-compose -f docker-compose.prod.yml ps
            
            echo "✅ Services started"

      - name: Health checks and verification
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 600s
          script: |
            set -e
            echo "🔍 Running health checks..."
            cd /opt/emergency
            
            # Wait for services to be fully ready
            MAX_RETRIES=20
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Health check attempt $RETRY_COUNT/$MAX_RETRIES"
              
              # Check if containers are running - CORREGIDO: añadir -f
              RUNNING_CONTAINERS=$(docker-compose -f docker-compose.prod.yml ps -q | wc -l)
              echo "Running containers: $RUNNING_CONTAINERS"
              
              if [ "$RUNNING_CONTAINERS" -eq 3 ]; then
                echo "✅ All containers are running!"
                break
              fi
              
              if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "⚠️ Not all containers started properly"
                echo "📋 Final status:"
                docker-compose -f docker-compose.prod.yml ps
                echo "📄 Recent logs:"
                docker-compose -f docker-compose.prod.yml logs --tail=20
                break
              fi
              
              echo "⏱️ Waiting 15 seconds..."
              sleep 15
            done

      - name: Final verification and connectivity tests
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 300s
          script: |
            set -e
            echo "🔬 Final verification..."
            cd /opt/emergency
            
            # Final container status - CORREGIDO: añadir -f
            echo "📊 Final container status:"
            docker-compose -f docker-compose.prod.yml ps
            
            # Show which ports are exposed
            echo "🌐 Exposed ports:"
            docker ps --format "table {{.Names}}\t{{.Ports}}" 2>/dev/null || echo "Could not get port info"
            
            # Test connectivity with better error handling
            echo "🔗 Testing connectivity:"
            
            echo "Backend (port 5000):"
            if curl -s -f --connect-timeout 10 --max-time 15 http://localhost:5000/ >/dev/null 2>&1; then
              echo "  ✅ Backend responding"
            else
              echo "  ⚠️ Backend not responding yet"
            fi
            
            echo "Frontend (port 8000):"
            if curl -s -f --connect-timeout 10 --max-time 15 http://localhost:8000/ >/dev/null 2>&1; then
              echo "  ✅ Frontend responding"
            else
              echo "  ⚠️ Frontend not responding yet"
            fi
            
            echo "Backoffice (port 3001):"
            if curl -s -f --connect-timeout 10 --max-time 15 http://localhost:3001/ >/dev/null 2>&1; then
              echo "  ✅ Backoffice responding"
            else
              echo "  ⚠️ Backoffice not responding yet"
            fi
            
            # Show final disk usage
            echo "💾 Final disk usage:"
            df -h /
            
            # Final cleanup of old images
            echo "🧹 Final cleanup of old images..."
            docker image prune -f || true
            
            echo "✅ Deployment verification completed"

      - name: Deployment summary
        run: |
          echo "🔥 PRODUCTION DEPLOYMENT COMPLETED!"
          echo "📅 $(date)"
          echo ""
          echo "🔄 Services deployed:"
          echo "   - Frontend: http://your-server:8000"
          echo "   - Backend API: http://your-server:5000" 
          echo "   - Backoffice: http://your-server:3001"
          echo ""
          echo "✅ Features included:"
          echo "   - Automatic disk space management"
          echo "   - Progressive image pulling with cleanup"
          echo "   - Health checks and verification"
          echo "   - Backup management"
          echo "   - Connectivity testing"
          echo ""
          echo "🚀 Deployment should be fully functional!"