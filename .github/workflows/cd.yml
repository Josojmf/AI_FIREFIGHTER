name: CD - Multi Image Deploy (FO/API/BO) - WORKING

on:
  push:
    branches:
      - main
    paths:
      - "FO/**"
      - "API/**"
      - "BO/**"
      - "docker-compose.prod.yml"
      - "Dockerfile"
      - "**.yml"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:

  # -------------------------------------------------------------------
  # 1) BUILD & PUSH ALL DOCKER IMAGES TO GHCR
  # -------------------------------------------------------------------
  build-and-push:
    name: 🏗️ Build & Push All Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Owner lowercase
        id: lc
        run: echo "owner_lc=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USER }}
          password: ${{ secrets.GHCR_PAT }}

      # FRONTEND
      - name: Build + Push FRONTEND
        uses: docker/build-push-action@v6
        with:
          context: ./FO
          file: ./FO/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.lc.outputs.owner_lc }}/ai-firefighter-frontend:latest
            ghcr.io/${{ steps.lc.outputs.owner_lc }}/ai-firefighter-frontend:${{ github.sha }}
          build-args: |
            API_BASE_URL=http://backend:5000/api
          no-cache: true

      # BACKEND
      - name: Build + Push BACKEND
        uses: docker/build-push-action@v6
        with:
          context: ./API
          file: ./API/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.lc.outputs.owner_lc }}/ai-firefighter-backend:latest
            ghcr.io/${{ steps.lc.outputs.owner_lc }}/ai-firefighter-backend:${{ github.sha }}
          no-cache: true

      # BACKOFFICE
      - name: Build + Push BACKOFFICE
        uses: docker/build-push-action@v6
        with:
          context: ./BO
          file: ./BO/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.lc.outputs.owner_lc }}/ai-firefighter-backoffice:latest
            ghcr.io/${{ steps.lc.outputs.owner_lc }}/ai-firefighter-backoffice:${{ github.sha }}
          no-cache: true

  # -------------------------------------------------------------------
  # 2) DEPLOY TO DROPLET
  # -------------------------------------------------------------------
  deploy:
    name: 🚀 Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Create deploy folder
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 300s
          script: |
            set -e
            echo "📁 Ensuring deploy directory..."
            mkdir -p /opt/emergency
            cd /opt/emergency
            echo "✅ Deploy directory ready"

      - name: Upload docker-compose.prod.yml
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          source: "docker-compose.prod.yml"
          target: "/opt/emergency/"

      - name: Install Docker & Compose
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 600s
          script: |
            set -e
            echo "🐳 Checking Docker installation..."
            
            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "📥 Installing Docker..."
              apt-get update -y
              apt-get install -y docker.io
              systemctl enable --now docker
              echo "✅ Docker installed"
            else
              echo "✅ Docker already installed"
            fi

            # Install Docker Compose
            if ! command -v docker-compose &> /dev/null; then
              echo "📥 Installing Docker Compose..."
              apt-get update -y
              apt-get install -y curl
              curl -SL https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
              echo "✅ Docker Compose installed"
            else
              echo "✅ Docker Compose already installed"
            fi

      - name: Login GHCR in server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 180s
          script: |
            set -e
            echo "🔐 Logging into GHCR..."
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.GHCR_USER }}" --password-stdin
            echo "✅ Logged into GHCR"

      - name: Generate environment file
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 120s
          script: |
            set -e
            echo "🔧 Generating environment file..."
            cat << EOF > /root/firefighter.env
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            JWT_EXPIRES_HOURS=${{ secrets.JWT_EXPIRES_HOURS }}
            MONGO_CLUSTER=${{ secrets.MONGO_CLUSTER }}
            MONGO_USER=${{ secrets.MONGO_USER }}
            MONGO_PASS=${{ secrets.MONGO_PASS }}
            DB_CLUSTER=${{ secrets.DB_CLUSTER }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=${{ secrets.DB_NAME }}
            VAPID_PUBLIC_KEY=${{ secrets.VAPID_PUBLIC_KEY }}
            VAPID_PRIVATE_KEY=${{ secrets.VAPID_PRIVATE_KEY }}
            EOF
            chmod 600 /root/firefighter.env
            echo "✅ Environment file created"

      - name: Stop existing containers
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 300s
          script: |
            set -e
            echo "🛑 Stopping existing containers..."
            cd /opt/emergency
            
            # Backup current compose file
            if [ -f docker-compose.prod.yml ]; then
              cp docker-compose.prod.yml docker-compose.prod.yml.backup.$(date +%Y%m%d_%H%M%S)
              echo "✅ Compose file backed up"
            fi
            
            # Stop existing containers
            docker-compose -f docker-compose.prod.yml down --remove-orphans --timeout 30 || true
            echo "✅ Containers stopped"

      - name: Pull latest images
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 1200s
          script: |
            set -e
            echo "📥 Pulling latest images..."
            cd /opt/emergency
            
            # Convert repository owner to lowercase in the script
            REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
            echo "🔍 Repository owner: $REPO_OWNER"
            
            # Pull all images with docker-compose
            echo "🔄 Pulling all images via docker-compose..."
            docker-compose -f docker-compose.prod.yml pull --quiet
            
            # Verify images
            echo "🔍 Verifying images..."
            docker images | grep ai-firefighter
            echo "✅ Images pulled successfully"

      - name: Start services
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 600s
          script: |
            set -e
            echo "🚀 Starting services..."
            cd /opt/emergency
            
            # Start all services
            docker-compose -f docker-compose.prod.yml up -d --remove-orphans
            
            # Wait for services to initialize
            echo "⏳ Waiting for services to start..."
            sleep 30
            
            # Check container status
            echo "📋 Container status:"
            docker-compose -f docker-compose.prod.yml ps
            
            echo "✅ Services started"

      - name: Health checks
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 600s
          script: |
            set -e
            echo "🔍 Running health checks..."
            cd /opt/emergency
            
            # Wait for services to be fully ready
            MAX_RETRIES=20
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Health check attempt $RETRY_COUNT/$MAX_RETRIES"
              
              # Check if containers are running
              RUNNING_CONTAINERS=$(docker-compose ps -q | wc -l)
              echo "Running containers: $RUNNING_CONTAINERS"
              
              if [ "$RUNNING_CONTAINERS" -eq 3 ]; then
                echo "✅ All containers are running!"
                break
              fi
              
              if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "⚠️ Not all containers started, but continuing..."
                echo "📋 Final status:"
                docker-compose ps
                echo "📄 Logs:"
                docker-compose logs --tail=20
                break
              fi
              
              echo "⏱️ Waiting 15 seconds..."
              sleep 15
            done

      - name: Final verification
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 300s
          script: |
            set -e
            echo "🔬 Final verification..."
            cd /opt/emergency
            
            # Final container status
            echo "📊 Final container status:"
            docker-compose ps
            
            # Show which ports are exposed
            echo "🌐 Exposed ports:"
            docker ps --format "table {{.Names}}\t{{.Ports}}"
            
            # Test connectivity
            echo "🔗 Testing connectivity:"
            echo "Backend (port 5000):"
            curl -s -I http://localhost:5000/ || echo "  Backend not responding"
            
            echo "Frontend (port 8000):"
            curl -s -I http://localhost:8000/ || echo "  Frontend not responding"
            
            echo "Backoffice (port 3001):"
            curl -s -I http://localhost:3001/ || echo "  Backoffice not responding"
            
            # Clean up old images
            echo "🧹 Cleaning up old images..."
            docker image prune -f || true
            
            echo "✅ Deployment verification completed"

      - name: Deployment summary
        run: |
          echo "🔥 PRODUCTION DEPLOYMENT COMPLETED!"
          echo "📅 $(date)"
          echo "🔄 Services deployed:"
          echo "   - Frontend: http://your-server:8000"
          echo "   - Backend API: http://your-server:5000" 
          echo "   - Backoffice: http://your-server:3001"
          echo "✅ All services should be running"