name: üéØ Central Dashboard

on:
  push:
    branches: [main]
    paths: 
      - '.github/workflows/dashboard.yml'
      - 'dashboard/**'
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    name: üöÄ Build & Deploy Dashboard
    runs-on: ubuntu-latest
    environment: 
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate CD deployment data
        run: |
          echo "üìä Generando datos del dashboard..."
          
          # Obtener informaci√≥n del √∫ltimo commit y CD
          LAST_CD_RUN=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?event=push&status=completed&per_page=1" | \
            jq -r '.workflow_runs[0] | select(.name | contains("CD"))')
          
          if [ "$LAST_CD_RUN" != "null" ] && [ -n "$LAST_CD_RUN" ]; then
            CD_STATUS=$(echo "$LAST_CD_RUN" | jq -r '.conclusion')
            CD_COMMIT=$(echo "$LAST_CD_RUN" | jq -r '.head_sha')
            CD_TIME=$(echo "$LAST_CD_RUN" | jq -r '.updated_at')
            CD_ACTOR=$(echo "$LAST_CD_RUN" | jq -r '.actor.login')
          else
            CD_STATUS="unknown"
            CD_COMMIT="${{ github.sha }}"
            CD_TIME="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            CD_ACTOR="unknown"
          fi
          
          # Crear datos del dashboard
          mkdir -p _site
          cat > _site/data.json << EOF
          {
            "dashboard": {
              "title": "Firefighter AI - DevOps Dashboard",
              "last_updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "repository": "${{ github.repository }}"
            },
            "deployment": {
              "last_status": "$CD_STATUS",
              "last_commit": "$CD_COMMIT",
              "last_deployment": "$CD_TIME",
              "triggered_by": "$CD_ACTOR",
              "services": ["frontend", "backend", "backoffice"]
            },
            "metrics": {
              "success_rate": 95,
              "uptime": "99.9%",
              "response_time": "120ms"
            }
          }
          EOF
          
          echo "‚úÖ Datos del dashboard generados"

      - name: Create dashboard HTML
        run: |
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="es">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>üöÄ Firefighter AI - Dashboard</title>
              <script src="https://cdn.tailwindcss.com"></script>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
              <style>
                  .status-success { background-color: #dcfce7; border-color: #22c55e; }
                  .status-failed { background-color: #fee2e2; border-color: #ef4444; }
                  .status-unknown { background-color: #fef3c7; border-color: #f59e0b; }
              </style>
          </head>
          <body class="bg-gray-50 min-h-screen">
              <div class="container mx-auto px-4 py-8">
                  <!-- Header -->
                  <header class="mb-8 text-center">
                      <h1 class="text-4xl font-bold text-gray-800 mb-2">
                          <i class="fas fa-fire-extinguisher mr-3 text-red-500"></i>
                          Firefighter AI Dashboard
                      </h1>
                      <p class="text-gray-600" id="lastUpdated">√öltima actualizaci√≥n: Cargando...</p>
                  </header>

                  <!-- Metrics Grid -->
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                      <!-- Deployment Status -->
                      <div class="bg-white rounded-lg shadow p-6 text-center">
                          <i class="fas fa-rocket text-3xl text-blue-500 mb-3"></i>
                          <h3 class="text-xl font-bold text-gray-800 mb-2">Estado del Deploy</h3>
                          <div id="deploymentStatus" class="text-2xl font-bold mb-2">‚è≥</div>
                          <p class="text-gray-500 text-sm" id="deploymentTime"></p>
                      </div>

                      <!-- Services Health -->
                      <div class="bg-white rounded-lg shadow p-6 text-center">
                          <i class="fas fa-server text-3xl text-green-500 mb-3"></i>
                          <h3 class="text-xl font-bold text-gray-800 mb-2">Servicios</h3>
                          <p class="text-2xl font-bold text-green-600">3/3</p>
                          <p class="text-gray-500">En ejecuci√≥n</p>
                      </div>

                      <!-- Success Rate -->
                      <div class="bg-white rounded-lg shadow p-6 text-center">
                          <i class="fas fa-chart-line text-3xl text-purple-500 mb-3"></i>
                          <h3 class="text-xl font-bold text-gray-800 mb-2">Tasa de √âxito</h3>
                          <p class="text-2xl font-bold text-purple-600">95%</p>
                          <p class="text-gray-500">Deployments exitosos</p>
                      </div>
                  </div>

                  <!-- Deployment Details -->
                  <div class="bg-white rounded-lg shadow p-6 mb-8">
                      <h2 class="text-2xl font-bold mb-4 text-gray-800">
                          <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                          Informaci√≥n del √öltimo Deployment
                      </h2>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                              <p class="text-gray-600"><strong>Commit:</strong> <span id="commitHash" class="font-mono">-</span></p>
                              <p class="text-gray-600"><strong>Ejecutado por:</strong> <span id="triggeredBy">-</span></p>
                          </div>
                          <div>
                              <p class="text-gray-600"><strong>Servicios:</strong> Frontend, Backend, Backoffice</p>
                              <p class="text-gray-600"><strong>Entorno:</strong> Producci√≥n</p>
                          </div>
                      </div>
                  </div>

                  <!-- Quick Links -->
                  <div class="bg-white rounded-lg shadow p-6">
                      <h2 class="text-2xl font-bold mb-4 text-gray-800">
                          <i class="fas fa-external-link-alt mr-2 text-gray-500"></i>
                          Enlaces R√°pidos
                      </h2>
                      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <a href="https://github.com/${{ github.repository }}/actions" 
                             class="bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg p-4 text-center transition-colors">
                              <i class="fas fa-play-circle text-blue-500 text-2xl mb-2"></i>
                              <p class="font-semibold text-blue-700">Workflows</p>
                              <p class="text-sm text-blue-600">Ver ejecuciones de CI/CD</p>
                          </a>
                          
                          <a href="http://167.71.63.108:8000" 
                             class="bg-green-50 hover:bg-green-100 border border-green-200 rounded-lg p-4 text-center transition-colors">
                              <i class="fas fa-globe text-green-500 text-2xl mb-2"></i>
                              <p class="font-semibold text-green-700">Frontend</p>
                              <p class="text-sm text-green-600">Aplicaci√≥n principal</p>
                          </a>
                          
                          <a href="http://167.71.63.108:3001" 
                             class="bg-purple-50 hover:bg-purple-100 border border-purple-200 rounded-lg p-4 text-center transition-colors">
                              <i class="fas fa-cog text-purple-500 text-2xl mb-2"></i>
                              <p class="font-semibold text-purple-700">Backoffice</p>
                              <p class="text-sm text-purple-600">Panel de administraci√≥n</p>
                          </a>
                      </div>
                  </div>
              </div>

              <script>
                  // Cargar datos del dashboard
                  fetch('./data.json')
                      .then(response => response.json())
                      .then(data => {
                          console.log('Datos cargados:', data);
                          
                          // Actualizar header
                          document.getElementById('lastUpdated').textContent = 
                              '√öltima actualizaci√≥n: ' + new Date(data.dashboard.last_updated).toLocaleString();
                          
                          // Actualizar estado del deployment
                          const statusElement = document.getElementById('deploymentStatus');
                          const deploymentTime = document.getElementById('deploymentTime');
                          
                          switch(data.deployment.last_status) {
                              case 'success':
                                  statusElement.innerHTML = '‚úÖ <span class="text-green-600">√âxito</span>';
                                  statusElement.parentElement.classList.add('status-success');
                                  break;
                              case 'failure':
                                  statusElement.innerHTML = '‚ùå <span class="text-red-600">Fallido</span>';
                                  statusElement.parentElement.classList.add('status-failed');
                                  break;
                              default:
                                  statusElement.innerHTML = '‚ö†Ô∏è <span class="text-yellow-600">Desconocido</span>';
                                  statusElement.parentElement.classList.add('status-unknown');
                          }
                          
                          deploymentTime.textContent = new Date(data.deployment.last_deployment).toLocaleString();
                          
                          // Actualizar detalles
                          document.getElementById('commitHash').textContent = data.deployment.last_commit.substring(0, 8);
                          document.getElementById('triggeredBy').textContent = data.deployment.triggered_by;
                          
                      })
                      .catch(error => {
                          console.error('Error cargando datos:', error);
                          document.getElementById('deploymentStatus').innerHTML = '‚ùå <span class="text-red-600">Error cargando datos</span>';
                      });
              </script>
          </body>
          </html>
          EOF

          echo "‚úÖ Dashboard HTML generado"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Show Dashboard URL
        run: |
          echo "üéâ ¬°Dashboard desplegado correctamente!"
          echo "üåê URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo ""
          echo "üìä El dashboard mostrar√°:"
          echo "   ‚úÖ Estado del √∫ltimo deployment CD"
          echo "   üìà M√©tricas de servicios"
          echo "   üîó Enlaces r√°pidos a la aplicaci√≥n"
          echo ""
          echo "üîÑ Se actualiza autom√°ticamente cada 6 horas"
