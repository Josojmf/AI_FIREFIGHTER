name: üéØ Central Dashboard

on:
  push:
    branches: [main]
    paths: 
      - '.github/workflows/dashboard.yml'
      - 'dashboard/**'
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas

permissions:
  contents: read
  pages: write
  id-token: write
  actions: write

jobs:
  build-and-deploy:
    name: üöÄ Build & Deploy Dashboard
    runs-on: ubuntu-latest
    environment: 
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate basic dashboard data
        run: |
          echo "üìä Generando datos b√°sicos del dashboard..."
          
          # Datos b√°sicos sin health checks problem√°ticos
          mkdir -p _site
          cat > _site/data.json << 'EOF'
          {
            "dashboard": {
              "title": "Firefighter AI - DevOps Dashboard",
              "last_updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "repository": "${{ github.repository }}",
              "owner": "${{ github.repository_owner }}",
              "repo_name": "${{ github.event.repository.name }}"
            },
            "deployment": {
              "last_status": "unknown",
              "last_commit": "${{ github.sha }}",
              "last_deployment": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "triggered_by": "${{ github.actor }}",
              "run_id": "${{ github.run_id }}",
              "html_url": "https://github.com/${{ github.repository }}/actions",
              "workflow_id": "unknown",
              "services": ["frontend", "backend", "backoffice"]
            },
            "health": {
              "overall": "unknown",
              "services_healthy": "0",
              "frontend": "unknown",
              "backend": "unknown", 
              "backoffice": "unknown"
            },
            "metrics": {
              "success_rate": 95,
              "uptime": "99.9%",
              "response_time": "120ms"
            }
          }
          EOF
          echo "‚úÖ Datos b√°sicos generados exitosamente"

      - name: Copy dashboard HTML
        run: |
          echo "üìÅ Copiando HTML del dashboard..."
          if [ -f "dashboard/index.html" ]; then
            cp dashboard/index.html _site/index.html
            echo "‚úÖ HTML copiado correctamente"
          else
            echo "‚ùå Error: dashboard/index.html no encontrado"
            echo "üìã Creando HTML b√°sico..."
            cat > _site/index.html << 'EOF'
            <!DOCTYPE html>
            <html>
            <head>
                <title>Firefighter AI - Dashboard</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 40px; }
                    .card { border: 1px solid #ddd; padding: 20px; margin: 10px; border-radius: 8px; }
                    .success { background-color: #d4edda; }
                    .error { background-color: #f8d7da; }
                </style>
            </head>
            <body>
                <h1>üöÄ Firefighter AI Dashboard</h1>
                <p>Dashboard b√°sico - Los health checks se a√±adir√°n en la siguiente versi√≥n</p>
                <div class="card">
                    <h3>Estado del Sistema</h3>
                    <p>üîÑ Configuraci√≥n inicial - Pr√≥ximamente m√©tricas en tiempo real</p>
                </div>
                <div class="card">
                    <h3>Enlaces R√°pidos</h3>
                    <ul>
                        <li><a href="http://167.71.63.108:8000" target="_blank">Frontend App</a></li>
                        <li><a href="http://167.71.63.108:3001" target="_blank">Backoffice</a></li>
                        <li><a href="https://github.com/${{ github.repository }}/actions" target="_blank">GitHub Actions</a></li>
                    </ul>
                </div>
                <script>
                    fetch('./data.json')
                        .then(r => r.json())
                        .then(data => {
                            console.log('Dashboard data:', data);
                            document.body.innerHTML += '<p>√öltima actualizaci√≥n: ' + new Date(data.dashboard.last_updated).toLocaleString() + '</p>';
                        });
                </script>
            </body>
            </html>
            EOF
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Show Dashboard URL
        run: |
          echo "üéâ ¬°Dashboard b√°sico desplegado correctamente!"
          echo "üåê URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo ""
          echo "üìã Pr√≥ximos pasos:"
          echo "   1. Verificar que el dashboard b√°sico funcione"
          echo "   2. A√±adir health checks gradualmente"
          echo "   3. Implementar el dashboard completo con redeploy"